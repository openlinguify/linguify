{% load static %}
{% load i18n %}
<!-- Notebook Editor Component -->
<div class="note-content-area">
    <!-- Pas de note sÃ©lectionnÃ©e -->
    <div x-show="!currentNote" class="note-editor empty-state">
        <i class="fas fa-file-alt" style="font-size: 3rem; color: #d1d5db;"></i>
        <h2 style="color: #6b7280; margin-top: 1rem;">{% trans 'Select a note to view' %}</h2>
        <p style="color: #9ca3af;">{% trans 'Choose a note from the sidebar or create a new one' %}</p>
        <button @click="createNewNote()" class="btn-linguify" style="margin-top: 1rem; width: auto; display: inline-block;">
            <i class="fas fa-plus"></i>
            {% trans 'Create New Note' %}
        </button>
    </div>

    <!-- Note sÃ©lectionnÃ©e -->
    <div x-show="currentNote" class="note-editor-modern">
        <!-- Header compact avec titre et actions -->
        <div class="note-header-modern">
            <div class="note-title-section">
                <input x-model="currentNote.title"
                       @blur="updateNote()"
                       type="text"
                       placeholder="{% trans 'Note title' %}"
                       class="note-title-input">
                <div class="note-metadata">
                    <select x-model="currentNote.language" @change="updateNote()" class="language-select">
                        <option value="">{% trans 'Language' %}</option>
                        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                        <option value="en">ğŸ‡¬ğŸ‡§ English</option>
                        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                        <option value="nl">ğŸ‡³ğŸ‡± Nederlands</option>
                    </select>
                </div>
            </div>

            <div class="note-actions">
                <button @click="togglePin(currentNote)" class="action-btn" :class="{'pinned': currentNote.is_pinned}" :title="currentNote.is_pinned ? '{% trans 'Unpin' %}' : '{% trans 'Pin' %}'">
                    <i :class="currentNote.is_pinned ? 'fas fa-thumbtack' : 'far fa-thumbtack'"></i>
                </button>
                <button @click="deleteNote(currentNote.id)" class="action-btn delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>

        <!-- Zone de contenu principal -->
        <div class="note-content-modern">
            <div class="content-wrapper"
                 x-data="{
                    showCommands: false,
                    commandPosition: { x: 0, y: 0 },
                    selectedCommand: 0,
                    commands: [
                        { icon: 'ğŸ“', name: 'Note', text: 'ğŸ“ **Note:** ' },
                        { icon: 'â˜', name: 'TÃ¢che', text: 'â˜ ' },
                        { icon: 'ğŸ’¡', name: 'IdÃ©e', text: 'ğŸ’¡ **IdÃ©e:** ' },
                        { icon: 'â“', name: 'Question', text: 'â“ **Question:** ' },
                        { icon: 'ğŸ”„', name: 'Traduction', text: 'ğŸ”„ **FR:** \\nğŸ”„ **EN:** ' },
                        { icon: 'ğŸ“š', name: 'Vocabulaire', text: 'ğŸ“š **Mot:** dÃ©finition' },
                        { icon: 'â°', name: 'Rappel', text: 'â° **Rappel:** ' }
                    ],

                    handleKeydown(event) {
                        if (event.key === '/') {
                            const textarea = event.target;
                            const cursorPos = textarea.selectionStart;
                            const textBefore = textarea.value.substring(0, cursorPos);

                            if (cursorPos === 0 || textBefore.endsWith('\\n') || textBefore.endsWith(' ')) {
                                setTimeout(() => {
                                    this.showCommandMenu(textarea);
                                }, 10);
                            }
                        }

                        if (this.showCommands) {
                            if (event.key === 'ArrowDown') {
                                event.preventDefault();
                                this.selectedCommand = (this.selectedCommand + 1) % this.commands.length;
                            } else if (event.key === 'ArrowUp') {
                                event.preventDefault();
                                this.selectedCommand = this.selectedCommand === 0 ? this.commands.length - 1 : this.selectedCommand - 1;
                            } else if (event.key === 'Enter') {
                                event.preventDefault();
                                this.insertCommand(textarea);
                            } else if (event.key === 'Escape') {
                                this.hideCommandMenu();
                            }
                        }
                    },

                    showCommandMenu(textarea) {
                        const rect = textarea.getBoundingClientRect();
                        this.commandPosition = {
                            x: rect.left + 20,
                            y: rect.top + 40
                        };
                        this.showCommands = true;
                        this.selectedCommand = 0;
                    },

                    hideCommandMenu() {
                        this.showCommands = false;
                    },

                    insertCommand(textarea) {
                        const command = this.commands[this.selectedCommand];
                        const cursorPos = textarea.selectionStart;
                        const textBefore = textarea.value.substring(0, cursorPos - 1);
                        const textAfter = textarea.value.substring(cursorPos);

                        textarea.value = textBefore + command.text + textAfter;
                        textarea.dispatchEvent(new Event('input'));

                        const newPos = cursorPos - 1 + command.text.length;
                        textarea.setSelectionRange(newPos, newPos);

                        this.hideCommandMenu();
                    },

                    selectCommand(index, textarea) {
                        this.selectedCommand = index;
                        this.insertCommand(textarea);
                    }
                 }"
                 @click.away="hideCommandMenu()">

                <textarea x-model="currentNote.content"
                          @blur="updateNote()"
                          @input="updateNote()"
                          @keydown="handleKeydown($event)"
                          placeholder="{% trans 'Start writing your note...' %} Tapez / pour les commandes..."
                          class="content-textarea"
                          rows="20"></textarea>

                <!-- Commands dropdown -->
                <div x-show="showCommands"
                     x-transition
                     class="commands-dropdown"
                     :style="`position: fixed; left: ${commandPosition.x}px; top: ${commandPosition.y}px; z-index: 1000;`">
                    <div class="commands-menu">
                        <template x-for="(command, index) in commands" :key="index">
                            <div class="command-item"
                                 :class="{ 'selected': index === selectedCommand }"
                                 @click="selectCommand(index, $event.target.closest('[x-data]').querySelector('textarea'))"
                                 @mouseenter="selectedCommand = index">
                                <span class="command-icon" x-text="command.icon"></span>
                                <span class="command-name" x-text="command.name"></span>
                            </div>
                        </template>
                    </div>
                </div>


            </div>
        </div>
    </div>
</div>
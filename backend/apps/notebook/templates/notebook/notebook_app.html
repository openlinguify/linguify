{% extends "saas_web/base.html" %}
{% load static %}

{% block title %}Notebook - Notes{% endblock %}

{% block header_content %}
{% include 'components/header/app_header.html' %}
{% include 'components/notebook_navbar.html' %}
{% endblock %}

{% block extra_css %}
<style>
/* Styles minimalistes pour la visibilité des éléments notebook */
.notes-container {
    padding: 2rem;
}

.notes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.note-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    transition: all 0.2s;
    position: relative;
    cursor: pointer;
}

.note-card:hover {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.note-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.note-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0;
    flex: 1;
}

.note-content {
    color: #64748b;
    font-size: 0.875rem;
    line-height: 1.5;
    margin-bottom: 1rem;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.note-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: #64748b;
}

.note-tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.note-tag {
    background: #f1f5f9;
    color: #475569;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.note-tag.language {
    background: #3b82f6;
    color: white;
}

.note-tag.difficulty {
    background: #10b981;
    color: white;
}

.loading-state,
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #64748b;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: #9ca3af;
}

.empty-state h3 {
    font-size: 1.5rem;
    margin: 1rem 0 0.5rem;
    color: #1e293b;
}

.bulk-actions {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1rem 2rem;
    margin: 1.5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
}

.bulk-buttons {
    display: flex;
    gap: 0.75rem;
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin-top: 2rem;
}

/* Modal styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
}

.modal-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    z-index: 10;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 2rem 1rem;
    border-bottom: 1px solid #e5e7eb;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #1e293b;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.25rem;
    color: #64748b;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
    transition: all 0.2s;
}

.modal-close:hover {
    background: #f1f5f9;
    color: #1e293b;
}

.note-form {
    padding: 1.5rem 2rem 2rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #1e293b;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 1rem;
    background: white;
    color: #1e293b;
    transition: all 0.2s;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 100px;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e7eb;
}

/* Responsive */
@media (max-width: 768px) {
    .notes-container {
        padding: 1rem;
    }

    .notes-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .bulk-actions {
        margin: 1rem;
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
    }

    .form-row {
        grid-template-columns: 1fr;
    }

    .form-actions {
        flex-direction: column-reverse;
    }
}
</style>
{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/htmx.org@1.9.6"></script>
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="notebook-app" x-data="notebookApp()" x-init="init()">
    <!-- Actions en lot (affichées quand des notes sont sélectionnées) -->
    <div class="bulk-actions" x-show="selectedNotes.length > 0" x-transition>
        <div class="bulk-info">
            <span x-text="selectedNotes.length"></span> note(s) sélectionnée(s)
        </div>
        <div class="bulk-buttons">
            <button @click="bulkArchive()" class="btn btn-secondary">
                <i class="fas fa-archive"></i>
                Archiver
            </button>
            <button @click="bulkDelete()" class="btn btn-danger">
                <i class="fas fa-trash"></i>
                Supprimer
            </button>
            <button @click="clearSelection()" class="btn btn-outline">
                Annuler
            </button>
        </div>
    </div>

    <!-- Liste des notes -->
    <div class="notes-container">
        <div class="notes-grid" id="notes-list">
            <!-- Les notes seront chargées ici via HTMX -->
            <div class="loading-state" x-show="isLoading">
                <i class="fas fa-spinner fa-spin"></i>
                Chargement des notes...
            </div>

            <div class="empty-state" x-show="!isLoading && notes.length === 0">
                <i class="fas fa-sticky-note"></i>
                <h3>Aucune note trouvée</h3>
                <p>Commencez par créer votre première note !</p>
                <button @click="showCreateModal = true" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Créer une note
                </button>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination" x-show="totalPages > 1">
            <button
                @click="changePage(currentPage - 1)"
                :disabled="currentPage <= 1"
                class="btn btn-outline"
            >
                <i class="fas fa-chevron-left"></i>
                Précédent
            </button>

            <span class="page-info">
                Page <span x-text="currentPage"></span> sur <span x-text="totalPages"></span>
            </span>

            <button
                @click="changePage(currentPage + 1)"
                :disabled="currentPage >= totalPages"
                class="btn btn-outline"
            >
                Suivant
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Modal de création/édition -->
    <div class="modal" x-show="showCreateModal || showEditModal" x-transition>
        <div class="modal-backdrop" @click="closeModals()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 x-text="showEditModal ? 'Modifier la note' : 'Nouvelle note'"></h3>
                <button @click="closeModals()" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form @submit.prevent="saveNote()" class="note-form">
                <div class="form-group">
                    <label>Titre</label>
                    <input
                        type="text"
                        x-model="currentNote.title"
                        placeholder="Titre de la note"
                        required
                        class="form-input"
                    >
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Langue</label>
                        <select x-model="currentNote.language" class="form-select">
                            <option value="">Sélectionner</option>
                            <option value="fr">Français</option>
                            <option value="en">Anglais</option>
                            <option value="es">Espagnol</option>
                            <option value="de">Allemand</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Difficulté</label>
                        <select x-model="currentNote.difficulty" class="form-select">
                            <option value="">Sélectionner</option>
                            <option value="BEGINNER">Débutant</option>
                            <option value="INTERMEDIATE">Intermédiaire</option>
                            <option value="ADVANCED">Avancé</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Contenu</label>
                    <textarea
                        x-model="currentNote.content"
                        placeholder="Contenu de la note"
                        rows="6"
                        class="form-textarea"
                    ></textarea>
                </div>

                <div class="form-group">
                    <label>Traduction</label>
                    <textarea
                        x-model="currentNote.translation"
                        placeholder="Traduction (optionnel)"
                        rows="3"
                        class="form-textarea"
                    ></textarea>
                </div>

                <div class="form-group">
                    <label>Prononciation</label>
                    <input
                        type="text"
                        x-model="currentNote.pronunciation"
                        placeholder="Guide de prononciation"
                        class="form-input"
                    >
                </div>

                <div class="form-actions">
                    <button type="button" @click="closeModals()" class="btn btn-secondary">
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-primary" :disabled="isSaving">
                        <span x-show="!isSaving">
                            <i class="fas fa-save"></i>
                            <span x-text="showEditModal ? 'Modifier' : 'Créer'"></span>
                        </span>
                        <span x-show="isSaving">
                            <i class="fas fa-spinner fa-spin"></i>
                            Enregistrement...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function notebookApp() {
    return {
        // État général
        isLoading: false,
        isSaving: false,

        // Notes
        notes: [],
        selectedNotes: [],

        // Pagination
        currentPage: 1,
        totalPages: 1,
        totalNotes: 0,

        // Recherche et filtres
        searchQuery: '',
        selectedLanguage: '',
        archiveStatus: 'active',
        sortBy: 'updated_desc',

        // Modals
        showCreateModal: false,
        showEditModal: false,
        currentNote: {
            id: null,
            title: '',
            content: '',
            language: '',
            translation: '',
            pronunciation: '',
            difficulty: '',
            is_pinned: false,
            is_archived: false
        },

        // Méthodes
        init() {
            this.loadNotes();
        },

        async loadNotes() {
            this.isLoading = true;
            try {
                // Map sort values to DRF ordering format
                const sortMapping = {
                    'updated_desc': '-updated_at',
                    'updated_asc': 'updated_at',
                    'title_asc': 'title',
                    'title_desc': '-title'
                };

                const params = new URLSearchParams({
                    page: this.currentPage,
                    search: this.searchQuery,
                    language: this.selectedLanguage,
                    archive_status: this.archiveStatus,
                    ordering: sortMapping[this.sortBy] || '-updated_at'
                });

                const response = await fetch(`/notebook/api/notes/?${params}`, {
                    headers: {
                        'Accept': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    credentials: 'same-origin'
                });

                const data = await response.json();
                this.notes = data.results;
                this.totalPages = Math.ceil(data.count / 50);
                this.totalNotes = data.count;
            } catch (error) {
                console.error('Erreur lors du chargement des notes:', error);
                this.showAlert('Erreur lors du chargement des notes', 'error');
            } finally {
                this.isLoading = false;
            }
        },

        changePage(page) {
            if (page >= 1 && page <= this.totalPages) {
                this.currentPage = page;
                this.loadNotes();
            }
        },

        async saveNote() {
            this.isSaving = true;
            try {
                const url = this.showEditModal ?
                    `/notebook/api/notes/${this.currentNote.id}/` :
                    '/notebook/api/notes/';

                const method = this.showEditModal ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(this.currentNote)
                });

                if (response.ok) {
                    this.closeModals();
                    this.loadNotes();
                    this.showAlert('Note enregistrée avec succès', 'success');
                } else {
                    throw new Error('Erreur lors de l\'enregistrement');
                }
            } catch (error) {
                console.error('Erreur:', error);
                this.showAlert('Erreur lors de l\'enregistrement de la note', 'error');
            } finally {
                this.isSaving = false;
            }
        },

        editNote(note) {
            this.currentNote = { ...note };
            this.showEditModal = true;
        },

        async deleteNote(noteId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette note ?')) {
                return;
            }

            try {
                const response = await fetch(`/notebook/api/notes/${noteId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    this.loadNotes();
                    this.showAlert('Note supprimée', 'success');
                } else {
                    throw new Error('Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('Erreur:', error);
                this.showAlert('Erreur lors de la suppression', 'error');
            }
        },

        async togglePin(note) {
            try {
                const response = await fetch(`/notebook/api/notes/${note.id}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        is_pinned: !note.is_pinned
                    })
                });

                if (response.ok) {
                    this.loadNotes();
                }
            } catch (error) {
                console.error('Erreur:', error);
            }
        },

        toggleSelection(noteId) {
            const index = this.selectedNotes.indexOf(noteId);
            if (index > -1) {
                this.selectedNotes.splice(index, 1);
            } else {
                this.selectedNotes.push(noteId);
            }
        },

        clearSelection() {
            this.selectedNotes = [];
        },

        async bulkArchive() {
            try {
                const response = await fetch('/notebook/api/notes/bulk_update/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        note_ids: this.selectedNotes,
                        updates: { is_archived: true }
                    })
                });

                if (response.ok) {
                    this.clearSelection();
                    this.loadNotes();
                    this.showAlert('Notes archivées', 'success');
                }
            } catch (error) {
                console.error('Erreur:', error);
                this.showAlert('Erreur lors de l\'archivage', 'error');
            }
        },

        async bulkDelete() {
            if (!confirm(`Supprimer ${this.selectedNotes.length} note(s) ?`)) {
                return;
            }

            try {
                const response = await fetch('/notebook/api/notes/bulk_delete/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        note_ids: this.selectedNotes
                    })
                });

                if (response.ok) {
                    this.clearSelection();
                    this.loadNotes();
                    this.showAlert('Notes supprimées', 'success');
                }
            } catch (error) {
                console.error('Erreur:', error);
                this.showAlert('Erreur lors de la suppression', 'error');
            }
        },

        closeModals() {
            this.showCreateModal = false;
            this.showEditModal = false;
            this.currentNote = {
                id: null,
                title: '',
                content: '',
                language: '',
                translation: '',
                pronunciation: '',
                difficulty: '',
                is_pinned: false,
                is_archived: false
            };
        },

        getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        },

        showAlert(message, type) {
            // Implémentation simple d'alert
            // TODO: Remplacer par un système de notification plus sophistiqué
            if (type === 'error') {
                alert('Erreur: ' + message);
            } else {
                alert(message);
            }
        }
    }
}
</script>
{% endblock %}
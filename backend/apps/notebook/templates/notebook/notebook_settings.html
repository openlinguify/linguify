{% load i18n %}
<!-- Notebook Tab -->
<div id="notes" class="tab-content active">

    <!-- Editor Settings Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-pencil-square"></i>
                {% trans "Editor" %}
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <form id="notebook-editor-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="editor">

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="auto_save" checked>
                        {% trans "Auto-save" %}
                    </label>
                    <div class="form-help">{% trans "Automatically save changes while you type" %}</div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="markdown_preview" checked>
                        {% trans "Markdown preview" %}
                    </label>
                    <div class="form-help">{% trans "Show a live preview of markdown formatting" %}</div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="spell_check" checked>
                        {% trans "Spell check" %}
                    </label>
                    <div class="form-help">{% trans "Check spelling as you type" %}</div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="version_history" checked>
                        {% trans "Version history" %}
                    </label>
                    <div class="form-help">{% trans "Keep track of changes to your notes" %}</div>
                </div>

                <div class="form-group">
                    <label class="form-label">{% trans "Auto-save interval (seconds)" %}</label>
                    <div class="range-input">
                        <input type="range" name="auto_save_interval" min="5" max="60" value="10" class="form-range">
                        <span class="range-value">10</span>
                    </div>
                    <div class="form-help">{% trans "Time between auto-saves" %}</div>
                </div>
            </form>
        </div>
    </div>

    <!-- Appearance Settings Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-palette"></i>
                {% trans "Appearance" %}
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <form id="notebook-appearance-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="appearance">

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">{% trans "Font family" %}</label>
                        <select name="font_family" class="form-control">
                            <option value="system">{% trans "System" %}</option>
                            <option value="serif">{% trans "Serif" %}</option>
                            <option value="sans-serif">{% trans "Sans-serif" %}</option>
                            <option value="monospace">{% trans "Monospace" %}</option>
                        </select>
                        <div class="form-help">{% trans "Font style for your notes" %}</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">{% trans "Font size" %}</label>
                        <select name="font_size" class="form-control">
                            <option value="small">{% trans "Small" %}</option>
                            <option value="medium">{% trans "Medium" %}</option>
                            <option value="large">{% trans "Large" %}</option>
                            <option value="extra-large">{% trans "Extra large" %}</option>
                        </select>
                        <div class="form-help">{% trans "Text size in editor" %}</div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Organization Settings Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-folder"></i>
                {% trans "Organization" %}
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <form id="notebook-organization-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="organization">

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="auto_categorize" checked>
                        {% trans "Auto-categorize" %}
                    </label>
                    <div class="form-help">{% trans "Automatically categorize notes by content" %}</div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="show_tags" checked>
                        {% trans "Show tags" %}
                    </label>
                    <div class="form-help">{% trans "Display tags on notes" %}</div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="recent_notes" checked>
                        {% trans "Recent notes" %}
                    </label>
                    <div class="form-help">{% trans "Show recently viewed notes" %}</div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">{% trans "Default view" %}</label>
                        <select name="default_view" class="form-control">
                            <option value="list">{% trans "List" %}</option>
                            <option value="grid">{% trans "Grid" %}</option>
                            <option value="cards">{% trans "Cards" %}</option>
                        </select>
                        <div class="form-help">{% trans "How notes are displayed" %}</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">{% trans "Default sort" %}</label>
                        <select name="default_sort" class="form-control">
                            <option value="created">{% trans "Creation date" %}</option>
                            <option value="modified">{% trans "Last modified" %}</option>
                            <option value="title">{% trans "Title" %}</option>
                            <option value="language">{% trans "Language" %}</option>
                        </select>
                        <div class="form-help">{% trans "Default sorting order" %}</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">{% trans "Notes per page" %}</label>
                    <div class="range-input">
                        <input type="range" name="notes_per_page" min="10" max="100" value="20" step="10" class="form-range">
                        <span class="range-value">20</span>
                    </div>
                    <div class="form-help">{% trans "Number of notes displayed per page" %}</div>
                </div>
            </form>
        </div>
    </div>

    <!-- Sharing Settings Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-share"></i>
                {% trans "Sharing" %}
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <form id="notebook-sharing-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="sharing">

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="allow_sharing">
                        {% trans "Allow sharing" %}
                    </label>
                    <div class="form-help">{% trans "Enable sharing notes with others" %}</div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="public_notes">
                        {% trans "Public notes" %}
                    </label>
                    <div class="form-help">{% trans "Allow notes to be publicly visible" %}</div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="collaborative_editing">
                        {% trans "Collaborative editing" %}
                    </label>
                    <div class="form-help">{% trans "Allow others to edit shared notes" %}</div>
                </div>

                <div class="form-group">
                    <label class="form-label">{% trans "Default permissions" %}</label>
                    <select name="default_permissions" class="form-control">
                        <option value="private">{% trans "Private" %}</option>
                        <option value="view-only">{% trans "View only" %}</option>
                        <option value="edit">{% trans "Can edit" %}</option>
                    </select>
                    <div class="form-help">{% trans "Default permission level for new shares" %}</div>
                </div>
            </form>
        </div>
    </div>

    <!-- Global Save Button for Settings -->
    <div style="margin-top: 30px; padding: 20px; background: var(--linguify-gray-50); border-radius: 8px; text-align: center; border: 1px solid var(--linguify-gray-200);">
        <div style="margin-bottom: 10px; font-size: 14px; color: var(--linguify-gray-500);">
            {% trans "Save all notebook settings" %}
        </div>
        <button type="button" onclick="saveAllNotebookSettings()" class="btn-primary" style="padding: 12px 24px; font-size: 16px; min-width: 200px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); background: var(--linguify-gradient); border: none; color: var(--linguify-white);">
            <i class="bi bi-save"></i>
            {% trans "Save all settings" %}
        </button>
        <div id="save-status" style="margin-top: 10px; font-size: 14px;"></div>
    </div>
</div>

<script>
// Notebook Settings JavaScript
(function() {
    'use strict';

    console.log('[NotebookSettings] Script loaded');

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initNotebookSettingsPage);
    } else {
        initNotebookSettingsPage();
    }

    function initNotebookSettingsPage() {
        if (!document.getElementById('notes')) {
            return;
        }

        console.log('[NotebookSettings] Initializing notebook settings page');

        initRangeSliders();
        initSectionToggles();
        loadNotebookSettings();
    }

    function initRangeSliders() {
        const rangeInputs = document.querySelectorAll('#notes .range-input input[type="range"]');
        rangeInputs.forEach(slider => {
            slider.addEventListener('input', function() {
                updateRangeValue(this);
            });
            updateRangeValue(slider);
        });
    }

    function initSectionToggles() {
        const toggles = document.querySelectorAll('#notes .section-toggle');
        toggles.forEach(toggle => {
            toggle.addEventListener('click', function() {
                const section = this.closest('.content-section');
                const content = section.querySelector('.section-content');
                const icon = this.querySelector('i');

                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    icon.className = 'bi bi-chevron-up';
                } else {
                    content.style.display = 'none';
                    icon.className = 'bi bi-chevron-down';
                }
            });
        });
    }

    function updateRangeValue(slider) {
        const valueSpan = slider.parentElement.querySelector('.range-value');
        if (!valueSpan) return;

        const value = parseInt(slider.value);
        valueSpan.textContent = value;

        const min = parseInt(slider.min) || 0;
        const max = parseInt(slider.max) || 100;
        const percentage = ((value - min) / (max - min)) * 100;
        slider.style.background = `linear-gradient(to right, var(--linguify-primary) 0%, var(--linguify-primary) ${percentage}%, var(--linguify-gray-200) ${percentage}%, var(--linguify-gray-200) 100%)`;
    }

    async function loadNotebookSettings() {
        try {
            const response = await fetch('/notebook/settings/', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success && data.settings) {
                    populateFormFields(data.settings);
                }
            }
        } catch (error) {
            console.error('[NotebookSettings] Error loading settings:', error);
        }
    }

    function populateFormFields(settings) {
        Object.keys(settings).forEach(key => {
            const elements = document.querySelectorAll(`[name="${key}"]`);
            elements.forEach(element => {
                if (element.type === 'checkbox') {
                    element.checked = settings[key];
                } else if (element.type === 'range') {
                    element.value = settings[key];
                    updateRangeValue(element);
                } else {
                    element.value = settings[key];
                }
            });
        });
    }

    function collectFormData() {
        const forms = document.querySelectorAll('#notes form');
        const settings = {};

        forms.forEach(form => {
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(element => {
                const key = element.name;
                if (key && key !== 'setting_type' && key !== 'csrfmiddlewaretoken') {
                    if (element.type === 'checkbox') {
                        settings[key] = element.checked;
                    } else if (element.type === 'range' || element.type === 'number') {
                        settings[key] = parseInt(element.value) || 0;
                    } else {
                        settings[key] = element.value;
                    }
                }
            });
        });

        return settings;
    }

    window.saveAllNotebookSettings = async function() {
        const button = document.querySelector('button[onclick="saveAllNotebookSettings()"]');
        const statusDiv = document.getElementById('save-status');

        button.innerHTML = '<i class="bi bi-hourglass-split"></i> {% trans "Saving..." %}';
        button.disabled = true;
        button.style.background = 'var(--linguify-gray-600)';
        statusDiv.innerHTML = '';

        try {
            const settings = collectFormData();
            console.log('[NotebookSettings] Saving settings:', settings);

            const response = await fetch('/notebook/settings/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(settings)
            });

            if (response.ok) {
                const result = await response.json();
                button.innerHTML = '<i class="bi bi-check-circle"></i> {% trans "Saved!" %}';
                button.style.background = 'var(--linguify-green-500)';
                statusDiv.innerHTML = '<span style="color: var(--linguify-green-500); font-weight: 500;"><i class="bi bi-check-circle"></i> {% trans "Settings saved successfully" %}</span>';

                setTimeout(() => {
                    button.innerHTML = '<i class="bi bi-save"></i> {% trans "Save all settings" %}';
                    button.style.background = '';
                    button.disabled = false;
                }, 2000);
            } else {
                throw new Error('Failed to save');
            }
        } catch (error) {
            console.error('[NotebookSettings] Save error:', error);
            button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> {% trans "Error" %}';
            button.style.background = 'var(--linguify-red-600)';
            statusDiv.innerHTML = '<span style="color: var(--linguify-red-600); font-weight: 500;"><i class="bi bi-exclamation-triangle"></i> {% trans "Error while saving" %}</span>';

            setTimeout(() => {
                button.innerHTML = '<i class="bi bi-save"></i> {% trans "Save all settings" %}';
                button.style.background = '';
                button.disabled = false;
            }, 3000);
        }
    };
})();
</script>
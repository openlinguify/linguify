{% extends 'learning/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Dashboard" %}{% endblock %}

{% block header_content %}
<div class="d-flex gap-2">
    <div class="dropdown">
        <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-filter me-1"></i>
            {% trans "Filter courses" %}
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" data-filter="all">{% trans "All courses" %}</a></li>
            <li><a class="dropdown-item" href="#" data-filter="in_progress">{% trans "In progress" %}</a></li>
            <li><a class="dropdown-item" href="#" data-filter="completed">{% trans "Completed" %}</a></li>
            <li><a class="dropdown-item" href="#" data-filter="not_started">{% trans "Not started" %}</a></li>
        </ul>
    </div>
    
    <button class="btn btn-light" id="browseCoursesBtn">
        <i class="bi bi-plus-circle me-1"></i>
        {% trans "Browse courses" %}
    </button>
</div>
{% endblock %}

{% block main_content %}
<div class="container-fluid">
    <!-- Learning Progress Overview -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 col-6">
                            <div class="stat-card">
                                <div class="stat-value" id="totalCourses">{{ total_courses|default:0 }}</div>
                                <div class="stat-label">{% trans "Total Courses" %}</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stat-card">
                                <div class="stat-value text-success" id="completedCourses">{{ completed_courses|default:0 }}</div>
                                <div class="stat-label">{% trans "Completed" %}</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stat-card">
                                <div class="stat-value text-warning" id="inProgressCourses">{{ in_progress_courses|default:0 }}</div>
                                <div class="stat-label">{% trans "In Progress" %}</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stat-card">
                                <div class="stat-value text-info" id="studyStreak">-</div>
                                <div class="stat-label">{% trans "Study Streak" %}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small text-muted">{% trans "Overall Progress" %}</span>
                            <span class="small text-muted" id="overallProgressPercentage">0%</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-success" role="progressbar" id="overallProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Continue Learning Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>
                    <i class="bi bi-play-circle me-2"></i>
                    {% trans "Continue Learning" %}
                </h4>
                <a href="#" class="text-decoration-none" id="viewAllCoursesLink">
                    {% trans "View all" %} <i class="bi bi-arrow-right"></i>
                </a>
            </div>
            
            <div class="row" id="continueCoursesContainer">
                <!-- Loading state -->
                <div class="col-12 text-center py-4">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-2">{% trans "Loading your courses..." %}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Learning Modes -->
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="mb-3">
                <i class="bi bi-collection me-2"></i>
                {% trans "Learning Modes" %}
            </h4>
        </div>
    </div>
    
    <div class="row">
        <!-- Interactive Lessons -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="learning-mode-card">
                <div class="learning-mode-icon">📚</div>
                <h5 class="learning-mode-title">{% trans "Interactive Lessons" %}</h5>
                <p class="learning-mode-description">
                    {% trans "Learn through structured lessons with videos, exercises, and quizzes." %}
                </p>
                <div class="mt-auto">
                    <div class="d-flex justify-content-between text-small text-muted mb-2">
                        <span>{% trans "Best for:" %}</span>
                        <span>{% trans "Structured learning" %}</span>
                    </div>
                    <button class="btn btn-gradient w-100" onclick="startLearningMode('lessons')">
                        {% trans "Start Learning" %}
                    </button>
                </div>
            </div>
        </div>

        <!-- Practice Exercises -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="learning-mode-card">
                <div class="learning-mode-icon">🎯</div>
                <h5 class="learning-mode-title">{% trans "Practice Exercises" %}</h5>
                <p class="learning-mode-description">
                    {% trans "Reinforce your knowledge with targeted exercises and immediate feedback." %}
                </p>
                <div class="mt-auto">
                    <div class="d-flex justify-content-between text-small text-muted mb-2">
                        <span>{% trans "Best for:" %}</span>
                        <span>{% trans "Skill building" %}</span>
                    </div>
                    <button class="btn btn-gradient w-100" onclick="startLearningMode('practice')">
                        {% trans "Start Practice" %}
                    </button>
                </div>
            </div>
        </div>

        <!-- Adaptive Learning -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="learning-mode-card">
                <div class="learning-mode-icon">🧠</div>
                <h5 class="learning-mode-title">{% trans "Adaptive Learning" %}</h5>
                <p class="learning-mode-description">
                    {% trans "AI-powered learning that adapts to your pace and learning style." %}
                </p>
                <div class="mt-auto">
                    <div class="d-flex justify-content-between text-small text-muted mb-2">
                        <span>{% trans "Best for:" %}</span>
                        <span>{% trans "Personalized study" %}</span>
                    </div>
                    <button class="btn btn-gradient w-100" onclick="startLearningMode('adaptive')">
                        {% trans "Start Adaptive" %}
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Review -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="learning-mode-card">
                <div class="learning-mode-icon">⚡</div>
                <h5 class="learning-mode-title">{% trans "Quick Review" %}</h5>
                <p class="learning-mode-description">
                    {% trans "Fast-paced review sessions to reinforce what you've learned." %}
                </p>
                <div class="mt-auto">
                    <div class="d-flex justify-content-between text-small text-muted mb-2">
                        <span>{% trans "Best for:" %}</span>
                        <span>{% trans "Quick refresh" %}</span>
                    </div>
                    <button class="btn btn-gradient w-100" onclick="startLearningMode('review')">
                        {% trans "Quick Review" %}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>
                    <i class="bi bi-clock-history me-2"></i>
                    {% trans "Recent Activity" %}
                </h4>
                <a href="#" class="btn btn-outline-primary btn-sm" id="viewAnalyticsBtn">
                    {% trans "View Analytics" %}
                </a>
            </div>
            
            <div class="row" id="recentActivityContainer">
                <!-- Recent activity will be loaded dynamically -->
                <div class="col-12 text-center py-4">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-2">{% trans "Loading recent activity..." %}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Course Recommendations -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>
                    <i class="bi bi-lightbulb me-2"></i>
                    {% trans "Recommended for You" %}
                </h4>
                <a href="#" class="btn btn-outline-primary btn-sm" id="browseAllBtn">
                    {% trans "Browse All Courses" %}
                </a>
            </div>
            
            <div class="row" id="recommendationsContainer">
                <!-- Recommendations will be loaded dynamically -->
                <div class="col-12 text-center py-4">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-2">{% trans "Loading recommendations..." %}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set demo data for now
    document.getElementById('studyStreak').textContent = '0 {% trans "days" %}';
    document.getElementById('overallProgressPercentage').textContent = '0%';
    document.getElementById('overallProgressBar').style.width = '0%';
    
    // Try to load data but don't fail if APIs don't exist
    loadDashboardData();
    loadContinueCourses();
    loadRecentActivity();
    loadRecommendations();
});

function loadDashboardData() {
    fetch('/student-dashboard/api/dashboard/')
        .then(response => {
            if (!response.ok) throw new Error('API not available');
            return response.json();
        })
        .then(data => {
            // Update statistics
            if (data.study_streak !== undefined) {
                document.getElementById('studyStreak').textContent = data.study_streak + ' {% trans "days" %}';
            }
            
            if (data.overall_progress !== undefined) {
                const percentage = Math.round(data.overall_progress);
                document.getElementById('overallProgressPercentage').textContent = percentage + '%';
                document.getElementById('overallProgressBar').style.width = percentage + '%';
            }
        })
        .catch(error => {
            console.warn('Dashboard API not available, using demo data:', error);
        });
}

function loadContinueCourses() {
    fetch('/student-dashboard/api/courses/?status=in_progress&limit=4')
        .then(response => {
            if (!response.ok) throw new Error('API not available');
            return response.json();
        })
        .then(data => {
            const container = document.getElementById('continueCoursesContainer');
            container.innerHTML = '';
            
            if (data.results && data.results.length > 0) {
                data.results.forEach(course => {
                    container.innerHTML += createCourseCard(course);
                });
            } else {
                container.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <i class="bi bi-book display-1 text-muted"></i>
                        <p class="text-muted mt-2">{% trans "No courses in progress." %}</p>
                        <button class="btn btn-primary" onclick="browseCourses()">{% trans "Explore Courses" %}</button>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.warn('Courses API not available:', error);
            document.getElementById('continueCoursesContainer').innerHTML = `
                <div class="col-12 text-center py-4">
                    <i class="bi bi-book display-1 text-muted"></i>
                    <p class="text-muted mt-2">{% trans "No courses available - Demo mode" %}</p>
                    <button class="btn btn-primary" onclick="browseCourses()">{% trans "Explore Courses" %}</button>
                </div>
            `;
        });
}

function loadRecentActivity() {
    fetch('/student-dashboard/api/analytics/?days=7')
        .then(response => {
            if (!response.ok) throw new Error('API not available');
            return response.json();
        })
        .then(data => {
            const container = document.getElementById('recentActivityContainer');
            container.innerHTML = '';
            
            if (data.results && data.results.length > 0) {
                data.results.slice(0, 3).forEach(activity => {
                    container.innerHTML += createActivityCard(activity);
                });
            } else {
                container.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <p class="text-muted">{% trans "No recent activity found." %}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.warn('Analytics API not available:', error);
            document.getElementById('recentActivityContainer').innerHTML = `
                <div class="col-12 text-center py-4">
                    <p class="text-muted">{% trans "No recent activity - Demo mode" %}</p>
                </div>
            `;
        });
}

function loadRecommendations() {
    fetch('/student-dashboard/api/recommendations/')
        .then(response => {
            if (!response.ok) throw new Error('API not available');
            return response.json();
        })
        .then(data => {
            const container = document.getElementById('recommendationsContainer');
            container.innerHTML = '';
            
            if (data.recommendations && data.recommendations.length > 0) {
                data.recommendations.slice(0, 4).forEach(course => {
                    container.innerHTML += createRecommendationCard(course);
                });
            } else {
                container.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <p class="text-muted">{% trans "No recommendations available." %}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.warn('Recommendations API not available:', error);
            document.getElementById('recommendationsContainer').innerHTML = `
                <div class="col-12 text-center py-4">
                    <p class="text-muted">{% trans "No recommendations - Demo mode" %}</p>
                </div>
            `;
        });
}

function createCourseCard(course) {
    const progressClass = window.learningUtils.getProgressColor(course.progress_percentage);
    
    return `
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="course-card card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title">${course.unit.title}</h6>
                        <div class="progress-circle ${progressClass}">
                            ${course.progress_percentage}%
                        </div>
                    </div>
                    <p class="card-text small text-muted">${course.teacher_name}</p>
                    <div class="progress mb-2" style="height: 4px;">
                        <div class="progress-bar" style="width: ${course.progress_percentage}%"></div>
                    </div>
                    <div class="d-flex justify-content-between text-small text-muted mb-2">
                        <span>${window.learningUtils.formatDuration(course.time_spent_minutes)}</span>
                        <span>{% trans "studied" %}</span>
                    </div>
                    <button class="btn btn-primary btn-sm w-100" onclick="continueCourse(${course.id})">
                        {% trans "Continue" %}
                    </button>
                </div>
            </div>
        </div>
    `;
}

function createActivityCard(activity) {
    return `
        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${activity.date}</h6>
                            <p class="small text-muted mb-1">${activity.lessons_completed} {% trans "lessons completed" %}</p>
                            <p class="small text-muted">${window.learningUtils.formatDuration(activity.total_time_minutes)} {% trans "studied" %}</p>
                        </div>
                        <div class="text-end">
                            <div class="h5 mb-0 text-success">${activity.average_score}%</div>
                            <small class="text-muted">{% trans "avg score" %}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function createRecommendationCard(course) {
    return `
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="course-card card h-100">
                <div class="card-body">
                    <h6 class="card-title">${course.title}</h6>
                    <p class="card-text small text-muted">${course.teacher_name}</p>
                    <div class="mb-2">
                        <span class="difficulty-badge difficulty-${course.difficulty_level}">
                            ${course.difficulty_display}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between text-small text-muted mb-2">
                        <span>⭐ ${course.average_rating || 'N/A'}</span>
                        <span>${course.total_lessons} {% trans "lessons" %}</span>
                    </div>
                    <button class="btn btn-outline-primary btn-sm w-100" onclick="viewCourse(${course.id})">
                        {% trans "View Course" %}
                    </button>
                </div>
            </div>
        </div>
    `;
}

function startLearningMode(mode) {
    // Check if user has any active courses
    fetch('/student-dashboard/api/courses/?status=active&limit=1')
        .then(response => response.json())
        .then(data => {
            if (data.results && data.results.length > 0) {
                // Redirect to the learning mode
                window.location.href = `/learning/${mode}/`;
            } else {
                window.learningUtils.showNotification('{% trans "Please enroll in a course first." %}', 'warning');
                browseCourses();
            }
        })
        .catch(error => {
            console.error('Error checking courses:', error);
            window.learningUtils.showNotification('{% trans "Error starting learning mode." %}', 'error');
        });
}

function continueCourse(courseId) {
    window.location.href = `/learning/course/${courseId}/`;
}

function viewCourse(courseId) {
    window.location.href = `/learning/course/${courseId}/preview/`;
}

function browseCourses() {
    window.location.href = '/learning/browse/';
}

// Event listeners
document.getElementById('browseCoursesBtn').addEventListener('click', browseCourses);
document.getElementById('viewAnalyticsBtn').addEventListener('click', function() {
    window.location.href = '/learning/analytics/';
});
document.getElementById('browseAllBtn').addEventListener('click', browseCourses);

// Filter functionality
document.querySelectorAll('[data-filter]').forEach(filter => {
    filter.addEventListener('click', function(e) {
        e.preventDefault();
        const filterValue = this.dataset.filter;
        // Implement filtering logic here
        console.log('Filter by:', filterValue);
    });
});
</script>
{% endblock %}
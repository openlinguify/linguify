{% extends 'documents/base.html' %}
{% load static %}
{% load i18n %}

{% block document_content %}
<div class="documents-dashboard">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <h1>
                <i class="bi bi-file-earmark-plus"></i>
                {% if object %}
                    Modifier le document
                {% else %}
                    Cr√©er un nouveau document
                {% endif %}
            </h1>
            <p class="subtitle">
                {% if object %}
                    Modifiez les informations de votre document
                {% else %}
                    Remplissez les informations pour cr√©er votre document
                {% endif %}
            </p>
        </div>
        
        <div class="header-actions">
            <a href="{% url 'documents:document_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i>
                Retour aux documents
            </a>
        </div>
    </div>
    
    <!-- Form -->
    <div class="form-content">
        <form method="post" class="document-form" id="document-form">
            {% csrf_token %}
            
            {% if form.errors %}
            <div class="alert alert-danger">
                <h6><i class="bi bi-exclamation-circle"></i> Erreurs dans le formulaire :</h6>
                <ul class="mb-0">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                            <li>
                                {% if field != '__all__' %}
                                    <strong>{{ field }}:</strong>
                                {% endif %}
                                {{ error }}
                            </li>
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <div class="row">
                <div class="col-lg-8">
                    <!-- Main Content -->
                    <div class="form-section">
                        <h3><i class="bi bi-file-text"></i> Contenu du document</h3>
                        
                        <div class="mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label required">
                                <i class="bi bi-type"></i> {{ form.title.label }}
                            </label>
                            <input type="text" class="form-control" name="{{ form.title.name }}" id="{{ form.title.id_for_label }}" 
                                   value="{{ form.title.value|default:'' }}" placeholder="Titre de votre document" maxlength="255" required>
                            {% if form.title.help_text %}
                            <div class="form-text">{{ form.title.help_text }}</div>
                            {% endif %}
                            {% if form.title.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.title.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.content_type.id_for_label }}" class="form-label">
                                <i class="bi bi-filetype-md"></i> {{ form.content_type.label }}
                            </label>
                            <select class="form-select" name="{{ form.content_type.name }}" id="{{ form.content_type.id_for_label }}">
                                <option value="markdown" {% if form.content_type.value == 'markdown' %}selected{% endif %}>üìù Markdown</option>
                                <option value="html" {% if form.content_type.value == 'html' %}selected{% endif %}>üåê HTML</option>
                                <option value="plaintext" {% if form.content_type.value == 'plaintext' %}selected{% endif %}>üìÑ Texte simple</option>
                            </select>
                            {% if form.content_type.help_text %}
                            <div class="form-text">{{ form.content_type.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.content.id_for_label }}" class="form-label">
                                <i class="bi bi-file-earmark-text"></i> {{ form.content.label }}
                            </label>
                            
                            <!-- Content Editor Tabs -->
                            <div class="editor-tabs">
                                <ul class="nav nav-tabs" id="editor-tabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="editor-tab" data-bs-toggle="tab" 
                                                data-bs-target="#editor-pane" type="button" role="tab">
                                            <i class="bi bi-pencil"></i> √âdition
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="preview-tab" data-bs-toggle="tab" 
                                                data-bs-target="#preview-pane" type="button" role="tab">
                                            <i class="bi bi-eye"></i> Aper√ßu
                                        </button>
                                    </li>
                                </ul>
                                
                                <div class="tab-content" id="editor-tab-content">
                                    <div class="tab-pane fade show active" id="editor-pane" role="tabpanel">
                                        <textarea class="form-control" name="{{ form.content.name }}" id="{{ form.content.id_for_label }}" 
                                                  rows="15" placeholder="Contenu de votre document...">{{ form.content.value|default:'' }}</textarea>
                                    </div>
                                    <div class="tab-pane fade" id="preview-pane" role="tabpanel">
                                        <div id="content-preview" class="preview-content">
                                            <p class="text-muted">L'aper√ßu appara√Ætra ici...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {% if form.content.help_text %}
                            <div class="form-text">{{ form.content.help_text }}</div>
                            {% endif %}
                            {% if form.content.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.content.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <!-- Metadata Sidebar -->
                    <div class="form-section">
                        <h3><i class="bi bi-gear"></i> Param√®tres</h3>
                        
                        <div class="mb-3">
                            <label for="{{ form.folder.id_for_label }}" class="form-label">
                                <i class="bi bi-folder"></i> {{ form.folder.label }}
                            </label>
                            <select class="form-select" name="{{ form.folder.name }}" id="{{ form.folder.id_for_label }}">
                                <option value="">üìÅ Aucun dossier</option>
                                {% for folder in form.folder.field.queryset %}
                                <option value="{{ folder.pk }}" {% if form.folder.value == folder.pk %}selected{% endif %}>
                                    üìÇ {{ folder.name }}
                                </option>
                                {% endfor %}
                            </select>
                            {% if form.folder.help_text %}
                            <div class="form-text">{{ form.folder.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.visibility.id_for_label }}" class="form-label">
                                <i class="bi bi-eye"></i> {{ form.visibility.label }}
                            </label>
                            <select class="form-select" name="{{ form.visibility.name }}" id="{{ form.visibility.id_for_label }}">
                                <option value="private" {% if form.visibility.value == 'private' %}selected{% endif %}>üîí Priv√©</option>
                                <option value="shared" {% if form.visibility.value == 'shared' %}selected{% endif %}>üë• Partag√©</option>
                                <option value="public" {% if form.visibility.value == 'public' %}selected{% endif %}>üåê Public</option>
                            </select>
                            {% if form.visibility.help_text %}
                            <div class="form-text">{{ form.visibility.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.language.id_for_label }}" class="form-label">
                                <i class="bi bi-translate"></i> {{ form.language.label }}
                            </label>
                            <input type="text" class="form-control" name="{{ form.language.name }}" id="{{ form.language.id_for_label }}" 
                                   value="{{ form.language.value|default:'' }}" placeholder="ex: fr, en, es..." maxlength="10">
                            {% if form.language.help_text %}
                            <div class="form-text">{{ form.language.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.difficulty_level.id_for_label }}" class="form-label">
                                <i class="bi bi-bar-chart"></i> {{ form.difficulty_level.label }}
                            </label>
                            <select class="form-select" name="{{ form.difficulty_level.name }}" id="{{ form.difficulty_level.id_for_label }}">
                                <option value="">üìä Choisir un niveau</option>
                                <option value="A1" {% if form.difficulty_level.value == 'A1' %}selected{% endif %}>üü¢ A1 - D√©butant</option>
                                <option value="A2" {% if form.difficulty_level.value == 'A2' %}selected{% endif %}>üü° A2 - √âl√©mentaire</option>
                                <option value="B1" {% if form.difficulty_level.value == 'B1' %}selected{% endif %}>üü† B1 - Interm√©diaire</option>
                                <option value="B2" {% if form.difficulty_level.value == 'B2' %}selected{% endif %}>üî¥ B2 - Interm√©diaire sup√©rieur</option>
                                <option value="C1" {% if form.difficulty_level.value == 'C1' %}selected{% endif %}>üü£ C1 - Avanc√©</option>
                                <option value="C2" {% if form.difficulty_level.value == 'C2' %}selected{% endif %}>‚ö´ C2 - Ma√Ætrise</option>
                            </select>
                            {% if form.difficulty_level.help_text %}
                            <div class="form-text">{{ form.difficulty_level.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.tags.id_for_label }}" class="form-label">
                                <i class="bi bi-tags"></i> {{ form.tags.label }}
                            </label>
                            <input type="text" class="form-control" name="{{ form.tags.name }}" id="{{ form.tags.id_for_label }}" 
                                   value="{{ form.tags.value|default:'' }}" placeholder="S√©parez les tags par des virgules" maxlength="500">
                            {% if form.tags.help_text %}
                            <div class="form-text">{{ form.tags.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="form-section">
                        <h3><i class="bi bi-lightning"></i> Actions rapides</h3>
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-primary" id="save-draft">
                                <i class="bi bi-cloud-arrow-up"></i>
                                Sauvegarder comme brouillon
                            </button>
                            
                            {% if object %}
                            <a href="{% url 'documents:document_editor' object.pk %}" class="btn btn-outline-secondary">
                                <i class="bi bi-pencil-square"></i>
                                √âditeur avanc√©
                            </a>
                            {% endif %}
                            
                            <button type="button" class="btn btn-outline-info" onclick="autoSave()">
                                <i class="bi bi-arrow-clockwise"></i>
                                Sauvegarde automatique
                            </button>
                        </div>
                    </div>
                    
                    <!-- Templates (if creating new document) -->
                    {% if not object %}
                    <div class="form-section">
                        <h3><i class="bi bi-file-earmark-medical"></i> Mod√®les</h3>
                        
                        <div class="template-list">
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-secondary" onclick="loadTemplate('lesson')">
                                    <i class="bi bi-book"></i>
                                    Cours/Le√ßon
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="loadTemplate('essay')">
                                    <i class="bi bi-file-text"></i>
                                    Essai/Article
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="loadTemplate('notes')">
                                    <i class="bi bi-journal"></i>
                                    Notes de cours
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="loadTemplate('blank')">
                                    <i class="bi bi-file-earmark"></i>
                                    Document vide
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="form-actions">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="form-info">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            {% if object %}
                                Derni√®re modification : {{ object.updated_at|timesince }} ago
                            {% else %}
                                Tous les champs marqu√©s d'un * sont obligatoires
                            {% endif %}
                        </small>
                    </div>
                    
                    <div class="action-buttons">
                        <a href="{% url 'documents:document_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-lg"></i>
                            Annuler
                        </a>
                        
                        <button type="submit" class="btn btn-primary" id="submit-form">
                            <i class="bi bi-check-lg"></i>
                            {% if object %}
                                Mettre √† jour
                            {% else %}
                                Cr√©er le document
                            {% endif %}
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
/* Form specific styles */
.form-content {
    background: #fff;
}

.form-section {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid #dee2e6;
}

.form-section h3 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: #495057;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-label.required::after {
    content: " *";
    color: #dc3545;
}

.form-label {
    font-weight: 600;
    color: #495057;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus, .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.editor-tabs .nav-tabs {
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 0;
}

.editor-tabs .tab-content {
    border: 1px solid #dee2e6;
    border-top: none;
    border-radius: 0 0 0.375rem 0.375rem;
}

.editor-tabs .tab-pane {
    padding: 1rem;
    min-height: 300px;
}

#id_content {
    min-height: 300px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
    line-height: 1.5;
    border: none;
    border-radius: 0;
    resize: vertical;
}

#id_content:focus {
    box-shadow: none;
    border: none;
}

.preview-content {
    min-height: 268px;
    background: #fff;
    padding: 1rem;
    border-radius: 0.25rem;
    border: 1px solid #e9ecef;
}

.template-list .btn {
    text-align: left;
    justify-content: flex-start;
    gap: 0.5rem;
}

.form-actions {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #dee2e6;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.invalid-feedback {
    display: block !important;
}

@media (max-width: 768px) {
    .document-form-container {
        padding: 1rem;
    }
    
    .form-actions .d-flex {
        flex-direction: column;
        gap: 1rem;
    }
    
    .action-buttons {
        width: 100%;
        justify-content: stretch;
    }
    
    .action-buttons .btn {
        flex: 1;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Preview functionality
    const contentField = document.getElementById('id_content');
    const previewDiv = document.getElementById('content-preview');
    
    function updatePreview() {
        const content = contentField.value;
        const contentType = document.getElementById('id_content_type').value;
        
        if (!content.trim()) {
            previewDiv.innerHTML = '<p class="text-muted">L\'aper√ßu appara√Ætra ici...</p>';
            return;
        }
        
        if (contentType === 'markdown') {
            // Simple markdown to HTML conversion
            let html = content
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                .replace(/`(.*?)`/gim, '<code>$1</code>')
                .replace(/\n\n/gim, '</p><p>')
                .replace(/\n/gim, '<br>');
            
            previewDiv.innerHTML = '<p>' + html + '</p>';
        } else if (contentType === 'html') {
            previewDiv.innerHTML = content;
        } else {
            previewDiv.innerHTML = '<pre>' + content + '</pre>';
        }
    }
    
    // Update preview on content change
    contentField.addEventListener('input', updatePreview);
    document.getElementById('id_content_type').addEventListener('change', updatePreview);
    
    // Initial preview
    updatePreview();
    
    // Save draft functionality
    document.getElementById('save-draft').addEventListener('click', function() {
        const formData = new FormData(document.getElementById('document-form'));
        formData.set('save_as_draft', 'true');
        
        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (response.ok) {
                alert('Brouillon sauvegard√© avec succ√®s !');
            } else {
                alert('Erreur lors de la sauvegarde du brouillon');
            }
        })
        .catch(error => {
            console.error('Save draft error:', error);
            alert('Erreur lors de la sauvegarde du brouillon');
        });
    });
});

// Template loading functions
function loadTemplate(templateType) {
    const contentField = document.getElementById('id_content');
    const titleField = document.getElementById('id_title');
    
    const templates = {
        lesson: {
            title: 'Nouvelle le√ßon',
            content: `# Titre de la le√ßon

## Objectifs d'apprentissage
- Objectif 1
- Objectif 2
- Objectif 3

## Introduction
Br√®ve introduction au sujet...

## Contenu principal

### Section 1
Contenu de la section...

### Section 2
Contenu de la section...

## Exercices pratiques
1. Exercice 1
2. Exercice 2

## R√©sum√©
Points cl√©s √† retenir...

## Ressources suppl√©mentaires
- Lien 1
- Lien 2`
        },
        essay: {
            title: 'Nouvel essai',
            content: `# Titre de l'essai

## Introduction
Pr√©sentation du sujet et de la probl√©matique...

## D√©veloppement

### Argument 1
D√©veloppement du premier argument...

### Argument 2
D√©veloppement du deuxi√®me argument...

### Argument 3
D√©veloppement du troisi√®me argument...

## Conclusion
Synth√®se et ouverture...

## Sources
- Source 1
- Source 2`
        },
        notes: {
            title: 'Notes de cours',
            content: `# Notes de cours - [Date]

## Sujet du cours
[Titre du cours ou du chapitre]

## Points cl√©s
- Point important 1
- Point important 2
- Point important 3

## D√©finitions
**Terme 1**: D√©finition...
**Terme 2**: D√©finition...

## Exemples
1. Exemple pratique 1
2. Exemple pratique 2

## Questions/R√©flexions
- Question 1
- Question 2

## √Ä retenir
Points essentiels √† m√©moriser...`
        },
        blank: {
            title: 'Nouveau document',
            content: ''
        }
    };
    
    if (templates[templateType]) {
        if (confirm('Charger ce mod√®le ? Le contenu actuel sera remplac√©.')) {
            titleField.value = templates[templateType].title;
            contentField.value = templates[templateType].content;
            
            // Update preview
            const event = new Event('input');
            contentField.dispatchEvent(event);
        }
    }
}

// Auto-save functionality
function autoSave() {
    const formData = new FormData(document.getElementById('document-form'));
    formData.set('auto_save', 'true');
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (response.ok) {
            // Visual feedback for auto-save
            const button = document.querySelector('[onclick="autoSave()"]');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check-circle text-success"></i> Sauvegard√©';
            button.disabled = true;
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.disabled = false;
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Auto-save error:', error);
    });
}

// Set up auto-save every 2 minutes
let autoSaveInterval;
document.addEventListener('DOMContentLoaded', function() {
    // Only enable auto-save if editing existing document
    if (document.querySelector('#id_title').value) {
        autoSaveInterval = setInterval(autoSave, 120000); // 2 minutes
    }
});
</script>
{% endblock %}
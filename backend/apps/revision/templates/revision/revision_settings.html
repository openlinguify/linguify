<!-- Revision Tab -->
<div id="revision" class="tab-content active">
    <!-- Statistics Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-bar-chart"></i>
                Statistiques de r√©vision
            </h3>
            <div class="section-actions">
                <button type="button" onclick="loadRevisionStats()" style="margin-right: 8px; padding: 4px 8px; font-size: 12px; background: #007bff; color: white; border: none; border-radius: 4px;">
                    üîÑ Actualiser
                </button>
                <button type="button" onclick="testStatsAPI()" style="margin-right: 8px; padding: 4px 8px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px;">
                    üß™ Test
                </button>
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                <div class="stat-card">
                    <div class="stat-value" id="total-cards">0</div>
                    <div class="stat-label">Cartes totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="cards-learned">0</div>
                    <div class="stat-label">Cartes apprises</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="daily-streak">0</div>
                    <div class="stat-label">S√©rie quotidienne</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="success-rate">0%</div>
                    <div class="stat-label">Taux de r√©ussite</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Word Statistics Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-translate"></i>
                Statistiques des mots
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="word_stats">
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="show_word_stats" {% if revision_settings.show_word_stats %}checked{% endif %}>
                        Afficher les statistiques de mots
                    </label>
                    <div class="form-help">Voir vos mots connus et √† apprendre</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Mode d'affichage des statistiques</label>
                    <select name="stats_display_mode" class="form-control">
                        <option value="detailed" {% if revision_settings.stats_display_mode == 'detailed' %}selected{% endif %}>D√©taill√©</option>
                        <option value="simple" {% if revision_settings.stats_display_mode == 'simple' %}selected{% endif %}>Simple</option>
                        <option value="compact" {% if revision_settings.stats_display_mode == 'compact' %}selected{% endif %}>Compact</option>
                    </select>
                    <div class="form-help">Niveau de d√©tail des statistiques affich√©es</div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="hide_learned_words" {% if revision_settings.hide_learned_words %}checked{% endif %}>
                        Masquer les mots appris
                    </label>
                    <div class="form-help">Ne montrer que les mots encore √† apprendre</div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="group_by_deck" {% if revision_settings.group_by_deck %}checked{% endif %}>
                        Grouper par deck
                    </label>
                    <div class="form-help">Organiser les statistiques par deck</div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn-primary">
                        <i class="bi bi-save"></i>
                        Enregistrer
                    </button>
                </div>
            </form>

            <!-- Word Stats Display -->
            <div class="word-stats-display" id="word-stats-container" style="margin-top: 24px;">
                <div class="stats-tabs">
                    <button class="stats-tab active" data-tab="known">Mots connus</button>
                    <button class="stats-tab" data-tab="to-learn">√Ä apprendre</button>
                    <button class="stats-tab" data-tab="summary">R√©sum√©</button>
                </div>
                
                <div class="stats-content">
                    <div id="known-words" class="tab-pane active">
                        <div class="loading-spinner">Chargement des mots connus...</div>
                    </div>
                    <div id="to-learn-words" class="tab-pane">
                        <div class="loading-spinner">Chargement des mots √† apprendre...</div>
                    </div>
                    <div id="summary-stats" class="tab-pane">
                        <div class="loading-spinner">Chargement du r√©sum√©...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Configuration Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-lightning-fill"></i>
                Configuration rapide
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <div class="form-help">Choisissez un profil de r√©vision pr√©d√©fini</div>
            <div class="preset-buttons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 16px;">
                <button type="button" class="preset-btn" data-preset="beginner">
                    <i class="bi bi-star"></i>
                    <span>D√©butant</span>
                    <small>10 cartes, 15 min</small>
                </button>
                <button type="button" class="preset-btn" data-preset="intermediate">
                    <i class="bi bi-lightning"></i>
                    <span>Interm√©diaire</span>
                    <small>20 cartes, 20 min</small>
                </button>
                <button type="button" class="preset-btn" data-preset="advanced">
                    <i class="bi bi-fire"></i>
                    <span>Avanc√©</span>
                    <small>30 cartes, 30 min</small>
                </button>
                <button type="button" class="preset-btn" data-preset="intensive">
                    <i class="bi bi-rocket"></i>
                    <span>Intensif</span>
                    <small>50 cartes, 45 min</small>
                </button>
            </div>
        </div>
    </div>

    <!-- Learning Settings Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-sliders"></i>
                Param√®tres d'apprentissage
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <form id="revision-settings-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="revision">

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Mode d'√©tude par d√©faut</label>
                        <select name="default_study_mode" class="form-control">
                            <option value="spaced">R√©p√©tition espac√©e</option>
                            <option value="intensive">R√©vision intensive</option>
                            <option value="mixed">Mode mixte</option>
                            <option value="custom">Personnalis√©</option>
                        </select>
                        <div class="form-help">Algorithme utilis√© pour planifier vos r√©visions</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Difficult√© par d√©faut</label>
                        <select name="default_difficulty" class="form-control">
                            <option value="easy">Facile</option>
                            <option value="normal">Normal</option>
                            <option value="hard">Difficile</option>
                            <option value="expert">Expert</option>
                        </select>
                        <div class="form-help">Niveau de difficult√© pour les nouvelles cartes</div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cartes par session</label>
                        <div class="range-input">
                            <input type="range" name="cards_per_session" min="5" max="100" value="20" class="form-range">
                            <span class="range-value">20</span>
                        </div>
                        <div class="form-help">Nombre de cartes √† r√©viser par session</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Dur√©e de session (minutes)</label>
                        <div class="range-input">
                            <input type="range" name="default_session_duration" min="5" max="120" value="20" class="form-range">
                            <span class="range-value">20</span>
                        </div>
                        <div class="form-help">Dur√©e recommand√©e par session</div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">R√©visions pour apprendre</label>
                        <div class="range-input">
                            <input type="range" name="required_reviews_to_learn" min="1" max="10" value="3" class="form-range">
                            <span class="range-value">3</span>
                        </div>
                        <div class="form-help">Nombre de r√©visions correctes n√©cessaires</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" name="auto_advance" checked>
                            Passage automatique
                        </label>
                        <div class="form-help">Passer automatiquement √† la carte suivante</div>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn-primary">
                        <i class="bi bi-save"></i>
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Spaced Repetition Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-calendar3"></i>
                R√©p√©tition espac√©e
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="spaced_repetition">
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="spaced_repetition_enabled" checked>
                        Activer la r√©p√©tition espac√©e
                    </label>
                    <div class="form-help">Utilise l'algorithme de Leitner pour optimiser la m√©morisation</div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Intervalle facile (jours)</label>
                        <input type="number" name="initial_interval_easy" min="1" max="30" value="4" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Intervalle normal (jours)</label>
                        <input type="number" name="initial_interval_normal" min="1" max="30" value="2" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Intervalle difficile (jours)</label>
                        <input type="number" name="initial_interval_hard" min="1" max="30" value="1" class="form-control">
                    </div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn-primary">
                        <i class="bi bi-save"></i>
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notifications Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-bell"></i>
                Rappels et notifications
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="notifications">
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="weekday_reminders" {% if user.weekday_reminders %}checked{% endif %}>
                        Rappel quotidien
                    </label>
                    <div class="form-help">Recevoir un rappel pour r√©viser quotidiennement</div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Heure du rappel</label>
                        <input type="time" name="reminder_time" value="{{ user.reminder_time|time:'H:i' }}" class="form-control">
                        <div class="form-help">Heure √† laquelle recevoir le rappel</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Fr√©quence des notifications</label>
                        <select name="notification_frequency" class="form-control">
                            <option value="daily">Quotidienne</option>
                            <option value="weekly">Hebdomadaire</option>
                            <option value="custom">Personnalis√©e</option>
                            <option value="disabled">D√©sactiv√©e</option>
                        </select>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn-primary">
                        <i class="bi bi-save"></i>
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Interface Settings Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-palette"></i>
                Interface et exp√©rience
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="interface">
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="enable_animations" checked>
                        Animations
                    </label>
                    <div class="form-help">Effets visuels lors des transitions</div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="auto_play_audio">
                        Audio automatique
                    </label>
                    <div class="form-help">Jouer automatiquement les prononciations</div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="keyboard_shortcuts_enabled" checked>
                        Raccourcis clavier
                    </label>
                    <div class="form-help">Utiliser les raccourcis pour naviguer</div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="show_progress_stats" checked>
                        Afficher les statistiques de progression
                    </label>
                    <div class="form-help">Voir vos statistiques en temps r√©el pendant l'√©tude</div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn-primary">
                        <i class="bi bi-save"></i>
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Audio and Voice Settings Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-volume-up"></i>
                Param√®tres audio et voix
            </h3>
            <div class="section-actions">
                <button type="button" onclick="testCurrentVoices()" style="margin-right: 8px; padding: 4px 8px; font-size: 12px; background: #17a2b8; color: white; border: none; border-radius: 4px;">
                    üéµ Test
                </button>
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="audio">
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="audio_enabled" checked>
                        Activer la synth√®se vocale
                    </label>
                    <div class="form-help">Active ou d√©sactive compl√®tement la lecture audio</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Vitesse de lecture</label>
                    <div class="range-input">
                        <input type="range" name="audio_speed" min="0.5" max="2.0" step="0.1" value="0.9" class="form-range">
                        <span class="range-value">0.9x</span>
                    </div>
                    <div class="form-help">Vitesse de la synth√®se vocale (0.5x √† 2.0x)</div>
                </div>

                <!-- Voice Gender Selection -->
                <div class="voice-selection-grid">
                    <h4 class="voice-section-title">
                        <i class="bi bi-globe"></i>
                        Genres de voix pr√©f√©r√©s par langue
                    </h4>
                    <div class="form-help" style="margin-bottom: 16px;">
                        Choisissez le genre de voix pr√©f√©r√© pour chaque langue. Le syst√®me s√©lectionnera automatiquement la meilleure voix disponible.
                    </div>
                    
                    <div class="voice-language-section">
                        <div class="form-group">
                            <label class="form-label">
                                <img src="https://flagcdn.com/w20/fr.png" alt="FR" class="flag-icon">
                                Fran√ßais
                            </label>
                            <select name="preferred_gender_french" class="form-control gender-select" data-lang="fr-FR">
                                <option value="auto">Automatique</option>
                                <option value="male">Masculin</option>
                                <option value="female">F√©minin</option>
                            </select>
                            <button type="button" class="voice-test-btn" data-lang="fr-FR" data-text="Bonjour, ceci est un test de la voix fran√ßaise">
                                üéµ Tester
                            </button>
                        </div>
                    </div>

                    <div class="voice-language-section">
                        <div class="form-group">
                            <label class="form-label">
                                <img src="https://flagcdn.com/w20/us.png" alt="EN" class="flag-icon">
                                Anglais
                            </label>
                            <select name="preferred_gender_english" class="form-control gender-select" data-lang="en-US">
                                <option value="auto">Automatique</option>
                                <option value="male">Masculin</option>
                                <option value="female">F√©minin</option>
                            </select>
                            <button type="button" class="voice-test-btn" data-lang="en-US" data-text="Hello, this is a test of the English voice">
                                üéµ Tester
                            </button>
                        </div>
                    </div>

                    <div class="voice-language-section">
                        <div class="form-group">
                            <label class="form-label">
                                <img src="https://flagcdn.com/w20/es.png" alt="ES" class="flag-icon">
                                Espagnol
                            </label>
                            <select name="preferred_gender_spanish" class="form-control gender-select" data-lang="es-ES">
                                <option value="auto">Automatique</option>
                                <option value="male">Masculin</option>
                                <option value="female">F√©minin</option>
                            </select>
                            <button type="button" class="voice-test-btn" data-lang="es-ES" data-text="Hola, esto es una prueba de la voz espa√±ola">
                                üéµ Tester
                            </button>
                        </div>
                    </div>

                    <div class="voice-language-section">
                        <div class="form-group">
                            <label class="form-label">
                                <img src="https://flagcdn.com/w20/it.png" alt="IT" class="flag-icon">
                                Italien
                            </label>
                            <select name="preferred_gender_italian" class="form-control gender-select" data-lang="it-IT">
                                <option value="auto">Automatique</option>
                                <option value="male">Masculin</option>
                                <option value="female">F√©minin</option>
                            </select>
                            <button type="button" class="voice-test-btn" data-lang="it-IT" data-text="Ciao, questo √® un test della voce italiana">
                                üéµ Tester
                            </button>
                        </div>
                    </div>

                    <div class="voice-language-section">
                        <div class="form-group">
                            <label class="form-label">
                                <img src="https://flagcdn.com/w20/de.png" alt="DE" class="flag-icon">
                                Allemand
                            </label>
                            <select name="preferred_gender_german" class="form-control gender-select" data-lang="de-DE">
                                <option value="auto">Automatique</option>
                                <option value="male">Masculin</option>
                                <option value="female">F√©minin</option>
                            </select>
                            <button type="button" class="voice-test-btn" data-lang="de-DE" data-text="Hallo, das ist ein Test der deutschen Stimme">
                                üéµ Tester
                            </button>
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn-primary">
                        <i class="bi bi-save"></i>
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    /* Styles for revision settings */
    .stat-card {
        background: white;
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border-color: var(--card-color);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--card-color);
    }

    .stat-card:nth-child(1) {
        --card-color: #3b82f6; /* Blue for total cards */
    }

    .stat-card:nth-child(2) {
        --card-color: #10b981; /* Green for cards learned */
    }

    .stat-card:nth-child(3) {
        --card-color: #f59e0b; /* Orange for daily streak */
    }

    .stat-card:nth-child(4) {
        --card-color: #8b5cf6; /* Purple for success rate */
    }

    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: var(--card-color);
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .preset-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 16px 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .preset-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--preset-color);
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .preset-btn:hover::before,
    .preset-btn.active::before {
        opacity: 1;
    }

    .preset-btn[data-preset="beginner"] {
        --preset-color: #22c55e; /* Green for beginner */
    }

    .preset-btn[data-preset="intermediate"] {
        --preset-color: #3b82f6; /* Blue for intermediate */
    }

    .preset-btn[data-preset="advanced"] {
        --preset-color: #f59e0b; /* Orange for advanced */
    }

    .preset-btn[data-preset="intensive"] {
        --preset-color: #ef4444; /* Red for intensive */
    }

    .preset-btn:hover {
        border-color: var(--preset-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        background: rgba(255, 255, 255, 0.95);
    }

    .preset-btn.active {
        border-color: var(--preset-color);
        background: color-mix(in srgb, var(--preset-color) 8%, white);
    }

    .preset-btn i {
        font-size: 24px;
        color: var(--preset-color);
        margin-bottom: 8px;
        transition: color 0.2s ease;
    }

    .preset-btn span {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }

    .preset-btn small {
        font-size: 12px;
        color: #666;
    }

    .range-input {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .range-input .form-range {
        flex: 1;
    }

    .range-value {
        min-width: 30px;
        text-align: center;
        font-weight: 600;
        color: #875a7b;
    }

    /* Word Statistics Styles */
    .word-stats-display {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        overflow: hidden;
        background: white;
    }

    .stats-tabs {
        display: flex;
        border-bottom: 1px solid #e9ecef;
        background: #f8f9fa;
    }

    .stats-tab {
        flex: 1;
        padding: 12px 16px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-weight: 500;
        color: #6c757d;
        transition: all 0.2s ease;
        position: relative;
    }

    .stats-tab:hover {
        background: rgba(0, 0, 0, 0.05);
        color: #495057;
    }

    .stats-tab.active {
        color: #875a7b;
        background: white;
    }

    .stats-tab.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: #875a7b;
    }

    .stats-content {
        padding: 20px;
    }

    .tab-pane {
        display: none;
    }

    .tab-pane.active {
        display: block;
    }

    .loading-spinner {
        text-align: center;
        color: #6c757d;
        padding: 20px;
    }

    .word-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f1f3f4;
    }

    .word-item:last-child {
        border-bottom: none;
    }

    .word-content {
        flex: 1;
    }

    .word-front {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }

    .word-back {
        color: #666;
        font-size: 14px;
    }

    .word-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
    }

    .word-deck {
        font-size: 12px;
        color: #875a7b;
        background: rgba(135, 90, 123, 0.1);
        padding: 2px 8px;
        border-radius: 12px;
    }

    .word-progress {
        font-size: 12px;
        color: #666;
    }

    .progress-bar {
        width: 60px;
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 4px;
    }

    .progress-fill {
        height: 100%;
        background: #28a745;
        transition: width 0.3s ease;
    }

    .stats-summary {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .summary-card {
        padding: 16px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        text-align: center;
    }

    .summary-number {
        font-size: 24px;
        font-weight: bold;
        color: #875a7b;
        margin-bottom: 4px;
    }

    .summary-label {
        font-size: 14px;
        color: #666;
    }

    /* Audio and Voice Settings Styles */
    .voice-selection-grid {
        margin-top: 20px;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    .voice-section-title {
        margin: 0 0 16px 0;
        color: #333;
        font-size: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .voice-language-section {
        margin-bottom: 16px;
        padding: 12px;
        background: white;
        border-radius: 6px;
        border: 1px solid #dee2e6;
    }

    .voice-language-section:last-child {
        margin-bottom: 0;
    }

    .voice-language-section .form-group {
        margin-bottom: 0;
        display: grid;
        grid-template-columns: 120px 1fr auto;
        gap: 12px;
        align-items: center;
    }

    .flag-icon {
        width: 16px;
        height: 12px;
        margin-right: 8px;
        border-radius: 2px;
    }

    .voice-select {
        max-width: none;
    }

    .voice-test-btn {
        padding: 6px 12px;
        font-size: 12px;
        background: #17a2b8;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.2s ease;
    }

    .voice-test-btn:hover {
        background: #138496;
        transform: scale(1.05);
    }

    .voice-test-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }

    .voice-test-btn.testing {
        background: #28a745;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    /* Audio speed range styling */
    .range-input input[name="audio_speed"] + .range-value::after {
        content: "x";
    }

    /* Responsive voice settings */
    @media (max-width: 768px) {
        .voice-language-section .form-group {
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .voice-test-btn {
            justify-self: start;
        }
    }
</style>

<script>
    // JavaScript for revision settings
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize revision settings
        initRevisionSettings();

        // Preset button handlers
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const preset = this.dataset.preset;
                applyRevisionPreset(preset);
            });
        });

        // Range slider handlers
        document.querySelectorAll('.range-input input[type="range"]').forEach(slider => {
            slider.addEventListener('input', function () {
                const valueSpan = this.parentElement.querySelector('.range-value');
                valueSpan.textContent = this.value;
            });
        });

        // Word stats tab handlers
        document.querySelectorAll('.stats-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                const tabId = this.dataset.tab;
                switchStatsTab(tabId);
            });
        });

        // Initialize word stats
        initWordStats();

        // Initialize voice settings
        initVoiceSettings();
    });

    function initRevisionSettings() {
        console.log('[RevisionSettings] Initializing revision settings - VERSION 2.0');
        console.log('[RevisionSettings] Calling loadRevisionStats in 1 second...');
        setTimeout(() => {
            loadRevisionStats();
        }, 1000);
    }

    async function loadRevisionStats() {
        console.log('[RevisionSettings] Loading revision statistics from API');
        
        try {
            console.log('[RevisionSettings] Fetching from /api/v1/revision/settings/api/settings/stats/');
            const response = await fetch('/api/v1/revision/settings/api/settings/stats/');
            console.log('[RevisionSettings] Response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const stats = await response.json();
            console.log('[RevisionSettings] Statistics loaded successfully:', stats);
            
            // Mettre √† jour les √©l√©ments HTML avec v√©rification
            const updateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                    console.log(`[RevisionSettings] Updated ${id} to: ${value}`);
                } else {
                    console.error(`[RevisionSettings] Element ${id} not found`);
                }
            };
            
            updateElement('total-cards', stats.total_cards || 0);
            updateElement('cards-learned', stats.cards_learned || 0);
            updateElement('daily-streak', stats.daily_streak || 0);
            updateElement('success-rate', stats.success_rate ? Math.round(stats.success_rate * 100) + '%' : '0%');
        } catch (error) {
            console.error('[RevisionSettings] Error loading statistics:', error);
            // Fallback en cas d'erreur
            document.getElementById('total-cards').textContent = '0';
            document.getElementById('cards-learned').textContent = '0';
            document.getElementById('daily-streak').textContent = '0';
            document.getElementById('success-rate').textContent = '0%';
        }
    }

    async function testStatsAPI() {
        console.log('[TEST] Testing stats API...');
        try {
            const response = await fetch('/api/v1/revision/settings/api/settings/test_stats/');
            const data = await response.json();
            console.log('[TEST] Test API response:', data);
            alert(`Test API: ${data.message}\nCartes: ${data.total_cards}\nApprises: ${data.cards_learned}`);
        } catch (error) {
            console.error('[TEST] Error:', error);
            alert('Test API failed: ' + error.message);
        }
    }

    function applyRevisionPreset(presetName) {
        console.log(`[RevisionSettings] Applying preset: ${presetName}`);
        
        // Mark preset as active
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-preset="${presetName}"]`).classList.add('active');
        
        // Apply preset values
        const presets = {
            beginner: { cards_per_session: 10, default_session_duration: 15 },
            intermediate: { cards_per_session: 20, default_session_duration: 20 },
            advanced: { cards_per_session: 30, default_session_duration: 30 },
            intensive: { cards_per_session: 50, default_session_duration: 45 }
        };
        
        if (presets[presetName]) {
            const settings = presets[presetName];
            const cardsSlider = document.querySelector('[name="cards_per_session"]');
            const durationSlider = document.querySelector('[name="default_session_duration"]');
            
            if (cardsSlider) {
                cardsSlider.value = settings.cards_per_session;
                cardsSlider.parentElement.querySelector('.range-value').textContent = settings.cards_per_session;
            }
            
            if (durationSlider) {
                durationSlider.value = settings.default_session_duration;
                durationSlider.parentElement.querySelector('.range-value').textContent = settings.default_session_duration;
            }
        }
    }

    // Word Statistics Functions
    function initWordStats() {
        console.log('[WordStats] Initializing word statistics');
        loadWordStats('known');
    }

    function switchStatsTab(tabId) {
        // Update tab active states
        document.querySelectorAll('.stats-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

        // Update content active states
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('active');
        });
        
        const targetPane = document.getElementById(tabId === 'known' ? 'known-words' : 
                                                 tabId === 'to-learn' ? 'to-learn-words' : 'summary-stats');
        if (targetPane) {
            targetPane.classList.add('active');
        }

        // Load data for the selected tab
        loadWordStats(tabId);
    }

    function loadWordStats(type) {
        console.log(`[WordStats] Loading ${type} word statistics`);
        
        const apiUrl = '/api/v1/revision/word-stats/';
        const params = new URLSearchParams();
        
        if (type === 'known') {
            params.append('type', 'known');
        } else if (type === 'to-learn') {
            params.append('type', 'to_learn');
        } else {
            params.append('type', 'all');
        }

        fetch(`${apiUrl}?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                displayWordStats(type, data);
            })
            .catch(error => {
                console.error(`[WordStats] Error loading ${type} stats:`, error);
                showStatsError(type);
            });
    }

    function displayWordStats(type, data) {
        const container = document.getElementById(
            type === 'known' ? 'known-words' : 
            type === 'to-learn' ? 'to-learn-words' : 'summary-stats'
        );

        if (!container) return;

        if (type === 'summary' || type === 'all') {
            // Display summary statistics
            container.innerHTML = `
                <div class="stats-summary">
                    <div class="summary-card">
                        <div class="summary-number">${data.statistics?.total_known || 0}</div>
                        <div class="summary-label">Mots connus</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number">${data.statistics?.total_to_learn || 0}</div>
                        <div class="summary-label">√Ä apprendre</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number">${data.statistics?.total_words || 0}</div>
                        <div class="summary-label">Total</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number">${data.statistics?.completion_rate || 0}%</div>
                        <div class="summary-label">Taux de r√©ussite</div>
                    </div>
                </div>
            `;
        } else {
            // Display word lists
            const words = type === 'known' ? data.known_words : data.words_to_learn;
            
            if (!words || words.length === 0) {
                container.innerHTML = `
                    <div class="loading-spinner">
                        Aucun mot ${type === 'known' ? 'connu' : '√† apprendre'} trouv√©.
                    </div>
                `;
                return;
            }

            const wordsHtml = words.map(word => `
                <div class="word-item">
                    <div class="word-content">
                        <div class="word-front">${word.front_text}</div>
                        <div class="word-back">${word.back_text}</div>
                    </div>
                    <div class="word-meta">
                        <div class="word-deck">${word.deck_name}</div>
                        ${type === 'to-learn' ? `
                            <div class="word-progress">${word.correct_reviews}/${word.reviews_needed + word.correct_reviews}</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${word.progress_percentage}%"></div>
                            </div>
                        ` : `
                            <div class="word-progress">Appris ‚úì</div>
                        `}
                    </div>
                </div>
            `).join('');

            container.innerHTML = wordsHtml;
        }
    }

    function showStatsError(type) {
        const container = document.getElementById(
            type === 'known' ? 'known-words' : 
            type === 'to-learn' ? 'to-learn-words' : 'summary-stats'
        );
        
        if (container) {
            container.innerHTML = `
                <div class="loading-spinner" style="color: #dc3545;">
                    Erreur lors du chargement des statistiques.
                </div>
            `;
        }
    }

    // ===== VOICE SETTINGS FUNCTIONS =====
    
    let speechSynthesis = window.speechSynthesis;
    let availableVoices = [];
    let currentTestUtterance = null;

    function initVoiceSettings() {
        console.log('[VoiceSettings] Initializing voice settings with gender selection');
        
        // Load available voices
        availableVoices = speechSynthesis.getVoices();
        console.log(`[VoiceSettings] Loaded ${availableVoices.length} voices for gender categorization`);
        logVoiceDetails();
        
        // Voices might load asynchronously
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = function() {
                availableVoices = speechSynthesis.getVoices();
                console.log(`[VoiceSettings] Voices updated: ${availableVoices.length} available`);
                logVoiceDetails();
            };
        }

    function logVoiceDetails() {
        console.log('üîç DIAGNOSTIC D√âTAILL√â DES VOIX DISPONIBLES:');
        console.log('=============================================');
        
        const englishVoices = availableVoices.filter(v => v.lang && v.lang.startsWith('en'));
        const italianVoices = availableVoices.filter(v => v.lang && v.lang.startsWith('it'));
        
        console.log(`üá∫üá∏ VOIX ANGLAISES (${englishVoices.length} trouv√©es):`);
        englishVoices.forEach((voice, index) => {
            console.log(`  ${index + 1}. "${voice.name}" (${voice.lang}) - Local: ${voice.localService}`);
        });
        
        console.log(`üáÆüáπ VOIX ITALIENNES (${italianVoices.length} trouv√©es):`);
        italianVoices.forEach((voice, index) => {
            console.log(`  ${index + 1}. "${voice.name}" (${voice.lang}) - Local: ${voice.localService}`);
        });
        
        // Test de cat√©gorisation
        console.log('\nüß™ TEST DE CAT√âGORISATION:');
        if (englishVoices.length > 0) {
            const englishCategorized = categorizeVoicesByGender(englishVoices);
            console.log('Anglais - Masculines:', englishCategorized.male.map(v => v.name));
            console.log('Anglais - F√©minines:', englishCategorized.female.map(v => v.name));
            console.log('Anglais - Inconnues:', englishCategorized.unknown.map(v => v.name));
        }
        
        if (italianVoices.length > 0) {
            const italianCategorized = categorizeVoicesByGender(italianVoices);
            console.log('Italien - Masculines:', italianCategorized.male.map(v => v.name));
            console.log('Italien - F√©minines:', italianCategorized.female.map(v => v.name));
            console.log('Italien - Inconnues:', italianCategorized.unknown.map(v => v.name));
        }
    }

        // Setup event listeners for gender selectors
        setupVoiceEventListeners();

        // Setup audio speed slider
        const audioSpeedSlider = document.querySelector('[name="audio_speed"]');
        if (audioSpeedSlider) {
            audioSpeedSlider.addEventListener('input', function() {
                const valueSpan = this.parentElement.querySelector('.range-value');
                valueSpan.textContent = this.value + 'x';
            });
        }
    }

    function loadVoices() {
        availableVoices = speechSynthesis.getVoices();
        console.log(`[VoiceSettings] Loaded ${availableVoices.length} voices`);
        
        if (availableVoices.length > 0) {
            populateVoiceSelectors();
        }
    }

    function setupVoiceEventListeners() {
        // Voice test buttons
        document.querySelectorAll('.voice-test-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const lang = this.dataset.lang;
                const text = this.dataset.text;
                testVoice(lang, text, this);
            });
        });

        // Gender selection changes
        document.querySelectorAll('.gender-select').forEach(select => {
            select.addEventListener('change', function() {
                const lang = this.dataset.lang;
                const gender = this.value;
                console.log(`[VoiceSettings] Gender preference changed for ${lang}: ${gender}`);
            });
        });
    }

    function populateVoiceSelectors() {
        const languages = {
            'fr-FR': 'fr',
            'en-US': 'en', 
            'es-ES': 'es',
            'it-IT': 'it',
            'de-DE': 'de'
        };

        Object.entries(languages).forEach(([fullLang, shortLang]) => {
            const select = document.querySelector(`[data-lang="${fullLang}"]`);
            if (!select) return;

            // Find voices for this language
            const languageVoices = availableVoices.filter(voice => 
                voice.lang.startsWith(shortLang) || voice.lang.startsWith(fullLang)
            );

            // Sort by quality (local first, then by name)
            languageVoices.sort((a, b) => {
                if (a.localService && !b.localService) return -1;
                if (!a.localService && b.localService) return 1;
                return a.name.localeCompare(b.name);
            });

            // Clear existing options (except the first one)
            const firstOption = select.querySelector('option');
            select.innerHTML = '';
            select.appendChild(firstOption);

            // Add voice options
            if (languageVoices.length === 0) {
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = `--- Aucune voix ${shortLang.toUpperCase()} trouv√©e ---`;
                select.appendChild(option);
            } else {
                languageVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} ${voice.localService ? 'üè†' : '‚òÅÔ∏è'}`;
                    select.appendChild(option);
                });
            }

            console.log(`[VoiceSettings] Populated ${languageVoices.length} voices for ${fullLang}`);
        });
    }

    function testVoice(languageCode, text, buttonElement) {
        if (currentTestUtterance) {
            speechSynthesis.cancel();
        }

        // Get selected gender for this language
        const select = document.querySelector(`[data-lang="${languageCode}"].gender-select`);
        let selectedGender = select ? select.value : 'auto';

        console.log(`[VoiceSettings] Testing voice for ${languageCode} with gender: ${selectedGender}`);

        // Find best voice for the selected gender
        let voice = getBestVoiceForGender(languageCode, selectedGender);

        if (!voice) {
            alert(`Aucune voix trouv√©e pour ${languageCode}`);
            return;
        }

        // Create and configure utterance
        currentTestUtterance = new SpeechSynthesisUtterance(text);
        currentTestUtterance.voice = voice;
        currentTestUtterance.lang = voice.lang;
        
        // Use current speed setting
        const speedSlider = document.querySelector('[name="audio_speed"]');
        currentTestUtterance.rate = speedSlider ? parseFloat(speedSlider.value) : 0.9;
        currentTestUtterance.pitch = 1.0;
        currentTestUtterance.volume = 1.0;

        // Button animation
        buttonElement.classList.add('testing');
        buttonElement.disabled = true;

        currentTestUtterance.onstart = () => {
            console.log(`[VoiceSettings] Testing voice: ${voice.name} (${voice.lang})`);
        };

        currentTestUtterance.onend = () => {
            buttonElement.classList.remove('testing');
            buttonElement.disabled = false;
            currentTestUtterance = null;
        };

        currentTestUtterance.onerror = (error) => {
            console.error(`[VoiceSettings] Voice test error:`, error);
            buttonElement.classList.remove('testing');
            buttonElement.disabled = false;
            currentTestUtterance = null;
        };

        // Speak
        speechSynthesis.speak(currentTestUtterance);
    }

    function getBestVoiceForGender(languageCode, preferredGender) {
        const shortLang = languageCode.split('-')[0];
        const langVoices = availableVoices.filter(v => v.lang.startsWith(shortLang));

        if (!langVoices.length) {
            console.warn(`‚ùå Aucune voix trouv√©e pour ${languageCode}`);
            return null;
        }

        console.log(`üîç [Settings] Recherche voix ${preferredGender} pour ${languageCode} (${langVoices.length} voix disponibles)`);

        if (preferredGender === 'auto') {
            // Return best quality voice (local service preferred)
            const sortedByQuality = langVoices.sort((a, b) => {
                // Priorit√© : service local puis score qualit√©
                if (a.localService && !b.localService) return -1;
                if (!a.localService && b.localService) return 1;
                return (b.qualityScore || 0) - (a.qualityScore || 0);
            });
            console.log(`‚úÖ Mode auto - voix s√©lectionn√©e: ${sortedByQuality[0].name}`);
            return sortedByQuality[0];
        }

        // Categorize voices by gender
        const voicesByGender = categorizeVoicesByGender(langVoices);
        const genderVoices = voicesByGender[preferredGender] || [];

        console.log(`üìä Voix ${preferredGender} trouv√©es: ${genderVoices.length}`);

        if (genderVoices.length > 0) {
            // Trier par score de qualit√© et service local
            const sortedGenderVoices = genderVoices.sort((a, b) => {
                // Priorit√© : service local puis score qualit√©
                if (a.localService && !b.localService) return -1;
                if (!a.localService && b.localService) return 1;
                return (b.qualityScore || 0) - (a.qualityScore || 0);
            });
            console.log(`‚úÖ S√©lection de la meilleure voix ${preferredGender} pour ${languageCode}: ${sortedGenderVoices[0].name} (score: ${sortedGenderVoices[0].qualityScore || 'N/A'})`);
            return sortedGenderVoices[0];
        }

        // FALLBACK INTELLIGENT: Si aucune voix n'est d√©tect√©e pour ce genre
        console.warn(`‚ö†Ô∏è Aucune voix ${preferredGender} d√©tect√©e pour ${languageCode}, utilisation du fallback intelligent`);
        
        // Strat√©gie sp√©ciale pour l'italien avec une seule voix disponible
        if (shortLang === 'it' && langVoices.length === 1) {
            const italianVoice = langVoices[0];
            console.log(`üáÆüáπ Italien: Une seule voix disponible (${italianVoice.name}) - utilisation pour les deux genres`);
            
            // Ajouter un indicateur pour diff√©rencier dans l'interface utilisateur
            if (preferredGender === 'female') {
                console.log(`üîÑ Mode f√©minin italien: ${italianVoice.name} (m√™me voix, ton ajust√©)`);
                // En option : ajuster la vitesse/pitch pour f√©miniser l√©g√®rement
            } else {
                console.log(`üîÑ Mode masculin italien: ${italianVoice.name} (voix standard)`);
            }
            return italianVoice;
        }
        
        // Strat√©gie : utiliser la position dans la liste comme indicateur
        // En g√©n√©ral, les voix masculines sont souvent en premi√®re position, les f√©minines ensuite
        if (langVoices.length >= 2) {
            if (preferredGender === 'male') {
                console.log(`üîÑ Fallback masculin: s√©lection de la premi√®re voix (${langVoices[0].name})`);
                return langVoices[0]; // Premi√®re voix g√©n√©ralement masculine
            } else if (preferredGender === 'female') {
                console.log(`üîÑ Fallback f√©minin: s√©lection de la deuxi√®me voix (${langVoices[1].name})`);
                return langVoices[1]; // Deuxi√®me voix g√©n√©ralement f√©minine
            }
        }

        // Fallback final: meilleure voix disponible
        const fallbackVoices = langVoices.sort((a, b) => {
            if (a.localService && !b.localService) return -1;
            if (!a.localService && b.localService) return 1;
            return (b.qualityScore || 0) - (a.qualityScore || 0);
        });
        console.log(`üîÑ Fallback final: ${fallbackVoices[0].name}`);
        return fallbackVoices[0];
    }

    function categorizeVoicesByGender(voices) {
        const genderPatterns = {
            male: [
                // Patterns masculins anglais (tr√®s sp√©cifiques)
                'microsoft david', 'google us english male', 'google uk english male', 'alex', 'daniel',
                'microsoft mark', 'microsoft ryan', 'microsoft frank', 'microsoft sean', 'microsoft kevin',
                // Patterns italiens masculins
                'microsoft cosimo', 'luca', 'marco', 'giovanni', 'francesco', 'alessandro', 'lorenzo', 'matteo',
                // Patterns g√©n√©raux masculins
                'paul', 'george', 'david', 'mark', 'richard', 'daniel', 'thomas', 'matthew', 'james', 'john',
                'pierre', 'jean', 'michel', 'henri', 'louis', 'fran√ßois', 'antoine', 'nicolas',
                'carlos', 'diego', 'antonio', 'fernando', 'miguel', 'jos√©', 'manuel', 'francisco',
                'klaus', 'hans', 'wolfgang', 'stefan', 'michael', 'andreas', 'christian',
                // Indicators
                'male', 'man', 'masculin', 'homme', 'hombre', 'uomo', 'mann', 'masculine'
            ],
            female: [
                // Patterns f√©minins anglais (tr√®s sp√©cifiques)  
                'microsoft zira', 'google us english female', 'google uk english female', 'samantha', 'victoria',
                'microsoft eva', 'microsoft hazel', 'microsoft aria', 'microsoft natasha',
                // Patterns italiens f√©minins
                'microsoft elsa', 'giulia', 'francesca', 'elena', 'sara', 'anna', 'valentina', 'chiara',
                // Patterns g√©n√©raux f√©minins
                'julie', 'marie', 'sarah', 'emma', 'sophie', 'claire', 'anne', 'lisa', 'susan', 'helen',
                'am√©lie', 'isabelle', 'nathalie', 'v√©ronique', 'christine', 'fran√ßoise', 'martine',
                'maria', 'carmen', 'ana', 'lucia', 'pilar', 'rosa', 'elena', 'patricia',
                'anna', 'maria', 'petra', 'sabine', 'christine', 'angelika', 'barbara',
                // Indicators
                'female', 'woman', 'f√©minin', 'femme', 'mujer', 'donna', 'frau', 'feminine'
            ]
        };

        // Voix anglaises masculines de haute qualit√© (patterns √©tendus pour une meilleure d√©tection)
        const premiumEnglishMaleVoices = [
            'microsoft david', 'google uk english male', 'microsoft ryan', 'microsoft frank',
            'google us english male', 'microsoft sean', 'google australian male', 'microsoft kevin',
            'alex', 'daniel', 'samantha male', 'tom', 'nathan', 'aaron enhanced', 'fred',
            // Ajout de patterns plus larges pour d√©tecter les voix syst√®me
            'male', 'man', 'masculine', 'guy', 'boy', 'mr', 'sir'
        ];

        // Voix anglaises f√©minines de haute qualit√©
        const premiumEnglishFemaleVoices = [
            'microsoft zira', 'microsoft eva', 'google uk english female', 'microsoft hazel',
            'google us english female', 'microsoft aria', 'google australian female', 'microsoft natasha',
            'samantha', 'victoria', 'kate', 'alice', 'emma', 'olivia', 'sophia',
            // Ajout de patterns plus larges pour d√©tecter les voix syst√®me
            'female', 'woman', 'feminine', 'girl', 'lady', 'ms', 'mrs'
        ];

        const result = { male: [], female: [], unknown: [] };

        for (const voice of voices) {
            const voiceName = voice.name.toLowerCase();
            let gender = 'unknown';
            let qualityBonus = 0;

            // D√âTECTION PR√âCISE PAR MOT-CL√â EXPLICITE (priorit√© absolue)
            if (voice.lang && voice.lang.startsWith('en')) {
                // D'abord v√©rifier les mots-cl√©s explicites de genre
                if (voiceName.includes('female') || voiceName.includes('woman') || voiceName.includes('feminine')) {
                    gender = 'female';
                    qualityBonus = 100;
                    console.log(`üë© Voix f√©minine d√©tect√©e par mot-cl√© explicite: ${voice.name} (bonus: ${qualityBonus})`);
                } else if (voiceName.includes('male') || voiceName.includes('man') || voiceName.includes('masculine')) {
                    gender = 'male';  
                    qualityBonus = 100;
                    console.log(`üë® Voix masculine d√©tect√©e par mot-cl√© explicite: ${voice.name} (bonus: ${qualityBonus})`);
                }
                
                // Si pas encore d√©termin√©, v√©rifier les voix f√©minines premium sp√©cifiques
                if (gender === 'unknown') {
                    for (let i = 0; i < premiumEnglishFemaleVoices.length; i++) {
                        if (voiceName.includes(premiumEnglishFemaleVoices[i]) && !voiceName.includes('male')) {
                            gender = 'female';
                            qualityBonus = 50 + (premiumEnglishFemaleVoices.length - i) * 10;
                            console.log(`üéØ Voix anglaise f√©minine premium d√©tect√©e: ${voice.name} (bonus: ${qualityBonus})`);
                            break;
                        }
                    }
                }
                
                // Si pas encore d√©termin√©, v√©rifier les voix masculines premium sp√©cifiques
                if (gender === 'unknown') {
                    for (let i = 0; i < premiumEnglishMaleVoices.length; i++) {
                        if (voiceName.includes(premiumEnglishMaleVoices[i]) && !voiceName.includes('female')) {
                            gender = 'male';
                            qualityBonus = 50 + (premiumEnglishMaleVoices.length - i) * 10;
                            console.log(`üéØ Voix anglaise masculine premium d√©tect√©e: ${voice.name} (bonus: ${qualityBonus})`);
                            break;
                        }
                    }
                }
            }

            // Si pas encore identifi√©, v√©rifier les patterns masculins standards
            if (gender === 'unknown') {
                for (const pattern of genderPatterns.male) {
                    if (voiceName.includes(pattern)) {
                        gender = 'male';
                        // Bonus suppl√©mentaire pour les voix anglaises masculines
                        if (voice.lang && voice.lang.startsWith('en')) {
                            qualityBonus = 20;
                        }
                        break;
                    }
                }
            }

            // If not male, check female patterns
            if (gender === 'unknown') {
                for (const pattern of genderPatterns.female) {
                    if (voiceName.includes(pattern)) {
                        gender = 'female';
                        // Bonus suppl√©mentaire pour les voix anglaises f√©minines
                        if (voice.lang && voice.lang.startsWith('en')) {
                            qualityBonus = 20;
                        }
                        break;
                    }
                }
            }

            // Appliquer le bonus qualit√©
            if (qualityBonus > 0) {
                voice.qualityScore = (voice.qualityScore || 0) + qualityBonus;
            }

            result[gender].push(voice);
        }

        // Trier les voix masculines par score de qualit√© pour chaque langue
        result.male.sort((a, b) => {
            // Prioriser d'abord les voix anglaises avec bonus
            if (a.lang && a.lang.startsWith('en') && (!b.lang || !b.lang.startsWith('en'))) {
                return -1;
            }
            if (b.lang && b.lang.startsWith('en') && (!a.lang || !a.lang.startsWith('en'))) {
                return 1;
            }
            // Puis trier par score de qualit√©
            return (b.qualityScore || 0) - (a.qualityScore || 0);
        });

        // Trier aussi les voix f√©minines par score de qualit√©
        result.female.sort((a, b) => {
            // Prioriser d'abord les voix anglaises avec bonus
            if (a.lang && a.lang.startsWith('en') && (!b.lang || !b.lang.startsWith('en'))) {
                return -1;
            }
            if (b.lang && b.lang.startsWith('en') && (!a.lang || !a.lang.startsWith('en'))) {
                return 1;
            }
            // Puis trier par score de qualit√©
            return (b.qualityScore || 0) - (a.qualityScore || 0);
        });

        // Debug: Afficher les r√©sultats de la cat√©gorisation pour l'anglais
        const englishVoices = voices.filter(v => v.lang && v.lang.startsWith('en'));
        if (englishVoices.length > 0) {
            console.log('üîç [Settings] Cat√©gorisation des voix anglaises:');
            console.log(`üìä Masculines (${result.male.filter(v => v.lang.startsWith('en')).length}):`, 
                result.male.filter(v => v.lang.startsWith('en')).map(v => `${v.name} (score: ${v.qualityScore || 0})`));
            console.log(`üìä F√©minines (${result.female.filter(v => v.lang.startsWith('en')).length}):`, 
                result.female.filter(v => v.lang.startsWith('en')).map(v => `${v.name} (score: ${v.qualityScore || 0})`));
            console.log(`üìä Inconnues (${result.unknown.filter(v => v.lang.startsWith('en')).length}):`, 
                result.unknown.filter(v => v.lang.startsWith('en')).map(v => v.name));
        }

        return result;
    }

    function testCurrentVoices() {
        // Test each configured language with a sample phrase
        const testPhrases = {
            'fr-FR': 'Bonjour, ceci est un test de qualit√© de la voix fran√ßaise',
            'en-US': 'Hello, this is a quality test of the English voice', 
            'es-ES': 'Hola, esta es una prueba de calidad de la voz espa√±ola',
            'it-IT': 'Ciao, questo √® un test di qualit√† della voce italiana',
            'de-DE': 'Hallo, das ist ein Qualit√§tstest der deutschen Stimme'
        };

        let delay = 0;
        Object.entries(testPhrases).forEach(([lang, text]) => {
            setTimeout(() => {
                const button = document.querySelector(`[data-lang="${lang}"].voice-test-btn`);
                if (button) {
                    testVoice(lang, text, button);
                }
            }, delay);
            delay += 3000; // 3 seconds between tests
        });
    }

    // Make function globally available
    window.testCurrentVoices = testCurrentVoices;
</script>
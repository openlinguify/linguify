{% load i18n %}

<!-- Revision Settings Modal -->
<div id="revisionSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50" style="display: none; align-items: center; justify-content: center;">
    <div class="bg-white rounded-2xl shadow-2xl transform transition-all" style="width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto;">
        <!-- Header -->
        <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center rounded-t-2xl">
            <h3 class="text-xl font-bold" style="color: #2D5BBA;">
                <i class="bi bi-gear me-2"></i>
                {% trans "Revision Settings" %}
            </h3>
            <button id="closeSettingsModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                <i class="bi bi-x-lg text-2xl"></i>
            </button>
        </div>

        <!-- Content -->
        <div class="p-6 space-y-6">
            <!-- Study Settings Section -->
            <div>
                <h4 class="text-lg font-semibold mb-4" style="color: #2D5BBA;">
                    <i class="bi bi-sliders me-2"></i>
                    {% trans "Study Settings" %}
                </h4>

                <div class="space-y-4">
                    <!-- Track Progress -->
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <span class="text-sm font-medium text-gray-700">{% trans "Track progress" %}</span>
                            <p class="text-xs text-gray-500">{% trans "Sort cards between known and learning" %}</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="trackProgress" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>

                    <!-- Auto-play Audio -->
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <span class="text-sm font-medium text-gray-700">{% trans "Auto-play audio" %}</span>
                            <p class="text-xs text-gray-500">{% trans "Automatically play audio when showing card" %}</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="autoPlayAudio" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="sticky bottom-0 bg-gray-50 border-t px-6 py-4 flex justify-end gap-3 rounded-b-2xl">
            <button id="cancelSettings" class="px-4 py-2 border text-gray-700 rounded-lg hover:bg-gray-100 transition-colors font-medium" style="border-color: #D1D5DB;">
                {% trans "Cancel" %}
            </button>
            <button id="saveSettings" class="px-4 py-2 text-white rounded-lg transition-colors font-medium" style="background: #2D5BBA;" onmouseover="this.style.background='#1E4A8C'" onmouseout="this.style.background='#2D5BBA'">
                {% trans "Save Changes" %}
            </button>
        </div>
    </div>
</div>

<script>
// Settings Modal Manager
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('revisionSettingsModal');
    const openBtn = document.getElementById('openRevisionSettings');
    const closeBtn = document.getElementById('closeSettingsModal');
    const cancelBtn = document.getElementById('cancelSettings');
    const saveBtn = document.getElementById('saveSettings');

    // Open modal
    openBtn?.addEventListener('click', () => {
        modal.style.display = 'flex';
        loadCurrentSettings();
    });

    // Close modal
    const closeModal = () => {
        modal.style.display = 'none';
    };

    closeBtn?.addEventListener('click', closeModal);
    cancelBtn?.addEventListener('click', closeModal);

    // Close on outside click
    modal?.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });

    // Load current settings
    async function loadCurrentSettings() {
        try {
            const response = await fetch('/revision/api/settings/user/');
            if (response.ok) {
                const data = await response.json();
                document.getElementById('trackProgress').checked = data.show_progress_stats ?? true;
                document.getElementById('autoPlayAudio').checked = data.auto_play_audio ?? false;
            }
        } catch (error) {
            console.error('Error loading settings:', error);
        }
    }

    // Save settings
    saveBtn?.addEventListener('click', async () => {
        const settings = {
            show_progress_stats: document.getElementById('trackProgress').checked,
            auto_play_audio: document.getElementById('autoPlayAudio').checked
        };

        try {
            const response = await fetch('/revision/api/settings/user/', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value
                },
                body: JSON.stringify(settings)
            });

            if (response.ok) {
                // Show success message
                if (window.notificationService) {
                    window.notificationService.success('{% trans "Settings saved successfully" %}');
                }

                closeModal();
                location.reload(); // Reload to apply changes
            } else {
                throw new Error('Failed to save settings');
            }
        } catch (error) {
            console.error('Error saving settings:', error);
            if (window.notificationService) {
                window.notificationService.error('{% trans "Error saving settings" %}');
            }
        }
    });
});
</script>

{% extends "revision/base_new.html" %}
{% load static %}

{% block page_title %}Memory{% endblock %}

{% block header_content %}
<!-- Interface unifi√©e sur une seule ligne -->
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
    <!-- Gauche: Navigation + Actions principales -->
    <div class="d-flex align-items-center gap-3">
        <!-- Bouton toggle sidebar mobile -->
        <button id="toggleSidebar" class="btn btn-outline-custom btn-sm d-md-none">
            <i class="bi bi-list"></i>
        </button>
        
        <!-- Navigation tabs -->
        <div class="d-flex align-items-center gap-1">
            <a href="{% url 'revision_web:main' %}" 
               class="nav-tab {% if app_name == 'revision' and not study_mode %}active{% endif %}">
                <i class="bi bi-stack me-1"></i>
                Mes Decks
            </a>
            <a href="{% url 'revision_web:explore' %}" 
               class="nav-tab {% if view_type == 'explore' %}active{% endif %}">
                <i class="bi bi-globe2 me-1"></i>
                Explorer
            </a>
        </div>
        
        <!-- Refresh -->
        <button id="refreshDecks" class="btn btn-outline-custom btn-sm">
            <i class="bi bi-arrow-clockwise"></i>
            <span class="d-none d-xl-inline ms-1">Actualiser</span>
        </button>
    </div>
    
    <!-- Centre: Statistiques compactes -->
    <div class="d-none d-lg-flex align-items-center gap-3">
        <div class="d-flex align-items-center gap-2 text-sm">
            <span id="totalDecks" class="fw-semibold text-primary">0</span>
            <span class="text-muted">Decks</span>
        </div>
        <div class="d-flex align-items-center gap-2 text-sm">
            <span id="totalCards" class="fw-semibold text-primary">0</span>
            <span class="text-muted">Cartes</span>
        </div>
        <div class="d-flex align-items-center gap-2 text-sm">
            <span id="totalLearned" class="fw-semibold text-success">0</span>
            <span class="text-muted">Apprises</span>
        </div>
        <div class="d-flex align-items-center gap-2 text-sm">
            <span id="completionRate" class="fw-semibold text-warning">0%</span>
            <span class="text-muted">Progression</span>
        </div>
    </div>
    
    <!-- Droite: Actions et filtres -->
    <div class="d-flex align-items-center gap-2">
        <!-- Filtres compacts -->
        <input type="text" id="searchInput" class="form-control form-control-sm" 
               style="width: 200px;" placeholder="Rechercher...">
        
        <select id="statusFilter" class="form-select form-select-sm" style="width: auto;">
            <option value="">Tous les statuts</option>
            <option value="active">Actifs</option>
            <option value="archived">Archiv√©s</option>
        </select>
        
        <select id="sortFilter" class="form-select form-select-sm" style="width: auto;">
            <option value="updated_desc">Plus r√©cents</option>
            <option value="name_asc">A-Z</option>
            <option value="progress_desc">Progression</option>
        </select>
        
        <!-- Actions -->
        <button id="importDeck" class="btn btn-outline-custom btn-sm">
            <i class="bi bi-upload"></i>
            <span class="d-none d-xl-inline ms-1">Importer</span>
        </button>
        
        <button id="createDeck" class="btn btn-gradient btn-sm">
            <i class="bi bi-plus-lg"></i>
            <span class="d-none d-xl-inline ms-1">Nouveau deck</span>
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Sidebar -->
<div id="revisionSidebar" class="revision-sidebar">
    <div class="sidebar-content">
        <!-- Decks list -->
        <ul id="decksList" class="deck-list"></ul>
        
        <!-- Empty state -->
        <div id="decksEmpty" class="empty-state" style="display: none;">
            <i class="bi bi-stack empty-state-icon"></i>
            <div class="empty-state-title">Aucun deck</div>
            <div class="empty-state-description">Cr√©ez votre premier deck de flashcards pour commencer √† r√©viser</div>
            <button class="btn btn-gradient create-deck-btn">
                <i class="bi bi-plus-lg me-1"></i>
                Cr√©er un deck
            </button>
        </div>
        
        <!-- Load more -->
        <div id="loadMoreContainer" class="p-3 text-center" style="display: none;">
            <button id="loadMoreBtn" class="btn btn-outline-custom">
                <i class="bi bi-arrow-down-circle me-1"></i>
                Charger plus
            </button>
        </div>
    </div>
</div>

<!-- Study Area -->
<div class="revision-study">
    <!-- Welcome state -->
    <div id="welcomeState" class="empty-state">
        <i class="bi bi-lightning-charge empty-state-icon"></i>
        <div class="empty-state-title">Bienvenue dans votre espace de r√©vision</div>
        <div class="empty-state-description">
            S√©lectionnez un deck dans la liste ou cr√©ez-en un nouveau pour commencer √† r√©viser avec les flashcards
        </div>
        <div class="d-flex gap-2 justify-content-center">
            <button class="btn btn-gradient create-deck-btn">
                <i class="bi bi-plus-lg me-1"></i>
                Cr√©er un deck
            </button>
            <a href="{% url 'revision_web:explore' %}" class="btn btn-outline-custom">
                <i class="bi bi-globe2 me-1"></i>
                Explorer les decks publics
            </a>
        </div>
    </div>
    
    <!-- Deck Details -->
    <div id="deckDetails" style="display: none;">
        <!-- Deck Header -->
        <div class="study-header">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2">
                    <button id="backToList" class="btn btn-outline-custom btn-sm d-md-none">
                        <i class="bi bi-arrow-left"></i>
                    </button>
                    <div>
                        <h4 id="deckName" class="mb-0">Nom du deck</h4>
                        <small id="deckDescription" class="text-muted">Description du deck</small>
                    </div>
                </div>
                
                <div class="d-flex align-items-center gap-2">
                    <!-- Progression -->
                    <div class="d-flex align-items-center gap-2 me-3 d-none d-md-flex">
                        <span id="deckProgress" class="badge deck-badge">0/0</span>
                        <div class="progress-bar-custom">
                            <div id="deckProgressBar" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <button id="addCard" class="btn btn-outline-custom btn-sm">
                        <i class="bi bi-plus-lg"></i>
                        <span class="d-none d-md-inline ms-1">Ajouter carte</span>
                    </button>
                    
                    <div class="dropdown">
                        <button class="btn btn-outline-custom btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" id="editDeck">
                                <i class="bi bi-pencil me-2"></i>Modifier le deck
                            </a></li>
                            <li><a class="dropdown-item" href="#" id="exportDeck">
                                <i class="bi bi-download me-2"></i>Exporter
                            </a></li>
                            <li><a class="dropdown-item" href="#" id="shareDeck">
                                <i class="bi bi-share me-2"></i>Partager
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="archiveDeck">
                                <i class="bi bi-archive me-2"></i>Archiver
                            </a></li>
                            <li><a class="dropdown-item text-danger" href="#" id="deleteDeck">
                                <i class="bi bi-trash me-2"></i>Supprimer
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Study Modes -->
        <div class="study-content">
            <div class="study-modes">
                <a href="#" class="study-mode-card" id="studyFlashcards">
                    <span class="study-mode-icon">üîÑ</span>
                    <div class="study-mode-title">Flashcards</div>
                    <div class="study-mode-description">
                        R√©visez avec les cartes traditionnelles. Id√©al pour m√©moriser le vocabulaire et les concepts.
                    </div>
                </a>
                
                <a href="#" class="study-mode-card" id="studyLearn">
                    <span class="study-mode-icon">üéØ</span>
                    <div class="study-mode-title">Apprendre</div>
                    <div class="study-mode-description">
                        Mode questionnaire √† choix multiples pour tester vos connaissances de fa√ßon interactive.
                    </div>
                </a>
                
                <a href="#" class="study-mode-card" id="studyMatch">
                    <span class="study-mode-icon">üß©</span>
                    <div class="study-mode-title">Associer</div>
                    <div class="study-mode-description">
                        Jeu de m√©moire pour associer les termes et d√©finitions. Parfait pour s'amuser en apprenant.
                    </div>
                </a>
                
                <a href="#" class="study-mode-card" id="studyReview">
                    <span class="study-mode-icon">‚ö°</span>
                    <div class="study-mode-title">R√©vision rapide</div>
                    <div class="study-mode-description">
                        R√©vision √©clair des cartes que vous devez revoir selon l'algorithme de r√©p√©tition espac√©e.
                    </div>
                </a>
            </div>
            
            <!-- Quick actions -->
            <div class="p-3 border-top">
                <div class="row g-2">
                    <div class="col-md-4">
                        <button id="viewAllCards" class="btn btn-outline-custom w-100">
                            <i class="bi bi-list-ul me-1"></i>
                            Voir toutes les cartes
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button id="practiceWeak" class="btn btn-outline-custom w-100">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            R√©viser les difficiles
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button id="resetProgress" class="btn btn-outline-custom w-100">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            R√©initialiser progr√®s
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Deck Form -->
    <div id="createDeckForm" style="display: none;">
        <div class="study-header">
            <div class="d-flex align-items-center justify-content-between">
                <h5 class="mb-0">Cr√©er un nouveau deck</h5>
                <button id="cancelCreate" class="btn btn-outline-custom btn-sm">
                    <i class="bi bi-x-lg"></i>
                    Annuler
                </button>
            </div>
        </div>
        
        <div class="study-content p-4">
            <div class="row g-3">
                <div class="col-md-8">
                    <label class="form-label">Nom du deck <span class="text-danger">*</span></label>
                    <input type="text" id="newDeckName" class="form-control" placeholder="Ex: Vocabulaire anglais niveau B2" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Visibilit√©</label>
                    <select id="newDeckVisibility" class="form-select">
                        <option value="private">Priv√©</option>
                        <option value="public">Public</option>
                    </select>
                </div>
            </div>
            
            <div class="mt-3">
                <label class="form-label">Description</label>
                <textarea id="newDeckDescription" class="form-control" rows="3" 
                          placeholder="D√©crivez bri√®vement le contenu de ce deck..."></textarea>
            </div>
            
            <div class="mt-4">
                <button id="submitCreate" class="btn btn-gradient me-2">
                    <i class="bi bi-plus-lg me-1"></i>
                    Cr√©er le deck
                </button>
                <button id="cancelCreateAlt" class="btn btn-outline-custom">
                    Annuler
                </button>
            </div>
        </div>
    </div>
    
    <!-- View All Cards -->
    <div id="viewAllCardsSection" style="display: none;">
        <div class="study-header">
            <div class="d-flex align-items-center justify-content-between">
                <h5 class="mb-0">Toutes les cartes - <span id="deckNameInCards"></span></h5>
                <button id="backToDeckView" class="btn btn-outline-custom btn-sm">
                    <i class="bi bi-arrow-left"></i>
                    Retour au deck
                </button>
            </div>
        </div>
        
        <div class="study-content p-4">
            <div id="cardsContainer">
                <!-- Cards will be loaded here -->
            </div>
            
            <div id="noCardsMessage" class="text-center p-4" style="display: none;">
                <i class="bi bi-stack text-muted" style="font-size: 3rem;"></i>
                <h5 class="text-muted mt-3">Aucune carte dans ce deck</h5>
                <p class="text-muted">Commencez par ajouter quelques cartes pour r√©viser !</p>
                <button class="btn btn-gradient" onclick="window.revisionMain.showCreateCardForm()">
                    <i class="bi bi-plus-lg me-1"></i>
                    Ajouter une carte
                </button>
            </div>
        </div>
    </div>
    
    <!-- Create Card Form -->
    <div id="createCardForm" style="display: none;">
        <div class="study-header">
            <div class="d-flex align-items-center justify-content-between">
                <h5 class="mb-0">Ajouter une nouvelle carte</h5>
                <button id="cancelCardCreate" class="btn btn-outline-custom btn-sm">
                    <i class="bi bi-x-lg"></i>
                    Annuler
                </button>
            </div>
        </div>
        
        <div class="study-content p-4">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Recto (Question) <span class="text-danger">*</span></label>
                    <textarea id="newCardFront" class="form-control" rows="4" 
                              placeholder="Ex: Comment dit-on 'bonjour' en anglais ?" required></textarea>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Verso (R√©ponse) <span class="text-danger">*</span></label>
                    <textarea id="newCardBack" class="form-control" rows="4" 
                              placeholder="Ex: Hello" required></textarea>
                </div>
            </div>
            
            <div class="mt-4">
                <button id="submitCardCreate" class="btn btn-gradient me-2">
                    <i class="bi bi-plus-lg me-1"></i>
                    Ajouter la carte
                </button>
                <button id="cancelCardCreateAlt" class="btn btn-outline-custom">
                    Annuler
                </button>
            </div>
        </div>
    </div>
    
    <!-- Edit Card Form -->
    <div id="editCardForm" style="display: none;">
        <div class="study-header">
            <div class="d-flex align-items-center justify-content-between">
                <h5 class="mb-0">Modifier la carte</h5>
                <button id="cancelCardEdit" class="btn btn-outline-custom btn-sm">
                    <i class="bi bi-x-lg"></i>
                    Annuler
                </button>
            </div>
        </div>
        
        <div class="study-content p-4">
            <input type="hidden" id="editCardId" value="">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Recto (Question) <span class="text-danger">*</span></label>
                    <textarea id="editCardFront" class="form-control" rows="4" required></textarea>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Verso (R√©ponse) <span class="text-danger">*</span></label>
                    <textarea id="editCardBack" class="form-control" rows="4" required></textarea>
                </div>
            </div>
            
            <div class="mt-4">
                <button id="submitCardEdit" class="btn btn-gradient me-2">
                    <i class="bi bi-check-lg me-1"></i>
                    Enregistrer les modifications
                </button>
                <button id="cancelCardEditAlt" class="btn btn-outline-custom">
                    Annuler
                </button>
            </div>
        </div>
    </div>
    
    <!-- Import Deck Form -->
    <div id="importDeckForm" style="display: none;">
        <div class="study-header">
            <div class="d-flex align-items-center justify-content-between">
                <h5 class="mb-0">Importer un deck</h5>
                <button id="cancelImport" class="btn btn-outline-custom btn-sm">
                    <i class="bi bi-x-lg"></i>
                    Annuler
                </button>
            </div>
        </div>
        
        <div class="study-content p-4">
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                Vous pouvez importer des fichiers CSV ou Excel avec les colonnes : <strong>Terme</strong>, <strong>D√©finition</strong>, <strong>Exemple (optionnel)</strong>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Fichier √† importer</label>
                <input type="file" id="importFile" class="form-control" accept=".csv,.xlsx,.xls">
            </div>
            
            <div class="mb-3">
                <label class="form-label">Nom du deck</label>
                <input type="text" id="importDeckName" class="form-control" placeholder="Nom pour le deck import√©">
            </div>
            
            <div class="mt-4">
                <button id="submitImport" class="btn btn-gradient me-2">
                    <i class="bi bi-upload me-1"></i>
                    Importer le deck
                </button>
                <button id="cancelImportAlt" class="btn btn-outline-custom">
                    Annuler
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- CSRF Token for API calls -->
{% csrf_token %}

<!-- Charger le JavaScript modulaire -->
<script src="{% static 'src/js/revision-main.js' %}"></script>

<script>
// Le JavaScript principal est maintenant dans revision-main.js
// Il s'initialise automatiquement au chargement de la page

// Exporter selectDeck pour les √©v√©nements inline
window.selectDeck = window.revisionMain.selectDeck;
</script>
{% endblock %}
{% extends "saas_web/base.html" %}
{% load i18n static %}

{% block title %}{{ group.name }} | Open Linguify{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'community/css/community-clean.css' %}">
<link rel="stylesheet" href="{% static 'community/css/navbar_community.css' %}">
<link rel="stylesheet" href="{% static 'community/css/group_detail_linguify.css' %}">
{% endblock %}

{% block content %}
<div class="community-page">
    <div class="community-container">
        <!-- Header avec navbar intégrée -->
        <div class="community-header">
            <!-- Navigation unifiée -->
            {% include 'community/components/navbar.html' %}
        </div>

        <!-- Main scrollable content -->
        <div class="community-main">
            
            <!-- En-tête du groupe - Style Navbar -->
            <div class="group-navbar-container d-flex align-items-center justify-content-between gap-3">
                <!-- Gauche: Info groupe compacte -->
                <div class="d-flex align-items-center gap-3">
                    <!-- Avatar du groupe -->
                    <div class="group-avatar-display">
                        {% if group.avatar %}
                        <img src="{{ group.avatar.url }}" alt="{{ group.name }}" class="group-avatar-img">
                        {% else %}
                        <div class="group-avatar-placeholder-small">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Nom du groupe -->
                    <div class="group-name-section">
                        <h2 class="group-name-compact">{{ group.name }}</h2>
                    </div>
                    
                    <!-- Badges info compacts -->
                    <div class="d-flex align-items-center gap-2">
                        {% if group.language %}
                        <div class="group-info-badge language">
                            <i class="bi bi-translate me-1"></i>
                            {{ group.get_language_display }}
                        </div>
                        {% endif %}
                        
                        {% if group.level %}
                        <div class="group-info-badge level">
                            <i class="bi bi-award me-1"></i>
                            {{ group.get_level_display }}
                        </div>
                        {% endif %}
                        
                        {% if group.group_type %}
                        <div class="group-info-badge type">
                            <i class="bi bi-bookmark me-1"></i>
                            {{ group.get_group_type_display }}
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if group.description %}
                    <div class="group-description-compact">
                        {{ group.description|truncatewords:8 }}
                    </div>
                    {% endif %}
                </div>
                
                <!-- Droite: Stats + Actions -->
                <div class="d-flex align-items-center gap-2 flex-nowrap">
                    <!-- Stats compactes -->
                    <div class="group-stats-compact d-flex align-items-center gap-3">
                        <div class="stat-compact">
                            <span class="stat-number-compact">{{ members_count }}</span>
                            <span class="stat-label-compact">{% trans "members" %}</span>
                        </div>
                        <div class="stat-compact">
                            <span class="stat-number-compact">{{ online_members.count }}</span>
                            <span class="stat-label-compact">{% trans "online" %}</span>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    {% if is_creator or is_moderator %}
                    <a href="{% url 'community:group_manage' group.id %}" class="btn-outline-custom btn-sm">
                        <i class="bi bi-gear"></i>
                        <span class="d-none d-xl-inline ms-1">{% trans "Manage" %}</span>
                    </a>
                    {% endif %}
                    
                    <button class="btn-gradient btn-sm px-2" id="inviteBtn">
                        <i class="bi bi-person-plus"></i>
                        <span class="d-none d-xl-inline ms-1">{% trans "Invite" %}</span>
                    </button>
                </div>
            </div>

            <!-- Layout en 2 colonnes pour le chat -->
            <div class="group-chat-main">
                <!-- 💬 CHAT PRINCIPAL -->
                <div class="chat-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="bi bi-chat-dots me-2"></i>
                            {% trans "Group Chat" %}
                        </h3>
                        <div class="chat-options">
                            <button class="btn-simple btn-sm btn-secondary" id="testClaudeBtn" title="{% trans 'Test with Claude AI' %}">
                                <i class="bi bi-robot me-1"></i>{% trans "AI Test" %}
                            </button>
                        </div>
                    </div>
                    
                    <div class="section-content">
                        <!-- Messages -->
                        <div class="messages-area" id="messagesArea">
                            <!-- Vrais messages de la base de données -->
                            {% for message in recent_messages reversed %}
                            <div class="message {% if message.sender.user == user %}message-own{% else %}message-other{% endif %}">
                                <div class="message-avatar">
                                    {% if message.sender.user.profile_picture %}
                                    <img src="{{ message.sender.user.profile_picture.url }}" alt="{{ message.sender.user.username }}" class="user-avatar-img">
                                    {% elif message.sender.avatar %}
                                    <img src="{{ message.sender.avatar.url }}" alt="{{ message.sender.user.username }}" class="user-avatar-img">
                                    {% else %}
                                    {{ message.sender.user.username.0|upper }}
                                    {% endif %}
                                </div>
                                <div class="message-content">
                                    <div class="message-header">
                                        <strong>{{ message.sender.user.get_full_name|default:message.sender.user.username }}</strong>
                                        <span class="message-time">{{ message.timestamp|timesince }} ago</span>
                                    </div>
                                    <div class="message-text">{{ message.message }}</div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="empty-state">
                                <i class="bi bi-chat large-icon"></i>
                                <p>{% trans "No messages yet. Be the first to say hello!" %}</p>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Input -->
                        <div class="chat-input">
                            <input type="file" id="photoInput" accept="image/*" style="display: none;">
                            <div class="input-area">
                                <textarea id="messageInput" 
                                          placeholder="{% trans 'Type your message...' %}" 
                                          rows="2" class="form-control"></textarea>
                                <div class="input-actions">
                                    <button class="btn-icon" id="photoBtn" title="{% trans 'Add Photo' %}">
                                        <i class="bi bi-image"></i>
                                    </button>
                                    <button class="btn-simple btn-sm" id="sendBtn">
                                        <i class="bi bi-send me-1"></i>{% trans "Send" %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 👥 SIDEBAR MEMBRES -->
                <div class="members-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="bi bi-people me-2"></i>
                            {% trans "Online" %} ({{ online_members.count }})
                        </h3>
                    </div>
                    
                    <div class="section-content">
                        <div class="members-list">
                            {% for member in online_members %}
                            <div class="member-item">
                                <div class="member-avatar">
                                    {% if member.user.profile_picture %}
                                    <img src="{{ member.user.profile_picture.url }}" alt="{{ member.user.username }}" class="user-avatar-img">
                                    {% elif member.avatar %}
                                    <img src="{{ member.avatar.url }}" alt="{{ member.user.username }}" class="user-avatar-img">
                                    {% else %}
                                    {{ member.user.first_name.0|upper|default:member.user.username.0|upper }}
                                    {% endif %}
                                </div>
                                <div class="member-info">
                                    <div class="member-name">
                                        {{ member.user.get_full_name|default:member.user.username }}
                                    </div>
                                    <div class="member-status online">
                                        <span class="status-dot"></span>
                                        {% trans "Online" %}
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="empty-state">
                                <i class="bi bi-person-slash large-icon"></i>
                                <p>{% trans "No one online" %}</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        </div> <!-- End community-main -->
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Variables pour l'avatar utilisateur - côté Django
    const currentUserAvatar = `{% if user.profile_picture %}<img src="{{ user.profile_picture.url }}" alt="{{ user.username }}" class="user-avatar-img">{% else %}{{ user.username.0|upper|default:"U" }}{% endif %}`;
    const currentUserName = `{{ user.get_full_name|default:user.username }}`;
    
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const messagesArea = document.getElementById('messagesArea');
    const photoBtn = document.getElementById('photoBtn');
    const photoInput = document.getElementById('photoInput');
    const testClaudeBtn = document.getElementById('testClaudeBtn');
    
    // Envoyer un message (sauvegarde en base de données)
    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;
        
        // Désactiver l'input pendant l'envoi
        messageInput.disabled = true;
        sendBtn.disabled = true;
        
        // Envoyer le message au backend
        fetch('{% url "community:send_group_message" group.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                message: message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Ajouter le message à l'interface avec la classe CSS appropriée
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message message-own'; // Toujours message-own car c'est l'utilisateur actuel qui envoie
                messageDiv.innerHTML = `
                    <div class="message-avatar">
                        ${data.message.sender_avatar_url ? 
                            `<img src="${data.message.sender_avatar_url}" alt="${data.message.sender_name}" class="user-avatar-img">` :
                            currentUserAvatar
                        }
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <strong>${currentUserName}</strong>
                            <span class="message-time">${data.message.time_display}</span>
                        </div>
                        <div class="message-text">${data.message.message}</div>
                    </div>
                `;
                
                messagesArea.appendChild(messageDiv);
                messagesArea.scrollTop = messagesArea.scrollHeight;
                
                // Vider l'input
                messageInput.value = '';
            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de l\'envoi du message');
        })
        .finally(() => {
            // Réactiver l'input
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();
        });
    }
    
    // Fonction pour récupérer le cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Event listeners
    sendBtn.addEventListener('click', sendMessage);
    
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Partage de photo
    photoBtn.addEventListener('click', function() {
        photoInput.click();
    });
    
    photoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message message-own'; // Message de l'utilisateur actuel
                messageDiv.innerHTML = `
                    <div class="message-avatar">
                        ${currentUserAvatar}
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <strong>${currentUserName}</strong>
                            <span class="message-time">{% trans "now" %}</span>
                        </div>
                        <div class="message-photo">
                            <img src="${e.target.result}" alt="Photo partagée" style="max-width: 200px; border-radius: 8px;">
                        </div>
                    </div>
                `;
                
                messagesArea.appendChild(messageDiv);
                messagesArea.scrollTop = messagesArea.scrollHeight;
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Test avec Claude AI
    testClaudeBtn.addEventListener('click', function() {
        const testMessages = [
            {
                text: "Bonjour ! Je suis Claude, votre assistant IA. Comment puis-je vous aider avec l'apprentissage des langues ?",
                type: "claude"
            },
            {
                text: "Vous pouvez me poser des questions sur la grammaire, demander des traductions, ou pratiquer une conversation !",
                type: "claude"
            }
        ];
        
        testMessages.forEach((msg, index) => {
            setTimeout(() => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message message-other'; // Message des autres (Claude AI)
                messageDiv.innerHTML = `
                    <div class="message-avatar" style="background: linear-gradient(135deg, #10b981, #059669);">🤖</div>
                    <div class="message-content">
                        <div class="message-header">
                            <strong>Claude AI</strong>
                            <span class="message-time">{% trans "now" %}</span>
                        </div>
                        <div class="message-text">${msg.text}</div>
                    </div>
                `;
                
                messagesArea.appendChild(messageDiv);
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }, index * 1000);
        });
        
        // Ajouter un message d'explication
        setTimeout(() => {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message message-other'; // Message système (pas de l'utilisateur)
            messageDiv.innerHTML = `
                <div class="message-avatar" style="background: linear-gradient(135deg, #f59e0b, #d97706);">ℹ️</div>
                <div class="message-content">
                    <div class="message-header">
                        <strong>Système</strong>
                        <span class="message-time">{% trans "now" %}</span>
                    </div>
                    <div class="message-text">
                        <em>Ceci est une simulation. Dans la vraie version, Claude AI pourrait répondre automatiquement à vos messages pour vous aider à apprendre !</em>
                    </div>
                </div>
            `;
            
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }, 2500);
    });
});
</script>
{% endblock %}
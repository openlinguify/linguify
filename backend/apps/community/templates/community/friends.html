{% extends "saas_web/base.html" %}
{% load i18n static %}

{% block title %}{% trans "My Friends" %} | Open Linguify{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'community/css/community-clean.css' %}">
<link rel="stylesheet" href="{% static 'community/css/navbar_community.css' %}">
<link rel="stylesheet" href="{% static 'community/css/friends_page.css' %}">
{% endblock %}

{% block content %}
<div class="community-page">
    <div class="community-container">
        <!-- Header avec navbar intégrée -->
        <div class="community-header">
            <!-- Navigation unifiée -->
            {% include 'community/components/navbar.html' %}
        </div>

        <!-- Main scrollable content -->
        <div class="community-main">

        <!-- Tabs Navigation -->
        <div class="tabs-nav">
            <button class="tab-button active" data-tab="friends">
                <i class="bi bi-people me-1"></i>
                {% trans "All Friends" %} ({{ friends.count }})
            </button>
            <button class="tab-button" data-tab="requests">
                <i class="bi bi-envelope me-1"></i>
                {% trans "Friend Requests" %} ({{ pending_requests.count }})
            </button>
            <button class="tab-button" data-tab="sent">
                <i class="bi bi-send me-1"></i>
                {% trans "Sent Requests" %} ({{ sent_requests.count }})
            </button>
            <button class="tab-button" data-tab="online">
                <i class="bi bi-circle-fill text-success me-1"></i>
                {% trans "Online" %} ({{ online_friends_count }})
            </button>
        </div>

        <!-- Tab: All Friends -->
        <div class="tab-content active" id="friends">
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">{% trans "All Friends" %}</h3>
                    <div class="d-flex gap-2">
                        <input type="text" class="form-control search-input-friends" placeholder="{% trans 'Search friends...' %}">
                        <button class="btn-simple btn-secondary">
                            <i class="bi bi-funnel"></i>
                        </button>
                    </div>
                </div>
                <div class="section-content">
                    <div class="user-grid">
                        {% for friend in friends %}
                        <div class="user-card">
                            <div class="user-header">
                                <div class="user-avatar">
                                    {{ friend.user.first_name.0|upper|default:friend.user.username.0|upper }}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">{{ friend.user.get_full_name|default:friend.user.username }}</div>
                                    <div class="friend-status {% if friend.is_online %}online{% else %}offline{% endif %}">
                                        <span class="{% if friend.is_online %}online{% else %}offline{% endif %}-indicator"></span>
                                        {% if friend.is_online %}{% trans "Online" %}{% else %}{% trans "Offline" %}{% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="user-languages">
                                {% if friend.user.native_language %}
                                <span class="language-tag native">{{ friend.user.get_native_language_display }}</span>
                                {% endif %}
                                {% if friend.user.target_language %}
                                <span class="language-tag learning">{{ friend.user.get_target_language_display }}</span>
                                {% endif %}
                            </div>
                            
                            <div class="friend-actions">
                                <button class="btn-simple btn-sm">
                                    <i class="bi bi-chat-dots me-1"></i>
                                    {% trans "Message" %}
                                </button>
                                <button class="btn-simple btn-secondary btn-sm">
                                    <i class="bi bi-person-x me-1"></i>
                                    {% trans "Remove" %}
                                </button>
                            </div>
                        </div>
                        {% empty %}
                        <div class="empty-state">
                            <i class="bi bi-people large-icon"></i>
                            <h4>{% trans "No friends yet" %}</h4>
                            <p>{% trans "Start connecting with language partners!" %}</p>
                            <a href="{% url 'community:discover' %}" class="btn-simple">
                                <i class="bi bi-search me-1"></i>
                                {% trans "Discover Users" %}
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Friend Requests -->
        <div class="tab-content" id="requests">
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">{% trans "Friend Requests" %}</h3>
                </div>
                <div class="section-content">
                    <div class="user-grid">
                        {% for request in pending_requests %}
                        <div class="user-card friend-request-card">
                            <div class="user-header">
                                <div class="user-avatar">
                                    {{ request.sender.first_name.0|upper|default:request.sender.username.0|upper }}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">{{ request.sender.get_full_name|default:request.sender.username }}</div>
                                    <div class="user-info-meta">
                                        {{ request.created_at|timesince }} ago
                                    </div>
                                </div>
                            </div>
                            
                            <div class="user-languages">
                                {% if request.sender.native_language %}
                                <span class="language-tag native">{{ request.sender.get_native_language_display }}</span>
                                {% endif %}
                                {% if request.sender.target_language %}
                                <span class="language-tag learning">{{ request.sender.get_target_language_display }}</span>
                                {% endif %}
                            </div>
                            
                            {% if request.sender.profile.bio %}
                            <div class="user-bio">
                                "{{ request.sender.profile.bio|truncatewords:25 }}"
                            </div>
                            {% endif %}
                            
                            <div class="friend-actions">
                                <button class="btn-simple btn-sm accept-request" data-request-id="{{ request.id }}">
                                    <i class="bi bi-check-lg me-1"></i>
                                    {% trans "Accept" %}
                                </button>
                                <button class="btn-simple btn-secondary btn-sm decline-request" data-request-id="{{ request.id }}">
                                    <i class="bi bi-x-lg me-1"></i>
                                    {% trans "Decline" %}
                                </button>
                            </div>
                        </div>
                        {% empty %}
                        <div class="empty-state">
                            <i class="bi bi-envelope large-icon"></i>
                            <h4>{% trans "No pending requests" %}</h4>
                            <p>{% trans "You don't have any friend requests at the moment." %}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Sent Requests -->
        <div class="tab-content" id="sent">
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">{% trans "Sent Requests" %}</h3>
                </div>
                <div class="section-content">
                    <div class="user-grid">
                        {% for request in sent_requests %}
                        <div class="user-card">
                            <div class="user-header">
                                <div class="user-avatar">
                                    {{ request.receiver.first_name.0|upper|default:request.receiver.username.0|upper }}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">{{ request.receiver.get_full_name|default:request.receiver.username }}</div>
                                    <div class="user-info-meta">
                                        Sent {{ request.created_at|timesince }} ago
                                    </div>
                                </div>
                            </div>
                            
                            <div class="user-languages">
                                {% if request.receiver.native_language %}
                                <span class="language-tag native">{{ request.receiver.get_native_language_display }}</span>
                                {% endif %}
                                {% if request.receiver.target_language %}
                                <span class="language-tag learning">{{ request.receiver.get_target_language_display }}</span>
                                {% endif %}
                            </div>
                            
                            <div class="friend-actions">
                                <button class="btn-simple btn-secondary btn-sm cancel-request" data-request-id="{{ request.id }}">
                                    <i class="bi bi-x-circle me-1"></i>
                                    {% trans "Cancel Request" %}
                                </button>
                            </div>
                        </div>
                        {% empty %}
                        <div class="empty-state">
                            <i class="bi bi-send large-icon"></i>
                            <h4>{% trans "No sent requests" %}</h4>
                            <p>{% trans "You haven't sent any friend requests yet." %}</p>
                            <a href="{% url 'community:discover' %}" class="btn-simple">
                                <i class="bi bi-search me-1"></i>
                                {% trans "Discover Users" %}
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Online Friends -->
        <div class="tab-content" id="online">
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">{% trans "Friends Online" %}</h3>
                </div>
                <div class="section-content">
                    <div class="user-grid">
                        {% for friend in friends %}
                            {% if friend.is_online %}
                            <div class="user-card">
                                <div class="user-header">
                                    <div class="user-avatar">
                                        {{ friend.user.first_name.0|upper|default:friend.user.username.0|upper }}
                                    </div>
                                    <div class="user-info">
                                        <div class="user-name">{{ friend.user.get_full_name|default:friend.user.username }}</div>
                                        <div class="friend-status online">
                                            <span class="online-indicator"></span>
                                            {% trans "Online" %} • {% trans "Active now" %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="user-languages">
                                    {% if friend.user.native_language %}
                                    <span class="language-tag native">{{ friend.user.get_native_language_display }}</span>
                                    {% endif %}
                                    {% if friend.user.target_language %}
                                    <span class="language-tag learning">{{ friend.user.get_target_language_display }}</span>
                                    {% endif %}
                                </div>
                                
                                <div class="friend-actions">
                                    <button class="btn-simple btn-sm">
                                        <i class="bi bi-chat-dots me-1"></i>
                                        {% trans "Start Chat" %}
                                    </button>
                                    <button class="btn-simple btn-secondary btn-sm">
                                        <i class="bi bi-video me-1"></i>
                                        {% trans "Video Call" %}
                                    </button>
                                </div>
                            </div>
                            {% endif %}
                        {% empty %}
                        <div class="empty-state">
                            <i class="bi bi-wifi-off large-icon"></i>
                            <h4>{% trans "No friends online" %}</h4>
                            <p>{% trans "None of your friends are currently online." %}</p>
                        </div>
                        {% endfor %}
                        
                        {% if not friends %}
                        <div class="empty-state">
                            <i class="bi bi-people large-icon"></i>
                            <h4>{% trans "No friends yet" %}</h4>
                            <p>{% trans "Add some friends to see who's online!" %}</p>
                            <a href="{% url 'community:discover' %}" class="btn-simple">
                                <i class="bi bi-search me-1"></i>
                                {% trans "Discover Users" %}
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        </div> <!-- End community-main -->
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab functionality
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.dataset.tab;
            
            // Remove active from all tabs and contents
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active to clicked tab and corresponding content
            this.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        });
    });
    
    // Accept friend request
    document.querySelectorAll('.accept-request').forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.dataset.userId;
            this.innerHTML = '<i class="bi bi-check me-1"></i>{% trans "Accepted" %}';
            this.classList.add('btn-success');
            this.disabled = true;
            
            // Hide decline button
            this.parentElement.querySelector('.decline-request').style.display = 'none';
        });
    });
    
    // Decline friend request
    document.querySelectorAll('.decline-request').forEach(button => {
        button.addEventListener('click', function() {
            const card = this.closest('.user-card');
            card.style.transition = 'all 0.3s ease';
            card.style.opacity = '0';
            card.style.transform = 'translateX(-20px)';
            
            setTimeout(() => {
                card.remove();
            }, 300);
        });
    });
    
    // Cancel sent request
    document.querySelectorAll('.cancel-request').forEach(button => {
        button.addEventListener('click', function() {
            const card = this.closest('.user-card');
            card.style.transition = 'all 0.3s ease';
            card.style.opacity = '0';
            card.style.transform = 'translateX(-20px)';
            
            setTimeout(() => {
                card.remove();
            }, 300);
        });
    });
});
</script>
{% endblock %}
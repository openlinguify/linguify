{% extends "saas_web/base.html" %}
{% load i18n static %}

{% block title %}{% trans "Community" %} | Open Linguify{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'community/css/community-clean.css' %}">
<link rel="stylesheet" href="{% static 'community/css/navbar_community.css' %}">
<link rel="stylesheet" href="{% static 'community/css/main_page.css' %}">
{% endblock %}

{% block content %}
<div class="community-page">
    <div class="community-container">
        <!-- Header avec navbar intÃ©grÃ©e -->
        <div class="community-header">
            <!-- Navigation unifiÃ©e -->
            {% include 'community/components/navbar.html' %}
        </div>

        <!-- Main scrollable content -->
        <div class="community-main">

        <!-- Show discovery banner for users with few friends -->
        {% if friends_count < 5 and not is_new_user %}
            {% include 'community/partials/friend_discovery_banner.html' %}
        {% endif %}

        <!-- Show onboarding for new users -->
        {% if is_new_user %}
            {% include 'community/partials/empty_state_new_user.html' %}
        {% else %}
        <!-- Community Feed -->
        <div class="main-content">
            <div class="row">
                <!-- Feed principal -->
                <div class="col-lg-12">
                    <div class="section">
                        <div class="section-header">
                            <h3 class="section-title">
                                <i class="bi bi-rss me-2"></i>
                                {% trans "Community Feed" %}
                            </h3>
                            <button class="btn-simple btn-sm" data-bs-toggle="modal" data-bs-target="#createPostModal">
                                <i class="bi bi-plus me-1"></i>
                                {% trans "Create Post" %}
                            </button>
                        </div>
                        <div class="section-content">
                            <div class="feed-container">
                                <!-- Posts du feed -->
                                {% if recent_posts %}
                                    {% for post in recent_posts %}
                                    <div class="post-card">
                                        <div class="post-header">
                                            <div class="post-user">
                                                <div class="post-avatar">
                                                    {{ post.author.first_name.0|upper|default:post.author.username.0|upper }}
                                                </div>
                                                <div class="post-user-info">
                                                    <div class="post-username">{{ post.author.get_full_name|default:post.author.username }}</div>
                                                    <div class="post-time">{{ post.created_at|timesince }} ago</div>
                                                </div>
                                            </div>
                                            {% if post.author.native_language %}
                                            <div class="post-language">
                                                <span class="language-badge">{{ post.author.get_native_language_display }}</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="post-content">
                                            <p>{{ post.content }}</p>
                                        </div>
                                        
                                        <div class="post-actions">
                                            <button class="post-action-btn like-btn" data-post-id="{{ post.id }}">
                                                <i class="bi bi-heart"></i>
                                                <span>{{ post.likes.count }}</span>
                                            </button>
                                            <button class="post-action-btn comment-btn">
                                                <i class="bi bi-chat"></i>
                                                <span>{{ post.comments.count }}</span>
                                            </button>
                                            <button class="post-action-btn share-btn">
                                                <i class="bi bi-share"></i>
                                                {% trans "Share" %}
                                            </button>
                                        </div>
                                        
                                        <!-- Commentaires pour le premier post -->
                                        {% if forloop.first %}
                                        <div class="post-comments">
                                            {% for comment in post.comments.all|slice:":2" %}
                                            <div class="comment">
                                                <div class="comment-avatar">{{ comment.author.first_name.0|upper|default:comment.author.username.0|upper }}</div>
                                                <div class="comment-content">
                                                    <div class="comment-user">{{ comment.author.get_full_name|default:comment.author.username }}</div>
                                                    <div class="comment-text">{{ comment.content }}</div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                            <div class="comment-input">
                                                <div class="comment-avatar">{{ user.username.0|upper|default:"U" }}</div>
                                                <input type="text" class="form-control" placeholder="{% trans 'Write a comment...' %}">
                                                <button class="btn-simple btn-sm">{% trans "Post" %}</button>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="empty-state">
                                        <i class="bi bi-chat-square-dots large-icon"></i>
                                        <h4>{% trans "No posts yet" %}</h4>
                                        <p>{% trans "Connect with language partners to see their posts in your feed." %}</p>
                                        <a href="{% url 'community:discover' %}" class="btn-simple">
                                            <i class="bi bi-search me-1"></i>
                                            {% trans "Discover Users" %}
                                        </a>
                                    </div>
                                {% endif %}
                                
                                <!-- Load more button -->
                                <div class="text-center mt-3">
                                    <button class="btn-simple btn-secondary" id="loadMorePosts">
                                        <i class="bi bi-arrow-down me-1"></i>
                                        {% trans "Load More Posts" %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Amis suggÃ©rÃ©s -->
        {% if suggested_friends %}
        <div class="section">
            <div class="section-header">
                <h3 class="section-title">{% trans "Suggested Friends" %}</h3>
                <a href="{% url 'community:discover' %}" class="btn-simple btn-secondary">
                    {% trans "See All" %}
                </a>
            </div>
            <div class="section-content">
                <div class="user-grid">
                    {% for user in suggested_friends %}
                    <div class="user-card">
                        <div class="user-header">
                            {% if user.user.get_profile_picture_url %}
                                <img src="{{ user.user.get_profile_picture_url }}" 
                                     alt="{{ user.user.username }}" 
                                     class="user-avatar">
                            {% else %}
                                <div class="user-avatar">
                                    {{ user.user.username|first|upper }}
                                </div>
                            {% endif %}
                            <div class="user-name">{{ user.user.name|default:user.user.username }}</div>
                        </div>
                        
                        <div class="user-languages">
                            <span class="language-tag native">
                                {{ user.user.get_native_language_display|default:"??" }}
                            </span>
                            <span class="language-tag learning">
                                {{ user.user.get_target_language_display|default:"??" }}
                            </span>
                        </div>
                        
                        <button class="btn-simple send-friend-request" data-user-id="{{ user.user.id }}">
                            <i class="bi bi-person-plus me-1"></i>
                            {% trans "Add Friend" %}
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        </div> <!-- End community-main -->
    </div>
</div>

<!-- Modal pour crÃ©er un post -->
<div class="modal fade" id="createPostModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header gradient">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle me-2"></i>
                    {% trans "Share Your Learning Progress" %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createPostForm">
                    <div class="mb-3">
                        <label for="postContent" class="form-label fw-semibold">{% trans "What's on your mind?" %}</label>
                        <textarea class="form-control" id="postContent" rows="4" 
                                  placeholder="{% trans 'Share your learning progress, ask questions, or celebrate achievements...' %}" required></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="postLanguage" class="form-label fw-semibold">{% trans "Language Topic" %}</label>
                                <select class="form-control" id="postLanguage">
                                    <option value="">{% trans "Select language (optional)" %}</option>
                                    <option value="english">ğŸ‡¬ğŸ‡§ English</option>
                                    <option value="french">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                                    <option value="spanish">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                                    <option value="german">ğŸ‡©ğŸ‡ª Deutsch</option>
                                    <option value="italian">ğŸ‡®ğŸ‡¹ Italiano</option>
                                    <option value="portuguese">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
                                    <option value="chinese">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                                    <option value="japanese">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                                    <option value="korean">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="postType" class="form-label fw-semibold">{% trans "Post Type" %}</label>
                                <select class="form-control" id="postType">
                                    <option value="progress">ğŸ¯ {% trans "Progress Update" %}</option>
                                    <option value="question">â“ {% trans "Question/Help" %}</option>
                                    <option value="achievement">ğŸ† {% trans "Achievement" %}</option>
                                    <option value="tip">ğŸ’¡ {% trans "Learning Tip" %}</option>
                                    <option value="motivation">ğŸ’ª {% trans "Motivation" %}</option>
                                    <option value="general">ğŸ’¬ {% trans "General Discussion" %}</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="postTags" class="form-label fw-semibold">{% trans "Tags" %} <small class="text-muted">({% trans "optional" %})</small></label>
                        <input type="text" class="form-control" id="postTags" 
                               placeholder="{% trans 'e.g., #grammar #vocabulary #pronunciation' %}">
                        <small class="form-text text-muted">{% trans "Separate tags with spaces or commas" %}</small>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="allowComments" checked>
                            <label class="form-check-label" for="allowComments">
                                {% trans "Allow comments on this post" %}
                            </label>
                        </div>
                    </div>

                    <div class="post-preview" id="postPreview">
                        <h6>{% trans "Preview:" %}</h6>
                        <div class="preview-card">
                            <div class="post-header">
                                <div class="post-user">
                                    <div class="post-avatar">{{ user.username.0|upper|default:"U" }}</div>
                                    <div class="post-user-info">
                                        <div class="post-username">{{ user.get_full_name|default:user.username }}</div>
                                        <div class="post-time">{% trans "now" %}</div>
                                    </div>
                                </div>
                                <div class="post-language" id="previewLanguage"></div>
                            </div>
                            <div class="post-content">
                                <p id="previewContent"></p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-simple btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn-simple" id="createPostBtn">
                    <i class="bi bi-send me-1"></i>
                    {% trans "Share Post" %}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion des demandes d'amitiÃ©
    document.querySelectorAll('.send-friend-request').forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.dataset.userId;
            
            fetch(`/community/api/send-friend-request/${userId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.innerHTML = '<i class="bi bi-check me-1"></i>{% trans "Request Sent" %}';
                    this.disabled = true;
                    this.classList.add('btn-success');
                } else {
                    alert(data.error || 'Error sending friend request');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error sending friend request');
            });
        });
    });

    // Gestion des likes sur les posts
    document.querySelectorAll('.like-btn').forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.dataset.postId;
            const icon = this.querySelector('i');
            const countSpan = this.querySelector('span');
            let currentCount = parseInt(countSpan.textContent);
            
            // Animation immÃ©diate
            if (icon.classList.contains('bi-heart')) {
                icon.classList.replace('bi-heart', 'bi-heart-fill');
                this.classList.add('liked');
                countSpan.textContent = currentCount + 1;
            } else {
                icon.classList.replace('bi-heart-fill', 'bi-heart');
                this.classList.remove('liked');
                countSpan.textContent = currentCount - 1;
            }
            
            // Simulation d'envoi au serveur
            setTimeout(() => {
                console.log('Like/unlike post:', postId);
            }, 100);
        });
    });

    // Gestion des commentaires
    document.querySelectorAll('.comment-btn').forEach(button => {
        button.addEventListener('click', function() {
            const postCard = this.closest('.post-card');
            let commentsSection = postCard.querySelector('.post-comments');
            
            if (!commentsSection) {
                // CrÃ©er la section commentaires si elle n'existe pas
                commentsSection = document.createElement('div');
                commentsSection.className = 'post-comments';
                commentsSection.innerHTML = `
                    <div class="comment-input">
                        <div class="comment-avatar">{{ user.username.0|upper|default:"U" }}</div>
                        <input type="text" class="form-control" placeholder="{% trans 'Write a comment...' %}">
                        <button class="btn-simple btn-sm">{% trans "Post" %}</button>
                    </div>
                `;
                postCard.appendChild(commentsSection);
            }
            
            commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
            
            if (commentsSection.style.display !== 'none') {
                const input = commentsSection.querySelector('input');
                input.focus();
            }
        });
    });

    // PrÃ©visualisation du post
    const postContentTextarea = document.getElementById('postContent');
    const postLanguageSelect = document.getElementById('postLanguage');
    const previewSection = document.getElementById('postPreview');
    const previewContent = document.getElementById('previewContent');
    const previewLanguage = document.getElementById('previewLanguage');

    function updatePreview() {
        const content = postContentTextarea.value.trim();
        const language = postLanguageSelect.value;
        
        if (content) {
            previewSection.style.display = 'block';
            previewContent.textContent = content;
            
            if (language) {
                const languageOptions = {
                    'english': 'ğŸ‡¬ğŸ‡§ English',
                    'french': 'ğŸ‡«ğŸ‡· FranÃ§ais',
                    'spanish': 'ğŸ‡ªğŸ‡¸ EspaÃ±ol',
                    'german': 'ğŸ‡©ğŸ‡ª Deutsch',
                    'italian': 'ğŸ‡®ğŸ‡¹ Italiano',
                    'portuguese': 'ğŸ‡µğŸ‡¹ PortuguÃªs',
                    'chinese': 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡',
                    'japanese': 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª',
                    'korean': 'ğŸ‡°ğŸ‡· í•œêµ­ì–´'
                };
                previewLanguage.innerHTML = `<span class="language-badge">${languageOptions[language]}</span>`;
            } else {
                previewLanguage.innerHTML = '';
            }
        } else {
            previewSection.style.display = 'none';
        }
    }

    if (postContentTextarea) {
        postContentTextarea.addEventListener('input', updatePreview);
        postLanguageSelect.addEventListener('change', updatePreview);
    }

    // CrÃ©ation de post
    document.getElementById('createPostBtn').addEventListener('click', function() {
        const content = document.getElementById('postContent').value.trim();
        const language = document.getElementById('postLanguage').value;
        const type = document.getElementById('postType').value;
        const tags = document.getElementById('postTags').value.trim();
        
        if (!content) {
            alert('{% trans "Please write something before sharing!" %}');
            return;
        }
        
        const createBtn = this;
        createBtn.disabled = true;
        createBtn.innerHTML = '{% trans "Sharing..." %}';
        
        // Simulation de crÃ©ation de post
        setTimeout(() => {
            alert('{% trans "Post shared successfully!" %}');
            
            // Reset form
            document.getElementById('createPostForm').reset();
            previewSection.style.display = 'none';
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('createPostModal')).hide();
            
            createBtn.disabled = false;
            createBtn.innerHTML = '<i class="bi bi-send me-1"></i>{% trans "Share Post" %}';
            
            // Optionnel: Ajouter le post au feed
            addPostToFeed({
                content: content,
                language: language,
                type: type,
                tags: tags
            });
        }, 1500);
    });

    // Load more posts
    document.getElementById('loadMorePosts').addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<i class="bi bi-arrow-clockwise spin me-1"></i>{% trans "Loading..." %}';
        
        setTimeout(() => {
            alert('{% trans "More posts loaded!" %}');
            this.disabled = false;
            this.innerHTML = '<i class="bi bi-arrow-down me-1"></i>{% trans "Load More Posts" %}';
        }, 1000);
    });
    
    function addPostToFeed(postData) {
        const feedContainer = document.querySelector('.feed-container');
        const newPost = document.createElement('div');
        newPost.className = 'post-card';
        newPost.style.animation = 'slideIn 0.3s ease-out';
        
        const languageDisplay = postData.language ? 
            `<div class="post-language"><span class="language-badge">${document.querySelector('#postLanguage option[value="' + postData.language + '"]').textContent}</span></div>` : '';
        
        newPost.innerHTML = `
            <div class="post-header">
                <div class="post-user">
                    <div class="post-avatar">{{ user.username.0|upper|default:"U" }}</div>
                    <div class="post-user-info">
                        <div class="post-username">{{ user.get_full_name|default:user.username }}</div>
                        <div class="post-time">{% trans "just now" %}</div>
                    </div>
                </div>
                ${languageDisplay}
            </div>
            <div class="post-content">
                <p>${postData.content}</p>
            </div>
            <div class="post-actions">
                <button class="post-action-btn like-btn" data-post-id="new">
                    <i class="bi bi-heart"></i>
                    <span>0</span>
                </button>
                <button class="post-action-btn comment-btn">
                    <i class="bi bi-chat"></i>
                    <span>0</span>
                </button>
                <button class="post-action-btn share-btn">
                    <i class="bi bi-share"></i>
                    {% trans "Share" %}
                </button>
            </div>
        `;
        
        // InsÃ©rer en premier dans le feed
        feedContainer.insertBefore(newPost, feedContainer.firstChild);
        
        // RÃ©attacher les event listeners pour le nouveau post
        const likeBtn = newPost.querySelector('.like-btn');
        likeBtn.addEventListener('click', function() {
            // Logic de like (dÃ©jÃ  dÃ©finie plus haut)
        });
    }
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
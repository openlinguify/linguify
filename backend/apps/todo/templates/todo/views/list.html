{% extends "todo/base.html" %}
{% load static %}
{% load i18n %}

{% block page_title %}Todo - List{% endblock %}

{% block header_content %}
{% include 'components/todo_navbar.html' with active_view='list' %}
{% endblock %}

{% block content %}
<div class="list-layout flex">
    <div class="list-container">
        <!-- List Header -->
        <div class="list-header-linguify">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <h1 class="list-title-linguify">{% trans "Tasks List" %}</h1>
                    <span class="badge-linguify">{{ tasks.count }} {% trans "tasks" %}</span>
                </div>
                <div class="flex items-center gap-2">
                    <button class="btn-linguify-secondary" id="bulkActionsBtn" onclick="showBulkActionsMenu()" disabled>
                        <i class="bi bi-check-all"></i>
                        <span class="hidden md:inline ml-1">{% trans "Bulk Actions" %}</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="list-filters-linguify">
            <div class="filter-card">
                <!-- Controls Row -->
                <div class="flex items-center justify-between mb-4 pb-4 border-bottom">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" class="form-check-input" id="selectAll">
                            <label class="text-sm font-medium text-gray-600">{% trans "Select All" %}</label>
                        </div>
                        <div class="sort-controls-linguify">
                            <span class="text-sm text-gray-500 mr-2">{% trans "Sort by:" %}</span>
                            <div class="flex gap-2">
                                <button class="sort-btn-linguify" data-sort="title">
                                    {% trans "Task" %} {% if current_filters.order_by == 'title' %}<i class="bi bi-chevron-up"></i>{% endif %}
                                </button>
                                <button class="sort-btn-linguify" data-sort="state">
                                    {% trans "Stage" %} {% if current_filters.order_by == 'state' %}<i class="bi bi-chevron-up"></i>{% endif %}
                                </button>
                                <button class="sort-btn-linguify" data-sort="due_date">
                                    {% trans "Due Date" %} {% if current_filters.order_by == 'due_date' %}<i class="bi bi-chevron-up"></i>{% endif %}
                                </button>
                                <button class="sort-btn-linguify" data-sort="created">
                                    {% trans "Created" %} {% if current_filters.order_by == 'created' %}<i class="bi bi-chevron-up"></i>{% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Filters Row -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-2">
                        <div class="filter-group-linguify">
                            <label class="filter-label-linguify">{% trans "Search" %}</label>
                            <div class="relative">
                                <input type="text" class="filter-input-linguify w-full pr-8" id="searchInput" 
                                       placeholder="{% trans 'Search tasks...' %}" 
                                       value="{{ current_filters.search|default:'' }}">
                                <button class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600" onclick="clearSearch()">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="filter-group-linguify">
                            <label class="filter-label-linguify">{% trans "Project" %}</label>
                            <select class="filter-input-linguify w-full" id="projectFilter">
                                <option value="">{% trans "All Projects" %}</option>
                                {% for project in projects %}
                                <option value="{{ project.id }}" {% if current_filters.project == project.id|stringformat:"s" %}selected{% endif %}>
                                    {{ project.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div>
                        <div class="filter-group-linguify">
                            <label class="filter-label-linguify">{% trans "Stage" %}</label>
                            <select class="filter-input-linguify w-full" id="stageFilter">
                                <option value="">{% trans "All Stages" %}</option>
                                {% for stage in stages %}
                                <option value="{{ stage.id }}" {% if current_filters.stage == stage.id|stringformat:"s" %}selected{% endif %}>
                                    {{ stage.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks List (Cards) -->
        <div class="task-list-container-linguify">

            <!-- Tasks Grid -->
            <div class="tasks-grid-linguify" id="tasksGrid">
                {% for task in tasks %}
                <div class="task-item-linguify {% if task.state == '1_done' %}task-completed{% endif %}" 
                     data-task-id="{{ task.id }}">
                    <!-- Task Header -->
                    <div class="task-header-section">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <input type="checkbox" class="form-check-input task-select" value="{{ task.id }}">
                                <div class="task-color-indicator color-{{ task.color }}" title="Color {{ task.color }}"></div>
                                <button class="priority-btn-linguify" onclick="togglePriority('{{ task.id }}')" 
                                        title="{% trans 'Toggle Priority' %}">
                                    {% if task.priority == '1' %}
                                    <i class="bi bi-star-fill text-amber-500"></i>
                                    {% else %}
                                    <i class="bi bi-star text-gray-400"></i>
                                    {% endif %}
                                </button>
                            </div>
                            <div class="task-actions">
                                <button class="action-btn-linguify" onclick="editTask('{{ task.id }}')" 
                                        title="{% trans 'Edit' %}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="action-btn-linguify text-red-500" onclick="deleteTask('{{ task.id }}')" 
                                        title="{% trans 'Delete' %}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Task Content -->
                    <div class="task-content-section">
                        <div class="flex items-start gap-3">
                            <button class="complete-btn-linguify" onclick="toggleComplete('{{ task.id }}')"
                                    title="{% trans 'Toggle Complete' %}">
                                {% if task.state == '1_done' %}
                                <i class="bi bi-check-circle-fill text-green-500"></i>
                                {% else %}
                                <i class="bi bi-circle text-gray-400"></i>
                                {% endif %}
                            </button>
                            <div class="flex-1">
                                <div class="task-title-linguify {% if task.state == '1_done' %}line-through text-gray-500{% endif %}" 
                                     onclick="openTask('{{ task.id }}')">
                                    {{ task.title }}
                                    {% if task.subtask_count > 0 %}
                                    <span class="subtask-counter">({{ task.completed_subtask_count }}/{{ task.subtask_count }})</span>
                                    {% endif %}
                                </div>
                                {% if task.description %}
                                <div class="task-description-linguify">
                                    {{ task.description|truncatechars:100|striptags }}
                                </div>
                                {% endif %}
                                {% if task.progress_percentage > 0 and task.state != '1_done' %}
                                <div class="task-progress-linguify">
                                    <div class="progress-bar-linguify" style="width: {{ task.progress_percentage }}%"></div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Task Meta -->
                    <div class="task-meta-section">
                        <div class="flex items-center justify-between flex-wrap gap-2">
                            <div class="flex items-center gap-2 flex-wrap">
                                <div class="stage-badge-linguify" style="background-color: {{ task.personal_stage_type.color }}20; color: {{ task.personal_stage_type.color }};">
                                    {{ task.personal_stage_type.name }}
                                </div>
                                {% if task.project %}
                                <div class="project-badge-linguify">
                                    <i class="bi bi-folder"></i>
                                    {{ task.project.name }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex items-center gap-2">
                                {% if task.due_date %}
                                <div class="due-date-badge-linguify {% if task.is_overdue %}overdue{% elif task.due_date.date == today %}today{% endif %}">
                                    {% if task.due_date.date == today %}
                                    <i class="bi bi-exclamation-triangle"></i> {% trans "Today" %}
                                    {% elif task.is_overdue %}
                                    <i class="bi bi-exclamation-circle"></i> {{ task.due_date|date:"M d" }}
                                    {% else %}
                                    <i class="bi bi-calendar"></i> {{ task.due_date|date:"M d, Y" }}
                                    {% endif %}
                                </div>
                                {% endif %}
                                <div class="created-date-linguify">
                                    <i class="bi bi-clock"></i> {{ task.created_at|date:"M d" }}
                                </div>
                            </div>
                        </div>
                        {% if task.tags.exists %}
                        <div class="task-tags-linguify mt-2">
                            {% for tag in task.tags.all|slice:":5" %}
                            <span class="tag-badge-linguify" style="background-color: {{ tag.color }}20; color: {{ tag.color }};">
                                {{ tag.name }}
                            </span>
                            {% endfor %}
                            {% if task.tags.count > 5 %}
                            <span class="tag-more-linguify">+{{ task.tags.count|add:"-5" }}</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div class="empty-state-linguify">
                    <div class="flex flex-col items-center justify-center py-12">
                        <i class="bi bi-inbox text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-medium text-gray-600 mb-2">{% trans "No tasks found" %}</h3>
                        <p class="text-gray-500 mb-4">{% trans "Create your first task or adjust your filters" %}</p>
                        <button class="btn-linguify-primary" onclick="createNewTask()">
                            <i class="bi bi-plus-lg"></i> {% trans "Create Task" %}
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Pagination -->
        {% if tasks.count > 50 %}
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted">
                {% trans "Showing" %} {{ tasks.count }} {% trans "tasks" %}
            </div>
            <nav>
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item disabled">
                        <span class="page-link">{% trans "Previous" %}</span>
                    </li>
                    <li class="page-item active">
                        <span class="page-link">1</span>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link">{% trans "Next" %}</span>
                    </li>
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- Quick Task Creation Modal -->
<div class="modal fade" id="quickTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Create New Task" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickTaskForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">{% trans "Task Title" %}</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">{% trans "Stage" %}</label>
                            <select class="form-select" name="personal_stage_type">
                                {% for stage in stages %}
                                <option value="{{ stage.id }}">{{ stage.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">{% trans "Priority" %}</label>
                            <select class="form-select" name="priority">
                                <option value="0">{% trans "Normal" %}</option>
                                <option value="1">{% trans "Starred" %}</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mt-1">
                        <div class="col-md-6">
                            <label class="form-label">{% trans "Project" %}</label>
                            <select class="form-select" name="project">
                                <option value="">{% trans "No Project" %}</option>
                                {% for project in projects %}
                                <option value="{{ project.id }}">{{ project.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">{% trans "Due Date" %}</label>
                            <input type="datetime-local" class="form-control" name="due_date">
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label class="form-label">{% trans "Description" %}</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-primary" onclick="submitQuickTask()">{% trans "Create Task" %}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}



{% block extra_js %}
<script src="{% static 'todo/js/list.js' %}"></script>
<script>
// Initialize List functionality
document.addEventListener('DOMContentLoaded', function() {
    initializeList();
});

// Global functions
window.showBulkActionsMenu = function() {
    if (window.todoList) {
        window.todoList.showBulkActionsMenu();
    }
};
</script>
{% endblock %}
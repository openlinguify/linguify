{% extends "todo/base.html" %}
{% load static %}
{% load i18n %}

{% block page_title %}Todo - Kanban{% endblock %}

{% block header_content %}
{% include 'components/todo_navbar.html' with active_view='kanban' %}
{% endblock %}

{% block content %}
<!-- Kanban Board with Linguify styling -->
<div class="container-fluid p-4" style="background-color: var(--linguify-gray-50, #f9fafb); min-height: calc(100vh - 120px);">
    <div class="row g-0">
        <div class="col-12">
            <div class="kanban-board-container" style="overflow-x: auto;">
                <div class="d-flex gap-3" id="kanbanBoard" style="min-width: max-content;">
                    {% for stage_id, stage_data in kanban_data.items %}
                    <!-- Kanban Column -->
                    <div class="kanban-column" data-stage-id="{{ stage_id }}" style="min-width: 300px; width: 300px;">
                        <div class="card-linguify h-100 d-flex flex-column">
                            <!-- Column Header -->
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center gap-2">
                                    <h6 class="mb-0 fw-semibold">{{ stage_data.stage.name }}</h6>
                                    <span class="badge" style="background-color: var(--linguify-gray-200, #e5e7eb); color: var(--linguify-gray-700, #374151);">
                                        {{ stage_data.count }}
                                    </span>
                                </div>
                                <div class="d-flex align-items-center gap-1">
                                    <button class="btn btn-sm btn-link text-muted p-1 kanban-quick-add" 
                                            onclick="addTaskToStage('{{ stage_id }}')" 
                                            title="{% trans 'Add task' %}"
                                            style="color: var(--linguify-gray-400, #9ca3af) !important;">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-link text-muted p-1 dropdown-toggle" 
                                                data-bs-toggle="dropdown"
                                                style="color: var(--linguify-gray-400, #9ca3af) !important;">
                                            <i class="bi bi-three-dots"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="toggleStage('{{ stage_id }}')">
                                                <i class="bi bi-eye{% if stage_data.stage.fold %}-slash{% endif %} me-2"></i>
                                                {% if stage_data.stage.fold %}{% trans "Show" %}{% else %}{% trans "Hide" %}{% endif %}
                                            </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#">
                                                <i class="bi bi-trash me-2"></i> {% trans "Delete stage" %}
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Tasks Container -->
                            <div class="card-body flex-grow-1 kanban-tasks-container" 
                                 id="tasks-{{ stage_id }}" 
                                 style="{% if stage_data.stage.fold %}display: none;{% endif %} overflow-y: auto; max-height: 70vh;">
                                {% for task in stage_data.tasks %}
                                <!-- Task Card -->
                                <div class="card mb-3 kanban-task-card kanban-card" 
                                     data-task-id="{{ task.id }}" 
                                     data-stage-id="{{ stage_id }}" 
                                     onclick="openTask('{{ task.id }}')"
                                     style="cursor: pointer; border: 1px solid var(--linguify-gray-200, #e5e7eb); transition: all 0.2s ease;">
                                    <div class="card-body p-3">
                                        <!-- Task Header -->
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0 flex-grow-1" style="color: var(--linguify-primary-dark, #1E4A8C);">
                                                {{ task.title }}
                                            </h6>
                                            {% if task.priority == '1' %}
                                            <i class="bi bi-star-fill text-warning ms-2"></i>
                                            {% endif %}
                                        </div>

                                        <!-- Task Meta -->
                                        {% if task.due_date or task.project %}
                                        <div class="d-flex align-items-center gap-3 mb-2 small text-muted">
                                            {% if task.due_date %}
                                            <span class="d-flex align-items-center gap-1 {% if task.is_overdue %}text-danger{% elif task.due_date.date == today %}text-warning{% endif %}">
                                                <i class="bi bi-calendar"></i>
                                                {% if task.due_date.date == today %}
                                                    {% trans "Today" %}
                                                {% elif task.is_overdue %}
                                                    {{ task.due_date|date:"M d" }}
                                                {% else %}
                                                    {{ task.due_date|date:"M d" }}
                                                {% endif %}
                                            </span>
                                            {% endif %}
                                            
                                            {% if task.project %}
                                            <span class="d-flex align-items-center gap-1">
                                                <i class="bi bi-folder"></i>
                                                {{ task.project.name }}
                                            </span>
                                            {% endif %}
                                        </div>
                                        {% endif %}

                                        <!-- Task Tags -->
                                        {% if task.tags.all %}
                                        <div class="d-flex flex-wrap gap-1 mb-2">
                                            {% for tag in task.tags.all %}
                                            <span class="badge badge-sm" 
                                                  style="background-color: {{ tag.color }}20; color: {{ tag.color }}; font-size: 0.7rem;">
                                                {{ tag.name }}
                                            </span>
                                            {% endfor %}
                                        </div>
                                        {% endif %}

                                        <!-- Task Progress -->
                                        {% if task.progress_percentage > 0 %}
                                        <div class="mb-2">
                                            <div class="progress" style="height: 4px;">
                                                <div class="progress-bar" 
                                                     style="width: {{ task.progress_percentage }}%; background-color: var(--linguify-primary, #2D5BBA);"></div>
                                            </div>
                                            <small class="text-muted">{{ task.progress_percentage }}%</small>
                                        </div>
                                        {% endif %}

                                        <!-- Task Footer -->
                                        <div class="d-flex justify-content-between align-items-center pt-2" style="border-top: 1px solid var(--linguify-gray-100, #f3f4f6);">
                                            <small class="text-muted">{{ task.created_at|timesince }} {% trans "ago" %}</small>
                                            <div class="d-flex align-items-center gap-1">
                                                <button class="btn btn-sm btn-outline-primary p-1" 
                                                        onclick="event.stopPropagation(); editTask('{{ task.id }}')" 
                                                        title="{% trans 'Edit' %}"
                                                        style="border-color: var(--linguify-primary, #2D5BBA); color: var(--linguify-primary, #2D5BBA);">
                                                    <i class="bi bi-pencil" style="font-size: 0.8rem;"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-success p-1" 
                                                        onclick="event.stopPropagation(); toggleTaskComplete('{{ task.id }}')" 
                                                        title="{% trans 'Toggle Complete' %}">
                                                    {% if task.state == '1_done' %}
                                                    <i class="bi bi-check-circle-fill text-success"></i>
                                                    {% else %}
                                                    <i class="bi bi-circle" style="font-size: 0.8rem;"></i>
                                                    {% endif %}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}

                                <!-- Add Task Button -->
                                <button class="btn btn-outline-secondary w-100 add-task-btn" 
                                        onclick="addTaskToStage('{{ stage_id }}')"
                                        style="border-style: dashed; color: var(--linguify-gray-500, #6b7280); border-color: var(--linguify-gray-300, #d1d5db);">
                                    <i class="bi bi-plus me-2"></i>{% trans "Add a task" %}
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Add Stage Column -->
                    <div class="d-flex align-items-center" style="min-width: 200px;">
                        <button class="btn btn-outline-secondary add-stage-btn d-flex flex-column align-items-center justify-content-center" 
                                onclick="addNewStage()"
                                style="width: 100%; height: 200px; border-style: dashed; color: var(--linguify-gray-500, #6b7280); border-color: var(--linguify-gray-300, #d1d5db);">
                            <i class="bi bi-plus-lg mb-2" style="font-size: 1.5rem;"></i>
                            <span class="fw-medium">{% trans "Add Stage" %}</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Task Creation Modal -->
<div class="modal fade" id="quickTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Create New Task" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickTaskForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">{% trans "Task Title" %}</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Stage" %}</label>
                        <select class="form-select" name="personal_stage_type">
                            {% for stage in stages %}
                            <option value="{{ stage.id }}">{{ stage.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Project" %} ({% trans "Optional" %})</label>
                        <select class="form-select" name="project">
                            <option value="">{% trans "No Project" %}</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Due Date" %} ({% trans "Optional" %})</label>
                        <input type="datetime-local" class="form-control" name="due_date">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-primary" onclick="submitQuickTask()">{% trans "Create Task" %}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'todo/css/kanban.css' %}">
<style>
/* Kanban Linguify Styles */
.kanban-task-card:hover {
    border-color: var(--linguify-primary, #2D5BBA) !important;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transform: translateY(-1px);
}

.kanban-quick-add:hover {
    color: var(--linguify-primary, #2D5BBA) !important;
    transform: scale(1.1);
}

.add-task-btn:hover,
.add-stage-btn:hover {
    border-color: var(--linguify-primary, #2D5BBA) !important;
    color: var(--linguify-primary, #2D5BBA) !important;
    background-color: rgba(45, 91, 186, 0.05) !important;
}

/* Quick add form styling */
.quick-add-form {
    background: white;
    border: 1px solid var(--linguify-gray-200, #e5e7eb);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 0.75rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.quick-add-form input {
    border: 1px solid var(--linguify-gray-300, #d1d5db) !important;
    border-radius: 0.375rem !important;
    padding: 0.5rem 0.75rem !important;
    font-size: 0.875rem !important;
    width: 100% !important;
    background: white !important;
}

.quick-add-form input:focus {
    border-color: var(--linguify-primary, #2D5BBA) !important;
    box-shadow: 0 0 0 3px rgba(45, 91, 186, 0.1) !important;
    outline: none !important;
}

.quick-add-form .btn {
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
}

/* Drag and drop effects */
.kanban-card.dragging {
    opacity: 0.5;
    transform: rotate(2deg);
}

.kanban-column.drag-over {
    background-color: rgba(45, 91, 186, 0.05);
}

/* Scrollbar styling */
.kanban-tasks-container::-webkit-scrollbar {
    width: 4px;
}

.kanban-tasks-container::-webkit-scrollbar-track {
    background: var(--linguify-gray-100, #f3f4f6);
}

.kanban-tasks-container::-webkit-scrollbar-thumb {
    background: var(--linguify-gray-300, #d1d5db);
    border-radius: 2px;
}

.kanban-tasks-container::-webkit-scrollbar-thumb:hover {
    background: var(--linguify-gray-400, #9ca3af);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .kanban-column {
        min-width: 250px !important;
        width: 250px !important;
    }
    
    .gap-3 {
        gap: 0.75rem !important;
    }
    
    .kanban-tasks-container {
        max-height: 60vh !important;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'todo/js/kanban.js' %}"></script>
<script>
// Initialize Kanban functionality
document.addEventListener('DOMContentLoaded', function() {
    initializeKanban();
});
</script>
{% endblock %}
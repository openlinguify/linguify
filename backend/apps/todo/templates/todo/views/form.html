{% extends "todo/base.html" %}
{% load static %}
{% load i18n %}

{% block page_title %}{% if task %}Edit Task{% else %}New Task{% endif %}{% endblock %}

{% block header_content %}
{% include 'components/todo_navbar.html' with active_view='form' %}
{% endblock %}

{% block content %}
<div class="form-layout">
    <div class="form-container">
        <!-- Form Content Layout -->
        <div class="form-layout-full-width">
            <!-- Main Form Content -->
            <div class="form-main-content">
                <div class="form-card-linguify">
                <form id="taskForm" method="post"
                          hx-post="{% if task %}{% url 'todo:task_autosave_update_htmx' task.id %}{% else %}{% url 'todo:task_autosave_create_htmx' %}{% endif %}"
                          hx-trigger="change delay:2s, input delay:3s from:input, input delay:3s from:textarea, change delay:1s from:select"
                          hx-target="#saveIndicator"
                          hx-swap="innerHTML">
                    {% csrf_token %}
                    
                    <!-- Title -->
                    <div class="form-group-linguify">
                        <label for="title" class="form-label-linguify">
                            {% trans "Title" %} <span class="text-required">*</span>
                        </label>
                        <input type="text" class="input-linguify" id="title" name="title" 
                               value="{{ task.title|default:'' }}" required autofocus maxlength="200"
                               placeholder="{% trans 'Enter task title (max 200 characters)' %}"
                               hx-post="{% url 'todo:character_count_htmx' %}"
                               hx-trigger="keyup changed delay:100ms"
                               hx-target="#titleCharCount"
                               hx-swap="outerHTML"
                               hx-vals='js:{"title": document.getElementById("title").value}'>
                        <div class="text-xs text-gray-500 mt-1" id="titleCharCount">
                            <span class="text-gray-500">{{ task.title|length|default:0 }}</span>/200 {% trans "characters" %}
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div class="form-group-description-linguify">
                        <label for="description" class="form-label-linguify">
                            {% trans "Description" %}
                        </label>
                        <textarea id="description" name="description" 
                                  class="input-linguify" 
                                  rows="8"
                                  placeholder="{% trans 'Enter task description...' %}"
                                  style="width: 100%; resize: vertical; font-family: inherit;">{{ task.description|default:'' }}</textarea>
                        <div class="text-xs text-gray-500 mt-1">
                            {% trans "Tip: You can use Markdown for formatting" %}
                        </div>
                    </div>
                    
                    
                    <!-- Hidden tags input -->
                    <input type="hidden" name="tags" id="tagsInput" 
                           value="{% for tag in task.tags.all %}{{ tag.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                </form>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="form-sidebar">
            <!-- Actions Card -->
            <div class="sidebar-card-linguify">
                <div class="sidebar-header-linguify">
                    <h6>{% trans "Actions" %}</h6>
                </div>
                <div class="sidebar-content-linguify">
                    <div class="form-actions-stack">
                        <div id="saveIndicator" class="mb-3 text-sm"></div>
                        <button type="submit" form="taskForm" class="btn-linguify btn-full"
                                hx-post="{% if task %}{% url 'todo:task_autosave_update_htmx' task.id %}{% else %}{% url 'todo:task_autosave_create_htmx' %}{% endif %}"
                                hx-target="#saveIndicator"
                                hx-swap="innerHTML">
                            <i class="bi bi-check"></i>
                            {% trans "Save" %}
                        </button>
                        
                        {% if task %}
                        <button type="button" class="btn-linguify-outline btn-full btn-success" 
                                hx-post="{% url 'todo:task_toggle_form_htmx' task.id %}"
                                hx-swap="outerHTML"
                                hx-target="this">
                            {% if task.state == '1_done' %}
                            <i class="bi bi-arrow-counterclockwise"></i> {% trans "Mark as Incomplete" %}
                            {% else %}
                            <i class="bi bi-check-circle"></i> {% trans "Mark as Complete" %}
                            {% endif %}
                        </button>
                        
                        <button type="button" class="btn-linguify-outline btn-full btn-danger" 
                                hx-delete="{% url 'todo:task_delete_form_htmx' task.id %}"
                                hx-confirm="{% trans 'Are you sure you want to delete this task?' %}">
                            <i class="bi bi-trash"></i> {% trans "Delete Task" %}
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Configuration Card -->
            <div class="sidebar-card-linguify">
                <div class="sidebar-header-linguify">
                    <h6>{% trans "Configuration" %}</h6>
                </div>
                <div class="sidebar-content-linguify">
                    <!-- Project -->
                    <div class="form-group-linguify">
                        <label for="project" class="form-label-linguify">
                            {% trans "Project" %}
                        </label>
                        <select class="select-linguify" id="project" name="project" form="taskForm">
                            <option value="">{% trans "No Project" %}</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}" 
                                    {% if task.project_id == project.id %}selected{% endif %}>
                                {{ project.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Stage -->
                    <div class="form-group-linguify">
                        <label for="personal_stage_type" class="form-label-linguify">
                            {% trans "Stage" %}
                        </label>
                        <select class="select-linguify" id="personal_stage_type" name="personal_stage_type" form="taskForm">
                            {% for stage in stages %}
                            <option value="{{ stage.id }}" 
                                    {% if task.personal_stage_type_id == stage.id %}selected{% endif %}>
                                {{ stage.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Priority -->
                    <div class="form-group-linguify">
                        <label for="priority" class="form-label-linguify">
                            {% trans "Priority" %}
                        </label>
                        <select class="select-linguify" id="priority" name="priority" form="taskForm">
                            {% for value, label in priority_choices %}
                            <option value="{{ value }}" 
                                    {% if task.priority == value %}selected{% endif %}>
                                {% if value == '1' %}⭐ {% endif %}{{ label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Color -->
                    <div class="form-group-linguify">
                        <label class="form-label-linguify">
                            {% trans "Color" %}
                        </label>
                        <div class="color-selector-linguify">
                            {% for i in "0123456789AB" %}
                            <input type="radio" class="color-option-linguify" name="color" value="{{ forloop.counter0 }}" 
                                   id="color{{ forloop.counter0 }}" form="taskForm"
                                   {% if task.color == forloop.counter0 or forloop.counter0 == 0 and not task.color %}checked{% endif %}>
                            <label for="color{{ forloop.counter0 }}" class="color-label-linguify color-{{ forloop.counter0 }}" 
                                   title="Color {{ forloop.counter0 }}"></label>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Start Date -->
                    <div class="form-group-linguify">
                        <label for="start_date" class="form-label-linguify">
                            {% trans "Start Date" %}
                        </label>
                        <input type="datetime-local" class="input-linguify" id="start_date" name="start_date" 
                               value="{{ task.start_date|date:'Y-m-d\TH:i'|default:'' }}" form="taskForm">
                    </div>
                    
                    <!-- Due Date -->
                    <div class="form-group-linguify">
                        <label for="due_date" class="form-label-linguify">
                            {% trans "Due Date" %}
                        </label>
                        <input type="datetime-local" class="input-linguify" id="due_date" name="due_date" 
                               value="{{ task.due_date|date:'Y-m-d\TH:i'|default:'' }}" form="taskForm">
                    </div>
                    
                    <!-- Tags -->
                    <div class="form-group-linguify">
                        <label class="form-label-linguify">
                            {% trans "Tags" %}
                        </label>
                        <div class="tags-container-linguify">
                            <div class="selected-tags-linguify" id="selectedTags">
                                {% for tag in task.tags.all %}
                                <span class="tag-badge-linguify" 
                                      data-tag-id="{{ tag.id }}" 
                                      data-bg-color="{{ tag.color }}20"
                                      data-text-color="{{ tag.color }}">
                                    {{ tag.name }}
                                    <button type="button" class="tag-remove-linguify" 
                                            hx-delete="{% url 'todo:tag_remove_htmx' tag.id %}"
                                            hx-vals='js:{"selected": document.getElementById("tagsInput").value}'
                                            hx-target="#selectedTags"
                                            hx-swap="innerHTML">&times;</button>
                                </span>
                                {% endfor %}
                            </div>
                            <div class="tag-input-group-linguify">
                                <input type="text" class="input-linguify input-sm-linguify" id="tagInput" 
                                       placeholder="{% trans 'Type to search or create tags...' %}"
                                       hx-get="{% url 'todo:tag_search_htmx' %}"
                                       hx-trigger="keyup changed delay:300ms"
                                       hx-target="#tagSuggestions"
                                       hx-vals='js:{"q": document.getElementById("tagInput").value, "selected": document.getElementById("tagsInput").value}'
                                       autocomplete="off">
                                <div class="tag-suggestions-linguify" id="tagSuggestions">
                                    <!-- Tag suggestions will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Info Card -->
            {% if task %}
            <div class="sidebar-card-linguify">
                <div class="sidebar-header-linguify">
                    <h6>{% trans "Information" %}</h6>
                </div>
                <div class="sidebar-content-linguify">
                    <div class="info-item-linguify">
                        <small class="info-label">{% trans "Création" %}</small>
                        <div class="info-value">{{ task.created_at|date:"M d, Y H:i" }}</div>
                    </div>
                    
                    {% if task.updated_at != task.created_at %}
                    <div class="info-item-linguify">
                        <small class="info-label">{% trans "Last Modified" %}</small>
                        <div class="info-value">{{ task.updated_at|date:"M d, Y H:i" }}</div>
                    </div>
                    {% endif %}
                    
                    {% if task.completed_at %}
                    <div class="info-item-linguify">
                        <small class="info-label">{% trans "Completed" %}</small>
                        <div class="info-value">{{ task.completed_at|date:"M d, Y H:i" }}</div>
                    </div>
                    {% endif %}
                    
                    <div class="info-item-linguify">
                        <small class="info-label">{% trans "Status" %}</small>
                        <div class="info-value">
                            <span class="badge-linguify" 
                                  data-bg-color="{{ task.personal_stage_type.color }}20"
                                  data-text-color="{{ task.personal_stage_type.color }}">
                                {{ task.personal_stage_type.name }}
                            </span>
                        </div>
                    </div>
                    
                </div>
            </div>
            {% endif %}
        </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- All styles are centralized in tailwind-modals.css -->
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Apply colors to tags and badges using data attributes
    function applyColors() {
        document.querySelectorAll('[data-bg-color], [data-text-color]').forEach(element => {
            const bgColor = element.dataset.bgColor;
            const textColor = element.dataset.textColor;
            if (bgColor) element.style.backgroundColor = bgColor;
            if (textColor) element.style.color = textColor;
        });
    }
    
    // Apply colors on load
    applyColors();
    
    // Re-apply colors after HTMX updates (for tags)
    document.body.addEventListener('htmx:afterSwap', applyColors);
    
    // Keep minimal JavaScript for form submission handling
    document.getElementById('taskForm').addEventListener('submit', function(e) {
        e.preventDefault();
        // HTMX handles the actual submission via hx-post on the save button
    });
    
    // Hide tag suggestions when clicking outside
    const tagInput = document.getElementById('tagInput');
    const tagSuggestions = document.getElementById('tagSuggestions');
    
    if (tagInput && tagSuggestions) {
        document.addEventListener('click', function(e) {
            if (!tagInput.contains(e.target) && !tagSuggestions.contains(e.target)) {
                tagSuggestions.style.display = 'none';
            }
        });
        
        // Handle Enter key in tag input
        tagInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                tagSuggestions.style.display = 'none';
                this.value = '';
            }
        });
    }
});
</script>
{% endblock %}
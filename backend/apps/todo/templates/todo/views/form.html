{% extends "todo/base.html" %}
{% load static %}
{% load i18n %}

{% block page_title %}{% if task %}Edit Task{% else %}New Task{% endif %}{% endblock %}

{% block header_content %}
{% include 'components/todo_navbar.html' with active_view='form' %}
{% endblock %}

{% block content %}
<div style="height: calc(100vh - 120px); display: flex; box-sizing: border-box;">
        <!-- Left Column: Form Content -->
        <div class="form-main-content">
            <div class="form-card-linguify" style="height: 100%; display: flex; flex-direction: column;">
            <form id="taskForm" method="post" style="height: 100%; display: flex; flex-direction: column;"
                      hx-post="{% if task %}{% url 'todo:task_autosave_update_htmx' task.id %}{% else %}{% url 'todo:task_autosave_create_htmx' %}{% endif %}"
                      hx-trigger="change delay:1000ms from:select, blur delay:500ms from:input, blur delay:500ms from:textarea"
                      hx-target="#navbarSaveIndicator"
                      hx-swap="innerHTML">
                {% csrf_token %}
                
                <!-- Title -->
                <div class="form-group-linguify" style="flex-shrink: 0;">
                    <label for="title" class="form-label-linguify">
                        {% trans "Title" %} <span class="text-required">*</span>
                    </label>
                    <input type="text" class="input-linguify" id="title" name="title" 
                           value="{{ task.title|default:'' }}" required autofocus maxlength="200"
                           placeholder="{% trans 'Enter task title (max 200 characters)' %}"
                           hx-post="{% url 'todo:character_count_htmx' %}"
                           hx-trigger="keyup changed delay:100ms"
                           hx-target="#titleCharCount"
                           hx-swap="outerHTML"
                           hx-vals='js:{"title": document.getElementById("title").value}'>
                    <div class="text-xs text-gray-500 mt-1" id="titleCharCount">
                        <span class="text-gray-500">{{ task.title|length|default:0 }}</span>/200 {% trans "characters" %}
                    </div>
                </div>
                
                <!-- Description -->
                <div class="form-group-description-linguify flex-grow-1 d-flex flex-column">
                    <label for="description" class="form-label-linguify">
                        {% trans "Description" %}
                    </label>
                    <textarea id="description" name="description" 
                              class="form-control flex-grow-1" 
                              placeholder="{% trans 'Ecrivez votre description ici...' %}"
                              style="border: 1px solid #ddd; border-radius: 4px; font-family: inherit; padding: 12px; resize: none; min-height: 400px; height: 100%;">{{ task.description|default:'' }}</textarea>
                    <div class="text-xs text-gray-500 mt-1">
                        {% trans "Tip: You can use Markdown for formatting" %}
                    </div>
                </div>
                
                
                <!-- Hidden tags input -->
                <input type="hidden" name="tags" id="tagsInput" 
                       value="{% for tag in task.tags.all %}{{ tag.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
            </form>
            </div>
        </div>
        
        <!-- Right Column: Sidebar -->
        <div class="form-sidebar">
            <!-- Info Card -->
            {% if task %}
            <div class="sidebar-card-linguify">
                <div class="sidebar-header-linguify">
                    <h6>{% trans "Information" %}</h6>
                </div>
                <div class="sidebar-content-linguify">
                    <div class="info-item-linguify" style="margin-bottom: 8px;">
                        <small class="info-label">{% trans "Création" %}</small>
                        <div class="info-value" style="font-size: 0.875rem;">{{ task.created_at|date:"M d, Y H:i" }}</div>
                    </div>
                    
                    {% if task.updated_at != task.created_at %}
                    <div class="info-item-linguify" style="margin-bottom: 8px;">
                        <small class="info-label">{% trans "Last Modified" %}</small>
                        <div class="info-value" style="font-size: 0.875rem;">{{ task.updated_at|date:"M d, Y H:i" }}</div>
                    </div>
                    {% endif %}
                    
                    <div class="info-item-linguify">
                        <small class="info-label">{% trans "Status" %}</small>
                        <div class="info-value">
                            <span class="badge-linguify" style="font-size: 0.8rem; padding: 2px 6px;"
                                  data-bg-color="{{ task.personal_stage_type.color }}20"
                                  data-text-color="{{ task.personal_stage_type.color }}">
                                {{ task.personal_stage_type.name }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Configuration Card -->
            <div class="sidebar-card-linguify">
                <div class="sidebar-header-linguify">
                    <h6>{% trans "Configuration" %}</h6>
                </div>
                <div class="sidebar-content-linguify" style="max-height: 70vh; overflow-y: auto;">
                    <!-- Project & Stage Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label for="project" class="form-label-linguify" style="font-size: 0.8rem; margin-bottom: 4px;">
                                {% trans "Project" %}
                            </label>
                            <select class="select-linguify" id="project" name="project" form="taskForm" style="font-size: 0.875rem; padding: 6px;">
                                <option value="">{% trans "No Project" %}</option>
                                {% for project in projects %}
                                <option value="{{ project.id }}" {% if task.project_id == project.id %}selected{% endif %}>
                                    {{ project.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="personal_stage_type" class="form-label-linguify" style="font-size: 0.8rem; margin-bottom: 4px;">
                                {% trans "Stage" %}
                            </label>
                            <select class="select-linguify" id="personal_stage_type" name="personal_stage_type" form="taskForm" style="font-size: 0.875rem; padding: 6px;">
                                {% for stage in stages %}
                                <option value="{{ stage.id }}" {% if task.personal_stage_type_id == stage.id %}selected{% endif %}>
                                    {{ stage.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Priority & Color Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label for="priority" class="form-label-linguify" style="font-size: 0.8rem; margin-bottom: 4px;">
                                {% trans "Priority" %}
                            </label>
                            <select class="select-linguify" id="priority" name="priority" form="taskForm" style="font-size: 0.875rem; padding: 6px;">
                                {% for value, label in priority_choices %}
                                <option value="{{ value }}" {% if task.priority == value %}selected{% endif %}>
                                    {% if value == '1' %}⭐ {% endif %}{{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="form-label-linguify" style="font-size: 0.8rem; margin-bottom: 4px;">
                                {% trans "Color" %}
                            </label>
                            <div class="color-selector-linguify" style="display: flex; flex-wrap: wrap; gap: 3px;">
                                {% for i in "012345" %}
                                <input type="radio" class="color-option-linguify" name="color" value="{{ forloop.counter0 }}" 
                                       id="color{{ forloop.counter0 }}" form="taskForm"
                                       {% if task.color == forloop.counter0 or forloop.counter0 == 0 and not task.color %}checked{% endif %}>
                                <label for="color{{ forloop.counter0 }}" class="color-label-linguify color-{{ forloop.counter0 }}" 
                                       style="width: 16px; height: 16px;" title="Color {{ forloop.counter0 }}"></label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dates Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label for="start_date" class="form-label-linguify" style="font-size: 0.8rem; margin-bottom: 4px;">
                                {% trans "Start Date" %}
                            </label>
                            <input type="datetime-local" class="input-linguify" id="start_date" name="start_date" 
                                   style="font-size: 0.8rem; padding: 6px;"
                                   value="{{ task.start_date|date:'Y-m-d\TH:i'|default:'' }}" form="taskForm">
                        </div>
                        <div>
                            <label for="due_date" class="form-label-linguify" style="font-size: 0.8rem; margin-bottom: 4px;">
                                {% trans "Due Date" %}
                            </label>
                            <input type="datetime-local" class="input-linguify" id="due_date" name="due_date" 
                                   style="font-size: 0.8rem; padding: 6px;"
                                   value="{{ task.due_date|date:'Y-m-d\TH:i'|default:'' }}" form="taskForm">
                        </div>
                    </div>
                    
                    <!-- Tags -->
                    <div style="margin-bottom: 12px;">
                        <label class="form-label-linguify" style="font-size: 0.8rem; margin-bottom: 4px;">
                            {% trans "Tags" %}
                        </label>
                        <div class="tags-container-linguify">
                            <div class="selected-tags-linguify" id="selectedTags">
                                {% for tag in task.tags.all %}
                                <span class="tag-badge-linguify" style="font-size: 0.75rem; padding: 2px 6px;"
                                      data-tag-id="{{ tag.id }}" 
                                      data-bg-color="{{ tag.color }}20"
                                      data-text-color="{{ tag.color }}">
                                    {{ tag.name }}
                                    <button type="button" class="tag-remove-linguify" 
                                            hx-delete="{% url 'todo:tag_remove_htmx' tag.id %}"
                                            hx-vals='js:{"selected": document.getElementById("tagsInput").value}'
                                            hx-target="#selectedTags"
                                            hx-swap="innerHTML">&times;</button>
                                </span>
                                {% endfor %}
                            </div>
                            <div class="tag-input-group-linguify">
                                <input type="text" class="input-linguify input-sm-linguify" id="tagInput" 
                                       style="font-size: 0.8rem; padding: 6px;"
                                       placeholder="{% trans 'Type to search or create tags...' %}"
                                       hx-get="{% url 'todo:tag_search_htmx' %}"
                                       hx-trigger="keyup changed delay:300ms"
                                       hx-target="#tagSuggestions"
                                       hx-vals='js:{"q": document.getElementById("tagInput").value, "selected": document.getElementById("tagsInput").value}'
                                       autocomplete="off">
                                <div class="tag-suggestions-linguify" id="tagSuggestions">
                                    <!-- Tag suggestions will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- All styles are centralized in tailwind-modals.css -->

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Apply colors to tags and badges using data attributes
    function applyColors() {
        document.querySelectorAll('[data-bg-color], [data-text-color]').forEach(element => {
            const bgColor = element.dataset.bgColor;
            const textColor = element.dataset.textColor;
            if (bgColor) element.style.backgroundColor = bgColor;
            if (textColor) element.style.color = textColor;
        });
    }
    
    // Apply colors on load
    applyColors();
    
    // Re-apply colors after HTMX updates (for tags)
    document.body.addEventListener('htmx:afterSwap', applyColors);
    
    // Keep minimal JavaScript for form submission handling
    document.getElementById('taskForm').addEventListener('submit', function(e) {
        e.preventDefault();
        // HTMX handles the actual submission via hx-post on the save button
    });
    
    // Hide tag suggestions when clicking outside
    const tagInput = document.getElementById('tagInput');
    const tagSuggestions = document.getElementById('tagSuggestions');
    
    if (tagInput && tagSuggestions) {
        document.addEventListener('click', function(e) {
            if (!tagInput.contains(e.target) && !tagSuggestions.contains(e.target)) {
                tagSuggestions.style.display = 'none';
            }
        });
        
        // Handle Enter key in tag input
        tagInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                tagSuggestions.style.display = 'none';
                this.value = '';
            }
        });
    }
});
</script>
{% endblock %}
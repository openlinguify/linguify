{% extends "todo/base.html" %}
{% load static %}
{% load i18n %}

{% block page_title %}{% if task %}Edit Task{% else %}New Task{% endif %}{% endblock %}

{% block header_content %}
{% include 'components/todo_navbar.html' with active_view='form' %}
{% endblock %}

{% block content %}
<div style="height: calc(100vh - 120px); display: flex; box-sizing: border-box;">
        <!-- Left Column: Form Content -->
        <div class="form-main-content">
            <div class="form-card-linguify" style="height: 100%; display: flex; flex-direction: column;">
            <form id="taskForm" method="post" style="height: 100%; display: flex; flex-direction: column;"
                      hx-post="{% if task %}{% url 'todo:task_autosave_update_htmx' task.id %}{% else %}{% url 'todo:task_autosave_create_htmx' %}{% endif %}"
                      hx-trigger="change delay:800ms from:select, blur delay:600ms from:input, blur delay:600ms from:textarea, input delay:2000ms from:textarea"
                      hx-target="#navbarSaveIndicator"
                      hx-swap="innerHTML">
                {% csrf_token %}
                
                <!-- Title -->
                <div class="form-group-linguify" style="flex-shrink: 0;">
                    <label for="title" class="form-label-linguify">
                        {% trans "Title" %} <span class="text-required">*</span>
                    </label>
                    <input type="text" class="input-linguify" id="title" name="title" 
                           value="{{ task.title|default:'' }}" required autofocus maxlength="200"
                           placeholder="{% trans 'Enter task title (max 200 characters)' %}"
                           oninput="updateCharCount()">
                    <div class="text-xs text-gray-500 mt-1" id="titleCharCount">
                        <span id="charCountSpan">{{ task.title|length|default:0 }}</span>/200 {% trans "characters" %}
                    </div>
                </div>
                
                <!-- Description -->
                <div class="form-group-description-linguify flex-grow-1 d-flex flex-column">
                    <label for="description" class="form-label-linguify">
                        {% trans "Description" %}
                    </label>
                    <div id="task-description-editor" class="flex-grow-1" style="min-height: 400px;">
                        <!-- Editor.js will be initialized here -->
                    </div>
                    <textarea id="description" name="description"
                              class="form-control flex-grow-1"
                              style="display: none;">{{ task.description|default:'' }}</textarea>
                    <div class="text-xs text-gray-500 mt-1">
                        {% trans "Tip: Type '/' to see available commands" %}
                    </div>
                </div>
                
                
                <!-- Hidden tags input -->
                <input type="hidden" name="tags" id="tagsInput" 
                       value="{% for tag in task.tags.all %}{{ tag.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
            </form>
            </div>
        </div>
        
        <!-- Right Column: Sidebar -->
        <div class="form-sidebar">
            <!-- Configuration Card -->
            <div class="sidebar-card-linguify">
                <div class="sidebar-header-linguify">
                    <h6>{% trans "Configuration" %}</h6>
                </div>
                <div class="sidebar-content-linguify">
                    <!-- Project & Stage Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label for="project" class="form-label-linguify" style="font-size: 0.8rem; margin-bottom: 4px;">
                                {% trans "Project" %}
                            </label>
                            <select class="select-linguify" id="project" name="project" form="taskForm" style="font-size: 0.875rem; padding: 6px;">
                                <option value="">{% trans "No Project" %}</option>
                                {% for project in projects %}
                                <option value="{{ project.id }}" {% if task.project_id == project.id %}selected{% endif %}>
                                    {{ project.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="personal_stage_type" class="form-label-linguify" style="font-size: 0.8rem; margin-bottom: 4px;">
                                {% trans "Stage" %}
                            </label>
                            <select class="select-linguify" id="personal_stage_type" name="personal_stage_type" form="taskForm" style="font-size: 0.875rem; padding: 6px;">
                                {% for stage in stages %}
                                <option value="{{ stage.id }}" {% if task.personal_stage_type_id == stage.id %}selected{% endif %}>
                                    {{ stage.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Priority & Color Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label for="priority" class="form-label-linguify" style="font-size: 0.8rem; margin-bottom: 4px;">
                                {% trans "Priority" %}
                            </label>
                            <select class="select-linguify" id="priority" name="priority" form="taskForm" style="font-size: 0.875rem; padding: 6px;">
                                {% for value, label in priority_choices %}
                                <option value="{{ value }}" {% if task.priority == value %}selected{% endif %}>
                                    {% if value == '1' %}⭐ {% endif %}{{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="form-label-linguify" style="font-size: 0.8rem; margin-bottom: 4px;">
                                {% trans "Color" %}
                            </label>
                            <div class="color-selector-linguify" style="display: flex; flex-wrap: wrap; gap: 3px;">
                                {% for i in "012345" %}
                                <input type="radio" class="color-option-linguify" name="color" value="{{ forloop.counter0 }}" 
                                       id="color{{ forloop.counter0 }}" form="taskForm"
                                       {% if task.color == forloop.counter0 or forloop.counter0 == 0 and not task.color %}checked{% endif %}>
                                <label for="color{{ forloop.counter0 }}" class="color-label-linguify color-{{ forloop.counter0 }}" 
                                       style="width: 16px; height: 16px;" title="Color {{ forloop.counter0 }}"></label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dates Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label for="start_date" class="form-label-linguify" style="font-size: 0.8rem; margin-bottom: 4px;">
                                {% trans "Start Date" %}
                            </label>
                            <input type="datetime-local" class="input-linguify" id="start_date" name="start_date" 
                                   style="font-size: 0.8rem; padding: 6px;"
                                   value="{{ task.start_date|date:'Y-m-d\TH:i'|default:'' }}" form="taskForm">
                        </div>
                        <div>
                            <label for="due_date" class="form-label-linguify" style="font-size: 0.8rem; margin-bottom: 4px;">
                                {% trans "Due Date" %}
                            </label>
                            <input type="datetime-local" class="input-linguify" id="due_date" name="due_date" 
                                   style="font-size: 0.8rem; padding: 6px;"
                                   value="{{ task.due_date|date:'Y-m-d\TH:i'|default:'' }}" form="taskForm">
                        </div>
                    </div>
                    
                    <!-- Tags -->
                    <div style="margin-bottom: 12px;">
                        <label class="form-label-linguify" style="font-size: 0.8rem; margin-bottom: 4px;">
                            {% trans "Tags" %}
                        </label>
                        <div class="tags-container-linguify">
                            <div class="selected-tags-linguify" id="selectedTags">
                                {% for tag in task.tags.all %}
                                <span class="tag-badge-linguify" style="font-size: 0.75rem; padding: 2px 6px;"
                                      data-tag-id="{{ tag.id }}" 
                                      data-bg-color="{{ tag.color }}20"
                                      data-text-color="{{ tag.color }}">
                                    {{ tag.name }}
                                    <button type="button" class="tag-remove-linguify" 
                                            hx-delete="{% url 'todo:tag_remove_htmx' tag.id %}"
                                            hx-vals='js:{"selected": document.getElementById("tagsInput").value}'
                                            hx-target="#selectedTags"
                                            hx-swap="innerHTML">&times;</button>
                                </span>
                                {% endfor %}
                            </div>
                            <div class="tag-input-group-linguify">
                                <input type="text" class="input-linguify input-sm-linguify" id="tagInput" 
                                       style="font-size: 0.8rem; padding: 6px;"
                                       placeholder="{% trans 'Type to search or create tags...' %}"
                                       hx-get="{% url 'todo:tag_search_htmx' %}"
                                       hx-trigger="keyup changed delay:300ms"
                                       hx-target="#tagSuggestions"
                                       hx-vals='js:{"q": document.getElementById("tagInput").value, "selected": document.getElementById("tagsInput").value}'
                                       autocomplete="off">
                                <div class="tag-suggestions-linguify" id="tagSuggestions">
                                    <!-- Tag suggestions will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Info Card -->
            {% if task %}
            <div class="sidebar-card-linguify">
                <div class="sidebar-header-linguify">
                    <h6>{% trans "Information" %}</h6>
                </div>
                <div class="sidebar-content-linguify">
                    <div class="info-item-linguify" style="margin-bottom: 8px;">
                        <small class="info-label">{% trans "Création" %}</small>
                        <div class="info-value" style="font-size: 0.875rem;">{{ task.created_at|date:"M d, Y H:i" }}</div>
                    </div>
                    
                    {% if task.updated_at != task.created_at %}
                    <div class="info-item-linguify" style="margin-bottom: 8px;">
                        <small class="info-label">{% trans "Last Modified" %}</small>
                        <div class="info-value" style="font-size: 0.875rem;">{{ task.updated_at|date:"M d, Y H:i" }}</div>
                    </div>
                    {% endif %}
                    
                    <div class="info-item-linguify">
                        <small class="info-label">{% trans "Status" %}</small>
                        <div class="info-value">
                            <span class="badge-linguify" style="font-size: 0.8rem; padding: 2px 6px;"
                                  data-bg-color="{{ task.personal_stage_type.color }}20"
                                  data-text-color="{{ task.personal_stage_type.color }}">
                                {{ task.personal_stage_type.name }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
        </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- All styles are centralized in tailwind-modals.css -->
<style>
/* Editor.js Custom Styles */
.ce-block__content,
.ce-toolbar__content {
    max-width: 100% !important;
}

.ce-toolbar__plus {
    display: none !important; /* Hide the plus button, we use slash commands */
}

.codex-editor {
    padding: 0 !important;
}

.ce-block {
    padding: 4px 0;
}

.ce-popover {
    z-index: 9999 !important;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- Load Editor.js Dependencies -->
<script src="{% static 'js/commands-editor/editor-cdn.js' %}"></script>
<script src="{% static 'js/commands-editor/linguify-editor.js' %}"></script>

<script>
// Initialize Editor.js for task description
let descriptionEditor = null;

async function initializeDescriptionEditor() {
    try {
        // Load EditorJS dependencies first
        if (typeof window.EditorJSLoader !== 'undefined') {
            const loader = new window.EditorJSLoader();
            await loader.loadAll();
            console.log('✅ Editor.js dependencies loaded');
        }

        // Get initial content from hidden textarea
        const textarea = document.getElementById('description');
        const initialContent = textarea ? textarea.value : '';

        // Create the editor
        if (typeof window.LinguifyEditor !== 'undefined') {
            descriptionEditor = await window.LinguifyEditor.createFromContent(
                'task-description-editor',
                initialContent,
                {
                    placeholder: 'Tapez "/" pour voir les commandes disponibles...',
                    autofocus: false
                }
            );

            console.log('✅ Description editor initialized');

            // Setup auto-save
            const editorElement = document.getElementById('task-description-editor');
            if (editorElement) {
                let saveTimeout;

                // Listen for changes in the editor
                editorElement.addEventListener('input', async () => {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(async () => {
                        const data = await descriptionEditor.save();
                        if (data) {
                            // Update hidden textarea with JSON data
                            textarea.value = JSON.stringify(data);
                            // Trigger HTMX autosave
                            textarea.dispatchEvent(new Event('blur', { bubbles: true }));
                        }
                    }, 1500);
                });

                // Save on Enter key (new block)
                editorElement.addEventListener('keyup', async (e) => {
                    if (e.key === 'Enter') {
                        clearTimeout(saveTimeout);
                        saveTimeout = setTimeout(async () => {
                            const data = await descriptionEditor.save();
                            if (data) {
                                textarea.value = JSON.stringify(data);
                                textarea.dispatchEvent(new Event('blur', { bubbles: true }));
                            }
                        }, 800);
                    }
                });
            }
        }
    } catch (error) {
        console.error('Failed to initialize description editor:', error);
        // Show fallback textarea
        const textarea = document.getElementById('description');
        if (textarea) {
            textarea.style.display = 'block';
        }
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the description editor
    initializeDescriptionEditor();

    // Apply colors to tags and badges using data attributes
    function applyColors() {
        document.querySelectorAll('[data-bg-color], [data-text-color]').forEach(element => {
            const bgColor = element.dataset.bgColor;
            const textColor = element.dataset.textColor;
            if (bgColor) element.style.backgroundColor = bgColor;
            if (textColor) element.style.color = textColor;
        });
    }
    
    // Apply colors on load
    applyColors();
    
    // Re-apply colors after HTMX updates (for tags)
    document.body.addEventListener('htmx:afterSwap', applyColors);
    
    // Simple character count function
    window.updateCharCount = function() {
        const titleInput = document.getElementById('title');
        const charCountSpan = document.getElementById('charCountSpan');
        if (titleInput && charCountSpan) {
            charCountSpan.textContent = titleInput.value.length;
        }
    };
    
    // Smart Cloud Save Indicator - Like Notebook/opla
    let saveTimeout;
    const cloudIndicator = document.getElementById('cloudSaveIndicator');
    
    // Ensure initial state is correct
    if (cloudIndicator) {
        cloudIndicator.classList.remove('show-saved', 'fade-out');
        cloudIndicator.style.display = 'none';
        
        // TEMPORARY: Test function to show cloud indicator
        window.testCloudShow = function() {
            cloudIndicator.style.display = 'inline-flex';
            cloudIndicator.classList.remove('show-saved', 'fade-out');
        };
        
        window.testCloudSaving = function() {
            cloudIndicator.classList.add('show-saved');
        };
        
        window.testCloudHide = function() {
            cloudIndicator.classList.add('fade-out');
            setTimeout(() => {
                cloudIndicator.style.display = 'none';
                cloudIndicator.classList.remove('show-saved', 'fade-out');
            }, 500);
        };
    }
    
    // Show cloud during save
    document.body.addEventListener('htmx:beforeRequest', function(evt) {
        // Only for autosave requests
        if (evt.detail.elt.id === 'taskForm' && cloudIndicator) {
            cloudIndicator.style.display = 'inline-flex';
            cloudIndicator.classList.remove('show-saved', 'fade-out');
        }
    });
    
    // Show success and schedule hide after save
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        // Only for autosave requests
        if (evt.detail.elt.id === 'taskForm' && cloudIndicator) {
            clearTimeout(saveTimeout);
            cloudIndicator.classList.add('show-saved');
            
            // Hide after 2 seconds
            saveTimeout = setTimeout(() => {
                cloudIndicator.classList.add('fade-out');
                setTimeout(() => {
                    cloudIndicator.style.display = 'none';
                    cloudIndicator.classList.remove('show-saved', 'fade-out');
                }, 500); // Wait for fade animation
            }, 2000);
        }
    });
    
    // Keep minimal JavaScript for form submission handling
    document.getElementById('taskForm').addEventListener('submit', function(e) {
        e.preventDefault();
        // HTMX handles the actual submission via hx-post on the save button
    });
    
    // Hide tag suggestions when clicking outside
    const tagInput = document.getElementById('tagInput');
    const tagSuggestions = document.getElementById('tagSuggestions');
    
    if (tagInput && tagSuggestions) {
        document.addEventListener('click', function(e) {
            if (!tagInput.contains(e.target) && !tagSuggestions.contains(e.target)) {
                tagSuggestions.style.display = 'none';
            }
        });
        
        // Handle Enter key in tag input
        tagInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                tagSuggestions.style.display = 'none';
                this.value = '';
            }
        });
    }
});
</script>
{% endblock %}
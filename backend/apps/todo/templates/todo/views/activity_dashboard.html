{% extends "todo/base.html" %}
{% load static %}
{% load i18n %}

{% block page_title %}Todo - Advanced Activity Dashboard{% endblock %}

{% block header_content %}
{% include 'components/todo_navbar.html' with active_view='activity' %}
{% endblock %}

{% block content %}
<div class="unified-table-container-linguify" x-data="{ loaded: false }" x-init="setTimeout(() => loaded = true, 200)">
    <!-- Dashboard Header -->
    <div class="section-header mb-4">
        <div class="section-title">
            <i class="bi bi-graph-up"></i>
            <span>{% trans "Advanced Analytics" %}</span>
        </div>
        <div class="section-actions">
            <select class="form-control-linguify" 
                    hx-get="{% url 'todo:activity_dashboard' %}" 
                    hx-trigger="change" 
                    hx-target="#dashboard-content" 
                    hx-swap="innerHTML"
                    hx-include="this"
                    name="range"
                    style="min-width: 120px;">
                <option value="7" {% if time_range == 7 %}selected{% endif %}>{% trans "7 days" %}</option>
                <option value="30" {% if time_range == 30 %}selected{% endif %}>{% trans "30 days" %}</option>
                <option value="90" {% if time_range == 90 %}selected{% endif %}>{% trans "3 months" %}</option>
                <option value="365" {% if time_range == 365 %}selected{% endif %}>{% trans "1 year" %}</option>
            </select>
        </div>
    </div>

    <div id="dashboard-content">
        <!-- Key Metrics Overview -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" 
             x-show="loaded"
             x-transition:enter="transition ease-out duration-500"
             x-transition:enter-start="opacity-0 transform translate-y-8"
             x-transition:enter-end="opacity-100 transform translate-y-0">
            <!-- Tasks Created -->
            <div class="form-card-linguify text-center">
                <div style="padding: 1.5rem;">
                    <div class="flex items-center justify-center mb-3">
                        <div style="width: 3rem; height: 3rem; background: var(--linguify-primary); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-plus-circle" style="color: white; font-size: 1.25rem;"></i>
                        </div>
                    </div>
                    <div style="font-size: 2rem; font-weight: 700; color: var(--linguify-primary); margin-bottom: 0.5rem;">
                        {{ activity_metrics.total_tasks_created }}
                    </div>
                    <div style="font-size: 0.875rem; font-weight: 600; color: var(--linguify-gray); margin-bottom: 0.5rem;">
                        {% trans "Tasks Created" %}
                    </div>
                    <div style="font-size: 0.75rem; color: var(--linguify-gray-600);">
                        {% trans "in" %} {{ time_range }} {% trans "days" %}
                    </div>
                </div>
            </div>

            <!-- Tasks Completed -->
            <div class="form-card-linguify text-center">
                <div style="padding: 1.5rem;">
                    <div class="flex items-center justify-center mb-3">
                        <div style="width: 3rem; height: 3rem; background: var(--linguify-success); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-check-circle" style="color: white; font-size: 1.25rem;"></i>
                        </div>
                    </div>
                    <div style="font-size: 2rem; font-weight: 700; color: var(--linguify-success); margin-bottom: 0.5rem;">
                        {{ activity_metrics.total_tasks_completed }}
                    </div>
                    <div style="font-size: 0.875rem; font-weight: 600; color: var(--linguify-gray); margin-bottom: 0.5rem;">
                        {% trans "Tasks Completed" %}
                    </div>
                    <div style="font-size: 0.75rem; color: var(--linguify-gray-600);">
                        {{ activity_metrics.completion_rate }}% {% trans "completion rate" %}
                    </div>
                </div>
            </div>

            <!-- Active Tasks -->
            <div class="form-card-linguify text-center">
                <div style="padding: 1.5rem;">
                    <div class="flex items-center justify-center mb-3">
                        <div style="width: 3rem; height: 3rem; background: var(--linguify-warning); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-clock" style="color: white; font-size: 1.25rem;"></i>
                        </div>
                    </div>
                    <div style="font-size: 2rem; font-weight: 700; color: var(--linguify-warning); margin-bottom: 0.5rem;">
                        {{ activity_metrics.total_active_tasks }}
                    </div>
                    <div style="font-size: 0.875rem; font-weight: 600; color: var(--linguify-gray); margin-bottom: 0.5rem;">
                        {% trans "Active Tasks" %}
                    </div>
                    <div style="font-size: 0.75rem; color: var(--linguify-gray-600);">
                        {% trans "currently in progress" %}
                    </div>
                </div>
            </div>

            <!-- Productivity Score -->
            <div class="form-card-linguify text-center">
                <div style="padding: 1.5rem;">
                    <div class="flex items-center justify-center mb-3">
                        <div style="width: 3rem; height: 3rem; background: var(--linguify-secondary); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-trophy" style="color: white; font-size: 1.25rem;"></i>
                        </div>
                    </div>
                    <div style="font-size: 2rem; font-weight: 700; color: var(--linguify-secondary); margin-bottom: 0.5rem;">
                        {{ activity_metrics.productivity_score }}
                    </div>
                    <div style="font-size: 0.875rem; font-weight: 600; color: var(--linguify-gray); margin-bottom: 0.5rem;">
                        {% trans "Productivity Score" %}
                    </div>
                    <div style="font-size: 0.75rem; color: var(--linguify-gray-600);">
                        {% trans "tasks per day" %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Analytics Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6" 
             x-show="loaded"
             x-transition:enter="transition ease-out duration-500 delay-200"
             x-transition:enter-start="opacity-0 transform translate-y-8"
             x-transition:enter-end="opacity-100 transform translate-y-0">
            <!-- Daily Activity Chart -->
            <div class="form-card-linguify">
                <div class="section-header">
                    <div class="section-title">
                        <i class="bi bi-graph-up-arrow"></i>
                        <span>{% trans "Daily Activity" %}</span>
                    </div>
                </div>
                <div style="padding: 1.5rem;">
                    <p style="color: var(--linguify-gray-600); margin-bottom: 1rem;">{% trans "Tasks created and completed over time" %}</p>
                    
                    <!-- Simple List View -->
                    <div style="max-height: 300px; overflow-y: auto;">
                        {% for day_data in daily_activity|slice:":7" %}
                        <div class="flex items-center justify-between" style="padding: 0.75rem; border-bottom: 1px solid var(--linguify-gray-100);">
                            <div style="font-weight: 600; color: var(--linguify-gray-800);">
                                {{ day_data.date|date:'M d' }}
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center space-x-1">
                                    <div style="width: 8px; height: 8px; background: var(--linguify-primary); border-radius: 50%;"></div>
                                    <span style="font-size: 0.875rem; color: var(--linguify-gray-600);">{{ day_data.created }} {% trans "created" %}</span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <div style="width: 8px; height: 8px; background: var(--linguify-success); border-radius: 50%;"></div>
                                    <span style="font-size: 0.875rem; color: var(--linguify-gray-600);">{{ day_data.completed }} {% trans "completed" %}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                </div>

                <!-- Project Activity -->
                <div class="form-card-linguify">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="bi bi-folder"></i>
                            <span>{% trans "Project Activity" %}</span>
                        </div>
                    </div>
                    <div style="padding: 1.5rem;">
                        <p style="color: var(--linguify-gray-600); margin-bottom: 1rem;">{% trans "Most active projects" %}</p>
                        
                        {% if project_activity %}
                        <div style="max-height: 300px; overflow-y: auto;">
                            {% for project in project_activity %}
                            <div style="padding: 1rem; background: var(--linguify-gray-50); border-radius: 8px; margin-bottom: 0.75rem;">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-3">
                                        <div style="width: 12px; height: 12px; background: var(--linguify-secondary); border-radius: 50%;"></div>
                                        <span style="font-weight: 600; color: var(--linguify-gray-800);">{{ project.name }}</span>
                                    </div>
                                    <div style="font-size: 0.875rem; color: var(--linguify-gray-600);">
                                        {{ project.tasks_completed }} / {{ project.tasks_created }}
                                    </div>
                                </div>
                                <div style="width: 100%; background: var(--linguify-gray-200); border-radius: 9999px; height: 6px;">
                                    <div style="background: var(--linguify-secondary); height: 100%; border-radius: 9999px; transition: width 0.5s; width: {% if project.tasks_created > 0 %}{% widthratio project.tasks_completed project.tasks_created 100 %}{% else %}0{% endif %}%;"></div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div style="text-align: center; padding: 3rem; color: var(--linguify-gray-500);">
                            <i class="bi bi-folder" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            <p>{% trans "No project activity yet" %}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Goals Progress -->
        <div class="form-card-linguify mb-6" 
             x-show="loaded"
             x-transition:enter="transition ease-out duration-500 delay-400"
             x-transition:enter-start="opacity-0 transform translate-y-8"
             x-transition:enter-end="opacity-100 transform translate-y-0">
            <div class="section-header">
                <div class="section-title">
                    <i class="bi bi-target"></i>
                    <span>{% trans "Goals Progress" %}</span>
                </div>
            </div>
            <div style="padding: 1.5rem;">
                <p style="color: var(--linguify-gray-600); margin-bottom: 1.5rem;">{% trans "Your productivity targets and achievements" %}</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Daily Goal -->
                    <div style="padding: 1rem; background: var(--linguify-gray-50); border-radius: 8px;">
                        <div class="flex items-center justify-between mb-3">
                            <span style="font-weight: 600; color: var(--linguify-gray-800);">{% trans "Daily Goal" %}</span>
                            <span style="font-size: 0.875rem; color: var(--linguify-gray-600);">{{ goals.daily_progress|floatformat:1 }}%</span>
                        </div>
                        <div style="width: 100%; background: var(--linguify-gray-200); border-radius: 9999px; height: 8px;">
                            <div style="background: var(--linguify-primary); height: 100%; border-radius: 9999px; transition: width 1s; width: {{ goals.daily_progress }}%;"></div>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--linguify-gray-500);">
                            {% trans "Target:" %} {{ goals.daily_goal|floatformat:1 }} {% trans "tasks per day" %}
                        </div>
                    </div>

                    <!-- Weekly Goal -->
                    <div style="padding: 1rem; background: var(--linguify-gray-50); border-radius: 8px;">
                        <div class="flex items-center justify-between mb-3">
                            <span style="font-weight: 600; color: var(--linguify-gray-800);">{% trans "Weekly Goal" %}</span>
                            <span style="font-size: 0.875rem; color: var(--linguify-gray-600);">{{ goals.weekly_progress|floatformat:1 }}%</span>
                        </div>
                        <div style="width: 100%; background: var(--linguify-gray-200); border-radius: 9999px; height: 8px;">
                            <div style="background: var(--linguify-success); height: 100%; border-radius: 9999px; transition: width 1s; width: {{ goals.weekly_progress }}%;"></div>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--linguify-gray-500);">
                            {% trans "Target:" %} {{ goals.weekly_goal }} {% trans "tasks per week" %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Timeline -->
        <div class="timeline-section" 
             x-show="loaded"
             x-transition:enter="transition ease-out duration-500 delay-600"
             x-transition:enter-start="opacity-0 transform translate-y-8"
             x-transition:enter-end="opacity-100 transform translate-y-0">
            <div class="analytics-card">
                <div class="analytics-header">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">{% trans "Recent Activity Timeline" %}</h3>
                    <p class="text-sm text-gray-600">{% trans "Latest task activities and updates" %}</p>
                </div>
                <div class="analytics-content">
                    {% if recent_activities %}
                    <div class="timeline-list space-y-4 max-h-96 overflow-y-auto">
                        {% for activity in recent_activities %}
                        <div class="timeline-activity-item">
                            <div class="flex items-start space-x-3">
                                <div class="timeline-marker-small {% if activity.type == 'task_completed' %}bg-green-500{% else %}bg-blue-500{% endif %}">
                                    <i class="bi {% if activity.type == 'task_completed' %}bi-check{% else %}bi-plus{% endif %} text-white text-xs"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm font-medium {% if activity.type == 'task_completed' %}text-green-700{% else %}text-blue-700{% endif %}">
                                            {% if activity.type == 'task_completed' %}
                                                {% trans "Completed" %}
                                            {% else %}
                                                {% trans "Created" %}
                                            {% endif %}
                                        </span>
                                        <span class="text-xs text-gray-500">{{ activity.timestamp|timesince }} {% trans "ago" %}</span>
                                    </div>
                                    <p class="text-sm text-gray-800 mt-1">{{ activity.task.title }}</p>
                                    {% if activity.task.project %}
                                    <div class="mt-1">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800">
                                            {{ activity.task.project.name }}
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <i class="bi bi-clock-history text-gray-300 text-3xl"></i>
                        <p class="text-gray-500 mt-2">{% trans "No recent activity" %}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% endblock %}

{% block extra_js %}
<script>
// Dashboard specific enhancements
document.addEventListener('htmx:afterSwap', function(e) {
    if (e.detail.target.id === 'dashboard-content') {
        // Trigger Alpine.js animations after HTMX content swap
        setTimeout(() => {
            if (window.Alpine) {
                Alpine.initTree(e.detail.target);
            }
        }, 100);
    }
});
</script>
{% endblock %}
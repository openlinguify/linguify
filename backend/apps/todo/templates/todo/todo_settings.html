<!-- Todo Tab -->
<div id="todo" class="tab-content active">
    <!-- Productivity Settings Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-clock-history"></i>
                Parametres de productivite
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <form id="todo-productivity-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="productivity">

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="enable_time_tracking">
                        Suivi du temps
                    </label>
                    <div class="form-help">Mesurer le temps passe sur chaque tache</div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="pomodoro_timer">
                        Timer Pomodoro
                    </label>
                    <div class="form-help">Utiliser la technique Pomodoro pour la concentration</div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Duree Pomodoro (minutes)</label>
                        <div class="range-input">
                            <input type="range" name="pomodoro_duration" min="5" max="60" value="25" class="form-range">
                            <span class="range-value">25</span>
                        </div>
                        <div class="form-help">Duree des sessions de travail</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Duree des pauses (minutes)</label>
                        <div class="range-input">
                            <input type="range" name="break_duration" min="1" max="30" value="5" class="form-range">
                            <span class="range-value">5</span>
                        </div>
                        <div class="form-help">Duree des pauses entre sessions</div>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <!-- Task Settings Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-list-task"></i>
                Parametres des taches
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <form id="todo-task-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="tasks">

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Vue par defaut des projets</label>
                        <select name="default_project_view" class="form-control">
                            <option value="list">Liste</option>
                            <option value="kanban">Kanban</option>
                            <option value="calendar">Calendrier</option>
                            <option value="timeline">Timeline</option>
                        </select>
                        <div class="form-help">Affichage prefere pour vos projets</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Vue par defaut des taches</label>
                        <select name="default_task_view" class="form-control">
                            <option value="list">Liste</option>
                            <option value="priority">Par priorite</option>
                            <option value="due_date">Par echeance</option>
                            <option value="project">Par projet</option>
                        </select>
                        <div class="form-help">Affichage prefere pour vos taches</div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Priorite par defaut</label>
                        <select name="default_task_priority" class="form-control">
                            <option value="low">Faible</option>
                            <option value="medium">Moyenne</option>
                            <option value="high">Elevee</option>
                            <option value="urgent">Urgente</option>
                        </select>
                        <div class="form-help">Priorite assignee aux nouvelles taches</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Heure de rappel par defaut</label>
                        <input type="time" name="default_reminder_time" value="09:00" class="form-control">
                        <div class="form-help">Heure par defaut pour les rappels</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="auto_archive_completed">
                        Archivage automatique des taches terminees
                    </label>
                    <div class="form-help">Archiver automatiquement les taches apres completion</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Delai d'archivage automatique (jours)</label>
                    <div class="range-input">
                        <input type="range" name="auto_archive_days" min="1" max="365" value="30" class="form-range">
                        <span class="range-value">30</span>
                    </div>
                    <div class="form-help">Nombre de jours avant archivage automatique</div>
                </div>

            </form>
        </div>
    </div>

    <!-- Notifications Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-bell"></i>
                Rappels et notifications
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <form id="todo-notifications-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="notifications">
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="enable_reminders" checked>
                        Activer les rappels
                    </label>
                    <div class="form-help">Recevoir des notifications pour les taches a echeance</div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Rappel avant echeance (minutes)</label>
                        <div class="range-input">
                            <input type="range" name="reminder_minutes_before" min="1" max="1440" value="15" class="form-range">
                            <span class="range-value">15</span>
                        </div>
                        <div class="form-help">Temps d'avance pour les rappels</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" name="daily_digest" checked>
                            Resume quotidien
                        </label>
                        <div class="form-help">Recevoir un resume de vos taches chaque jour</div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Heure du resume quotidien</label>
                        <input type="time" name="daily_digest_time" value="09:00" class="form-control">
                        <div class="form-help">Heure d'envoi du resume quotidien</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" name="overdue_notifications" checked>
                            Notifications de retard
                        </label>
                        <div class="form-help">Etre notifie des taches en retard</div>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <!-- Interface Settings Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-palette"></i>
                Interface et experience
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <form id="todo-interface-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="interface">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Theme</label>
                        <select name="theme" class="form-control">
                            <option value="light">Clair</option>
                            <option value="dark">Sombre</option>
                            <option value="auto">Automatique</option>
                        </select>
                        <div class="form-help">Theme de l'interface utilisateur</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" name="compact_mode">
                            Mode compact
                        </label>
                        <div class="form-help">Interface plus dense avec moins d'espacement</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="show_subtask_count" checked>
                        Afficher le nombre de sous-taches
                    </label>
                    <div class="form-help">Montrer le decompte des sous-taches dans les projets</div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="show_progress_bars" checked>
                        Afficher les barres de progression
                    </label>
                    <div class="form-help">Afficher visuellement le progres des projets</div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="show_completed_tasks" checked>
                        Afficher les taches terminees
                    </label>
                    <div class="form-help">Inclure les taches completees dans la liste</div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="quick_add_shortcut" checked>
                        Raccourci d'ajout rapide
                    </label>
                    <div class="form-help">Activer le raccourci clavier pour ajouter rapidement des taches</div>
                </div>

            </form>
        </div>
    </div>

    <!-- Data Management Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-database"></i>
                Gestion des donnees
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <form id="todo-data-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="data">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Frequence de sauvegarde</label>
                        <select name="backup_frequency" class="form-control">
                            <option value="never">Jamais</option>
                            <option value="daily">Quotidienne</option>
                            <option value="weekly">Hebdomadaire</option>
                            <option value="monthly">Mensuelle</option>
                        </select>
                        <div class="form-help">Frequence des sauvegardes automatiques</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Format d'export</label>
                        <select name="export_format" class="form-control">
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                            <option value="pdf">PDF</option>
                        </select>
                        <div class="form-help">Format prefere pour l'export de donnees</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="allow_task_sharing" checked>
                        Autoriser le partage de taches
                    </label>
                    <div class="form-help">Permettre le partage de taches avec d'autres utilisateurs</div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="allow_project_sharing" checked>
                        Autoriser le partage de projets
                    </label>
                    <div class="form-help">Permettre le partage de projets avec d'autres utilisateurs</div>
                </div>

            </form>
        </div>
    </div>

    <!-- Import/Export Actions Section (Separate from settings) -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-arrow-down-up"></i>
                Actions de données
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                <!-- Export Buttons -->
                <div class="export-actions" style="display: flex; flex-direction: column; gap: 12px; flex: 1; min-width: 300px;">
                    <label style="font-size: 16px; font-weight: 600; color: #495057; margin-bottom: 8px;">
                        <i class="bi bi-download" style="margin-right: 8px;"></i>
                        Exporter vos données
                    </label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <a href="{% url 'todo:activity_export' %}?format=csv" class="btn-export" style="display: inline-flex; align-items: center; padding: 10px 16px; background: #28a745; color: white; text-decoration: none; border-radius: 6px; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s;">
                            <i class="bi bi-filetype-csv" style="margin-right: 6px;"></i>
                            Exporter CSV
                        </a>
                        <a href="{% url 'todo:activity_export' %}?format=json" class="btn-export" style="display: inline-flex; align-items: center; padding: 10px 16px; background: #17a2b8; color: white; text-decoration: none; border-radius: 6px; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s;">
                            <i class="bi bi-filetype-json" style="margin-right: 6px;"></i>
                            Exporter JSON
                        </a>
                        <a href="{% url 'todo:activity_export' %}?format=xlsx" class="btn-export" style="display: inline-flex; align-items: center; padding: 10px 16px; background: #20c997; color: white; text-decoration: none; border-radius: 6px; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s;">
                            <i class="bi bi-file-earmark-excel" style="margin-right: 6px;"></i>
                            Exporter Excel
                        </a>
                    </div>
                    <div style="font-size: 13px; color: #6c757d; margin-top: 4px;">Télécharger toutes vos tâches et projets</div>
                </div>

                <!-- Import Buttons -->
                <div class="import-actions" style="display: flex; flex-direction: column; gap: 12px; flex: 1; min-width: 300px;">
                    <label style="font-size: 16px; font-weight: 600; color: #495057; margin-bottom: 8px;">
                        <i class="bi bi-upload" style="margin-right: 8px;"></i>
                        Importer des données
                    </label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button type="button" 
                                hx-get="{% url 'todo:import_modal' %}" 
                                hx-target="#import-modal-container" 
                                hx-trigger="click"
                                class="btn-import" style="display: inline-flex; align-items: center; padding: 10px 16px; background: #007bff; color: white; border-radius: 6px; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s;">
                            <i class="bi bi-upload" style="margin-right: 6px;"></i>
                            Importer fichier
                        </button>
                        <button type="button" onclick="downloadSampleCSV()" class="btn-sample" style="display: inline-flex; align-items: center; padding: 10px 16px; background: #6c757d; color: white; border-radius: 6px; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s;">
                            <i class="bi bi-download" style="margin-right: 6px;"></i>
                            Exemple CSV
                        </button>
                    </div>
                    <div style="font-size: 13px; color: #6c757d; margin-top: 4px;">Importer des tâches depuis CSV ou JSON</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Save Button for Settings -->
    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: center; border: 1px solid #e9ecef;">
        <div style="margin-bottom: 10px; font-size: 14px; color: #6c757d;">
            Sauvegarder tous les paramètres de configuration Todo
        </div>
        <button type="button" onclick="saveAllTodoSettings()" class="btn-primary" style="padding: 12px 24px; font-size: 16px; min-width: 200px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <i class="bi bi-save"></i>
            Enregistrer tous les paramètres
        </button>
        <div id="save-status" style="margin-top: 10px; font-size: 14px;"></div>
    </div>
</div>

<!-- Import Modal Container -->
<div id="import-modal-container"></div>

<script>
// Function to download sample CSV
function downloadSampleCSV() {
    const csvContent = `title,description,state,priority,project,stage,tags,due_date
"Exemple de tâche 1","Description de la première tâche","To Do","Normal","Mon Projet","To Do","tag1,tag2","2025-12-31T23:59:59"
"Exemple de tâche 2","Autre tâche exemple","In Progress","High","Mon Projet","In Progress","tag2,tag3","2025-11-30T18:00:00"
"Exemple de tâche 3","Tâche complétée","Done","Normal","Autre Projet","Done","tag1","2025-10-15T12:00:00"`;
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'exemple_taches.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Add hover effects for buttons
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects for export buttons
    const exportButtons = document.querySelectorAll('.btn-export');
    exportButtons.forEach(btn => {
        const originalBg = btn.style.backgroundColor;
        btn.addEventListener('mouseover', function() {
            this.style.opacity = '0.9';
            this.style.transform = 'translateY(-1px)';
        });
        btn.addEventListener('mouseout', function() {
            this.style.opacity = '1';
            this.style.transform = 'translateY(0)';
        });
    });
    
    // Add hover effects for import buttons
    const importButtons = document.querySelectorAll('.btn-import, .btn-sample');
    importButtons.forEach(btn => {
        btn.addEventListener('mouseover', function() {
            this.style.opacity = '0.9';
            this.style.transform = 'translateY(-1px)';
        });
        btn.addEventListener('mouseout', function() {
            this.style.opacity = '1';
            this.style.transform = 'translateY(0)';
        });
    });
});

// Function to save all Todo settings
async function saveAllTodoSettings() {
    const button = document.querySelector('button[onclick="saveAllTodoSettings()"]');
    const statusDiv = document.getElementById('save-status');
    
    // Update button state
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Sauvegarde en cours...';
    button.disabled = true;
    button.style.background = '#6c757d';
    statusDiv.innerHTML = '';
    
    try {
        // Get all form data
        const forms = document.querySelectorAll('#todo form');
        const formData = new FormData();
        
        forms.forEach(form => {
            const data = new FormData(form);
            for (let [key, value] of data.entries()) {
                formData.append(key, value);
            }
        });
        
        // Add CSRF token
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('save_all', 'true');
        
        // Send request
        const response = await fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            // Success
            button.innerHTML = '<i class="bi bi-check-circle"></i> Sauvegardé !';
            button.style.background = '#28a745';
            statusDiv.innerHTML = '<span style="color: #28a745; font-weight: 500;"><i class="bi bi-check-circle"></i> Paramètres sauvegardés avec succès</span>';
            
            // Reset button after 2 seconds
            setTimeout(() => {
                button.innerHTML = '<i class="bi bi-save"></i> Enregistrer tous les paramètres';
                button.style.background = '';
                button.disabled = false;
            }, 2000);
        } else {
            throw new Error('Erreur lors de la sauvegarde');
        }
        
    } catch (error) {
        // Error
        button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Erreur';
        button.style.background = '#dc3545';
        statusDiv.innerHTML = '<span style="color: #dc3545; font-weight: 500;"><i class="bi bi-exclamation-triangle"></i> Erreur lors de la sauvegarde</span>';
        
        // Reset button after 3 seconds
        setTimeout(() => {
            button.innerHTML = '<i class="bi bi-save"></i> Enregistrer tous les paramètres';
            button.style.background = '';
            button.disabled = false;
        }, 3000);
    }
}
</script>

<style>
    /* Todo-specific styles */
    #todo .stat-card {
        background: white;
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    #todo .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border-color: var(--card-color);
    }

    #todo .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--card-color);
    }

    #todo .stat-card:nth-child(1) {
        --card-color: #6366f1; /* Indigo for total tasks */
    }

    #todo .stat-card:nth-child(2) {
        --card-color: #10b981; /* Green for completed tasks */
    }

    #todo .stat-card:nth-child(3) {
        --card-color: #f59e0b; /* Orange for active projects */
    }

    #todo .stat-card:nth-child(4) {
        --card-color: #8b5cf6; /* Purple for completion rate */
    }

    #todo .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: var(--card-color);
        margin-bottom: 4px;
    }

    #todo .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    #todo .range-input {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    #todo .range-input .form-range {
        flex: 1;
    }

    #todo .range-value {
        min-width: 30px;
        text-align: center;
        font-weight: 600;
        color: #6366f1;
    }
</style>

<script>
    // Todo Settings JavaScript - Isolated scope
    (function() {
        'use strict';
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTodoSettingsPage);
        } else {
            initTodoSettingsPage();
        }
        
        function initTodoSettingsPage() {
            // Only initialize if we're on the todo settings page
            if (!document.getElementById('todo')) {
                return;
            }
            
            console.log('[TodoSettings] Initializing todo settings page');
            
            // Initialize components
            initRangeSliders();
            initSectionToggles();
            initFormHandlers();
        }
        
        function initRangeSliders() {
            const rangeInputs = document.querySelectorAll('#todo .range-input input[type="range"]');
            rangeInputs.forEach(slider => {
                slider.addEventListener('input', function() {
                    updateRangeValue(this);
                });
                updateRangeValue(slider);
            });
        }
        
        function initSectionToggles() {
            const toggles = document.querySelectorAll('#todo .section-toggle');
            toggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const section = this.closest('.content-section');
                    const content = section.querySelector('.section-content');
                    const icon = this.querySelector('i');
                    
                    if (content.style.display === 'none') {
                        content.style.display = 'block';
                        icon.className = 'bi bi-chevron-up';
                    } else {
                        content.style.display = 'none';
                        icon.className = 'bi bi-chevron-down';
                    }
                });
            });
        }
        
        function initFormHandlers() {
            const forms = document.querySelectorAll('#todo form');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveTodoForm(this);
                });
            });
        }
        
        function updateRangeValue(slider) {
            const valueSpan = slider.parentElement.querySelector('.range-value');
            if (!valueSpan) return;
            
            const value = parseInt(slider.value);
            
            if (slider.name === 'reminder_minutes_before' && value >= 60) {
                const hours = Math.floor(value / 60);
                const minutes = value % 60;
                valueSpan.textContent = hours + 'h' + (minutes > 0 ? minutes + 'm' : '');
            } else if (slider.name === 'auto_archive_days') {
                valueSpan.textContent = value + ' jours';
            } else {
                valueSpan.textContent = value;
            }
        }

        async function saveTodoForm(form) {
            try {
                const formData = new FormData(form);
                const button = form.querySelector('button[type="submit"]');
                const originalText = button.innerHTML;
                
                button.innerHTML = '<i class="bi bi-hourglass"></i> Sauvegarde...';
                button.disabled = true;
                
                const response = await fetch(window.location.pathname, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    button.innerHTML = '<i class="bi bi-check"></i> Enregistré !';
                    button.style.backgroundColor = '#28a745';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.backgroundColor = '';
                        button.disabled = false;
                    }, 2000);
                } else {
                    throw new Error(data.message || 'Erreur de sauvegarde');
                }
                
            } catch (error) {
                console.error('[TodoSettings] Save error:', error);
                const button = form.querySelector('button[type="submit"]');
                button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Erreur';
                button.style.backgroundColor = '#dc3545';
                setTimeout(() => {
                    button.innerHTML = '<i class="bi bi-save"></i> Enregistrer';
                    button.style.backgroundColor = '';
                    button.disabled = false;
                }, 2000);
            }
        }
        
        
    })(); // End of isolated scope
</script>
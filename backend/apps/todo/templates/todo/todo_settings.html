{% load i18n %}
<!-- Todo Tab -->
<div id="todo" class="tab-content active">

    <!-- Task Settings Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-list-task"></i>
                {% trans "Task Settings" %}
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <form id="todo-task-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="tasks">

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">{% trans "Default project view" %}</label>
                        <select name="default_project_view" class="form-control">
                            <option value="list">{% trans "List" %}</option>
                            <option value="kanban">{% trans "Kanban" %}</option>
                            <option value="activity">{% trans "Activity" %}</option>
                        </select>
                        <div class="form-help">{% trans "Preferred display for your projects" %}</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">{% trans "Default task view" %}</label>
                        <select name="default_task_view" class="form-control">
                            <option value="list">{% trans "List" %}</option>
                            <option value="priority">{% trans "By priority" %}</option>
                            <option value="due_date">{% trans "By due date" %}</option>
                            <option value="project">{% trans "By project" %}</option>
                        </select>
                        <div class="form-help">{% trans "Preferred display for your tasks" %}</div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">{% trans "Default priority" %}</label>
                        <select name="default_task_priority" class="form-control">
                            <option value="low">{% trans "Low" %}</option>
                            <option value="medium">{% trans "Medium" %}</option>
                            <option value="high">{% trans "High" %}</option>
                            <option value="urgent">{% trans "Urgent" %}</option>
                        </select>
                        <div class="form-help">{% trans "Priority assigned to new tasks" %}</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">{% trans "Default reminder time" %}</label>
                        <input type="time" name="default_reminder_time" value="09:00" class="form-control">
                        <div class="form-help">{% trans "Default time for reminders" %}</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="auto_archive_completed">
                        {% trans "Automatic archiving" %} of completed tasks
                    </label>
                    <div class="form-help">{% trans "Automatically archive tasks after completion" %}</div>
                </div>

                <div class="form-group">
                    <label class="form-label">{% trans "Automatic archiving delay (days)" %}</label>
                    <div class="range-input">
                        <input type="range" name="auto_archive_days" min="1" max="365" class="form-range">
                        <span class="range-value"></span>
                    </div>
                    <div class="form-help">{% trans "Number of days before automatic archiving" %}</div>
                </div>

            </form>
        </div>
    </div>

    <!-- Notifications Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-bell"></i>
                {% trans "Reminders and notifications" %}
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <form id="todo-notifications-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="notifications">
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="enable_reminders"" checked>
                        {% trans "Enable reminders" %}
                    </label>
                    <div class="form-help">{% trans "Receive notifications for due tasks" %}</div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">{% trans "Reminder before due date (minutes)" %}</label>
                        <div class="range-input">
                            <input type="range" name="reminder_minutes_before" min="1" max="1440" value="15" class="form-range">
                            <span class="range-value">15</span>
                        </div>
                        <div class="form-help">{% trans "Lead time for reminders" %}</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" name="daily_digest" checked>
                            {% trans "Daily digest" %}
                        </label>
                        <div class="form-help">{% trans "Receive a daily summary of your tasks" %}</div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">{% trans "Daily digest time" %}</label>
                        <input type="time" name="daily_digest_time" value="09:00" class="form-control">
                        <div class="form-help">{% trans "Time to send daily digest" %}</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" name="overdue_notifications" checked>
                            {% trans "Overdue notifications" %}
                        </label>
                        <div class="form-help">{% trans "Be notified of overdue tasks" %}</div>
                    </div>
                </div>

            </form>
        </div>
    </div>


    <!-- Data Management Section -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-database"></i>
                {% trans "Data management" %}
            </h3>
            <div class="section-actions">
                <button class="section-toggle">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="section-content">
            <!-- Settings Form -->
            <form id="todo-data-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="data">
                
                <!-- {% trans "Automatic archiving" %} section -->
                <div style="background: var(--linguify-gray-50); padding: 20px; border-radius: 8px; margin-bottom: 24px; border: 1px solid var(--linguify-gray-200);">
                    <div style="display: flex; align-items: center; margin-bottom: 16px;">
                        <i class="bi bi-archive" style="font-size: 18px; color: var(--linguify-blue-500); margin-right: 8px;"></i>
                        <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: #495057;">{% trans "Automatic archiving" %}</h4>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label" style="display: flex; align-items: center; font-size: 14px; color: #495057; margin-bottom: 8px;">
                            <input type="checkbox" name="auto_archive_completed" style="margin-right: 8px;">
                            <strong>{% trans "Enable automatic archiving of completed tasks" %}</strong>
                        </label>
                        <div style="font-size: 13px; color: var(--linguify-gray-500); margin-left: 24px;">
                            {% trans "Automatically move tasks from Done to Archives after configured delay" %}
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" style="font-size: 14px; color: #495057; margin-bottom: 8px; display: block;">
                            {% trans "Automatic archiving delay" %}
                        </label>
                        <div class="range-input" style="display: flex; align-items: center; gap: 12px;">
                            <input type="range" name="auto_archive_days" min="1" max="90" class="form-range" style="flex: 1;">
                            <span class="range-value" style="min-width: 40px; font-weight: 600; color: var(--linguify-blue-600);"></span>
                            <span style="font-size: 13px; color: var(--linguify-gray-500);">{% trans "days" %}</span>
                        </div>
                        <div style="font-size: 13px; color: var(--linguify-gray-500); margin-top: 4px;">
                            {% trans "Number of" %} {% trans "days" %} {% trans "after completion before moving to Archives (maximum 90 days)" %}
                        </div>
                    </div>
                </div>

                <!-- {% trans "Automatic deletion" %} section -->
                <div style="background: var(--linguify-red-50); padding: 20px; border-radius: 8px; margin-bottom: 24px; border: 1px solid var(--linguify-red-200);">
                    <div style="display: flex; align-items: center; margin-bottom: 16px;">
                        <i class="bi bi-trash" style="font-size: 18px; color: var(--linguify-red-500); margin-right: 8px;"></i>
                        <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: #495057;">{% trans "Automatic deletion" %}</h4>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label" style="display: flex; align-items: center; font-size: 14px; color: #495057; margin-bottom: 8px;">
                            <input type="checkbox" name="auto_delete_archived" style="margin-right: 8px;">
                            <strong>{% trans "Enable automatic deletion of old archives" %}</strong>
                        </label>
                        <div style="font-size: 13px; color: var(--linguify-gray-500); margin-left: 24px;">
                            {% trans "Permanently delete tasks from Archives after configured delay" %}
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" style="font-size: 14px; color: #495057; margin-bottom: 8px; display: block;">
                            {% trans "Archive deletion delay" %}
                        </label>
                        <div class="range-input" style="display: flex; align-items: center; gap: 12px;">
                            <input type="range" name="auto_delete_archive_days" min="1" max="90" class="form-range" style="flex: 1;">
                            <span class="range-value" style="min-width: 40px; font-weight: 600; color: var(--linguify-red-600);"></span>
                            <span style="font-size: 13px; color: var(--linguify-gray-500);">{% trans "days" %}</span>
                        </div>
                        <div style="font-size: 13px; color: var(--linguify-gray-500); margin-top: 4px;">
                            {% trans "Number of" %} {% trans "days" %} {% trans "in Archives before permanent deletion (maximum 90 days)" %}
                        </div>
                    </div>
                </div>

                <!-- {% trans "Manual action" %} section -->
                <div style="background: var(--linguify-purple-50); padding: 20px; border-radius: 8px; margin-bottom: 24px; border: 1px solid var(--linguify-purple-200);">
                    <div style="display: flex; align-items: center; margin-bottom: 16px;">
                        <i class="bi bi-play-circle" style="font-size: 18px; color: var(--linguify-purple-500); margin-right: 8px;"></i>
                        <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: #495057;">{% trans "Manual action" %}</h4>
                    </div>
                    
                    <button type="button" onclick="triggerManualArchive()" class="btn-archive" style="display: inline-flex; align-items: center; padding: 12px 20px; background: var(--linguify-purple-500); color: var(--linguify-white); border-radius: 8px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <i class="bi bi-archive" style="margin-right: 8px;"></i>
                        {% trans "Trigger archiving and cleanup now" %}
                    </button>
                    <div style="font-size: 13px; color: var(--linguify-gray-500); margin-top: 8px;">
                        {% trans "Immediately execute archiving and deletion according to your current settings" %}
                    </div>
                    <div id="archive-status" style="margin-top: 12px; font-size: 14px;"></div>
                </div>
            </form>

            <!-- Separator -->
            <hr style="margin: 32px 0; border: none; border-top: 1px solid var(--linguify-gray-200);">

            <!-- Import/Export Actions -->
            <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                <!-- Export Buttons -->
                <div class="export-actions" style="display: flex; flex-direction: column; gap: 12px; flex: 1; min-width: 300px;">
                    <label style="font-size: 16px; font-weight: 600; color: #495057; margin-bottom: 8px;">
                        <i class="bi bi-download" style="margin-right: 8px;"></i>
                        {% trans "Export your data" %}
                    </label>
                    
                    <!-- Export Options -->

                    
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <a href="{% url 'todo:activity_export' %}?format=csv" class="btn-export btn-export-csv" style="display: inline-flex; align-items: center; padding: 10px 16px; background: var(--linguify-green-500); color: var(--linguify-white); text-decoration: none; border-radius: 6px; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s;">
                            <i class="bi bi-filetype-csv" style="margin-right: 6px;"></i>
                            {% trans "Export CSV" %}
                        </a>
                        <a href="{% url 'todo:activity_export' %}?format=json" class="btn-export btn-export-json" style="display: inline-flex; align-items: center; padding: 10px 16px; background: var(--linguify-blue-500); color: var(--linguify-white); text-decoration: none; border-radius: 6px; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s;">
                            <i class="bi bi-filetype-json" style="margin-right: 6px;"></i>
                            {% trans "Export JSON" %}
                        </a>
                        <a href="{% url 'todo:activity_export' %}?format=xlsx" class="btn-export btn-export-excel" style="display: inline-flex; align-items: center; padding: 10px 16px; background: var(--linguify-teal-500); color: var(--linguify-white); text-decoration: none; border-radius: 6px; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s;">
                            <i class="bi bi-file-earmark-excel" style="margin-right: 6px;"></i>
                            {% trans "Export Excel" %}
                        </a>
                    </div>
                    <div style="font-size: 13px; color: var(--linguify-gray-500); margin-top: 4px;">{% trans "Download all your tasks and projects" %}</div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; font-size: 14px; color: #495057; margin-bottom: 8px;">
                            <input type="checkbox" name="include_completed_in_exports" checked style="margin-right: 8px;">
                            {% trans "Include completed tasks in exports" %}
                        </label>
                        <div style="font-size: 13px; color: var(--linguify-gray-500); margin-left: 24px;">{% trans "Also export tasks marked as completed and archived" %}</div>
                    </div>
                </div>

                <!-- Import Buttons -->
                <div class="import-actions" style="display: flex; flex-direction: column; gap: 12px; flex: 1; min-width: 300px;">
                    <label style="font-size: 16px; font-weight: 600; color: #495057; margin-bottom: 8px;">
                        <i class="bi bi-upload" style="margin-right: 8px;"></i>
                        {% trans "Import data" %}
                    </label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button type="button" 
                                hx-get="{% url 'todo:import_modal' %}" 
                                hx-target="#import-modal-container" 
                                hx-trigger="click"
                                class="btn-import" style="display: inline-flex; align-items: center; padding: 10px 16px; background: var(--linguify-gradient); color: var(--linguify-white); border-radius: 6px; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s;">
                            <i class="bi bi-upload" style="margin-right: 6px;"></i>
                            {% trans "Import file" %}
                        </button>
                        <button type="button" onclick="downloadSampleCSV()" class="btn-sample" style="display: inline-flex; align-items: center; padding: 10px 16px; background: var(--linguify-gray-600); color: var(--linguify-white); border-radius: 6px; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s;">
                            <i class="bi bi-download" style="margin-right: 6px;"></i>
                            {% trans "Sample CSV" %}
                        </button>
                    </div>
                    <div style="font-size: 13px; color: var(--linguify-gray-500); margin-top: 4px;">{% trans "Import tasks from CSV or JSON" %}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Save Button for Settings -->
    <div style="margin-top: 30px; padding: 20px; background: var(--linguify-gray-50); border-radius: 8px; text-align: center; border: 1px solid var(--linguify-gray-200);">
        <div style="margin-bottom: 10px; font-size: 14px; color: var(--linguify-gray-500);">
            {% trans "Save all Todo configuration settings" %}
        </div>
        <button type="button" onclick="saveAllTodoSettings()" class="btn-primary" style="padding: 12px 24px; font-size: 16px; min-width: 200px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); background: var(--linguify-gradient); border: none; color: var(--linguify-white);">
            <i class="bi bi-save"></i>
            {% trans "Save all settings" %}
        </button>
        <div id="save-status" style="margin-top: 10px; font-size: 14px;"></div>
    </div>
</div>

<!-- Import Modal Container -->
<div id="import-modal-container"></div>

<script>
// Function to download sample CSV
function downloadSampleCSV() {
    const csvContent = `title,description,state,priority,project,stage,tags,due_date
"Exemple de tâche 1","Description de la première tâche","To Do","Normal","Mon Projet","To Do","tag1,tag2","2025-12-31T23:59:59"
"Exemple de tâche 2","Autre tâche exemple","In Progress","High","Mon Projet","In Progress","tag2,tag3","2025-11-30T18:00:00"
"Exemple de tâche 3","Tâche complétée","Done","Normal","Autre Projet","Done","tag1","2025-10-15T12:00:00"`;
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'exemple_taches.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Add hover effects for buttons
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects for export buttons
    const exportButtons = document.querySelectorAll('.btn-export');
    exportButtons.forEach(btn => {
        const originalBg = btn.style.backgroundColor;
        btn.addEventListener('mouseover', function() {
            this.style.opacity = '0.9';
            this.style.transform = 'translateY(-1px)';
        });
        btn.addEventListener('mouseout', function() {
            this.style.opacity = '1';
            this.style.transform = 'translateY(0)';
        });
    });
    
    // Add hover effects for import buttons
    const importButtons = document.querySelectorAll('.btn-import, .btn-sample');
    importButtons.forEach(btn => {
        btn.addEventListener('mouseover', function() {
            this.style.opacity = '0.9';
            this.style.transform = 'translateY(-1px)';
        });
        btn.addEventListener('mouseout', function() {
            this.style.opacity = '1';
            this.style.transform = 'translateY(0)';
        });
    });
});

// Function to load Todo settings from API
async function loadTodoSettings() {
    console.log('[TodoSettings] Starting to load settings from API...');
    
    try {
        console.log('[TodoSettings] Making fetch request to /todo/settings/');
        const response = await fetch('/todo/settings/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            }
        });
        
        console.log('[TodoSettings] Response status:', response.status);
        console.log('[TodoSettings] Response ok:', response.ok);
        
        if (response.ok) {
            const settings = await response.json();
            console.log('[TodoSettings] Loaded settings from API:', settings);
            
            // Populate form fields with current settings
            populateFormFields(settings);
        } else {
            console.warn('[TodoSettings] API response not ok, status:', response.status);
            const errorText = await response.text();
            console.warn('[TodoSettings] Error response:', errorText);
        }
    } catch (error) {
        console.error('[TodoSettings] Error loading settings:', error);
    }
}

// Function to populate form fields with settings data
function populateFormFields(settings) {
    console.log('[TodoSettings] Populating form fields with:', settings);
    console.log('[TodoSettings] Archive days from API:', settings.auto_archive_days);
    console.log('[TodoSettings] Delete days from API:', settings.auto_delete_archive_days);
    
    Object.keys(settings).forEach(key => {
        const elements = document.querySelectorAll(`[name="${key}"]`);
        elements.forEach(element => {
        if (element) {
            console.log(`[TodoSettings] Setting ${key} = ${settings[key]} (type: ${element.type})`);
            
            if (element.type === 'checkbox') {
                element.checked = settings[key];
            } else if (element.type === 'range') {
                console.log(`[TodoSettings] Updating range ${key}: ${element.value} → ${settings[key]}`);
                element.value = settings[key];
                // Update range display immediately
                const valueDisplay = element.parentNode.querySelector('.range-value');
                if (valueDisplay) {
                    console.log(`[TodoSettings] Found display element for ${key}, updating text: "${valueDisplay.textContent}" → "${settings[key]}"`);
                    valueDisplay.textContent = settings[key];
                } else {
                    console.log(`[TodoSettings] No display element found for ${key} range`);
                }
            } else if (element.tagName === 'SELECT') {
                element.value = settings[key];
            } else if (element.type === 'time') {
                // Convert time format if needed (remove seconds if present)
                let timeValue = settings[key];
                if (timeValue && timeValue.includes(':')) {
                    // Convert from HH:MM:SS to HH:MM
                    timeValue = timeValue.substr(0, 5);
                }
                element.value = timeValue;
            } else {
                element.value = settings[key];
            }
        } else {
            console.log(`[TodoSettings] Element not found for key: ${key}`);
        }
        });
    });
}

// Function to collect all form data
function collectFormData() {
    const forms = document.querySelectorAll('#todo form');
    const settings = {};
    
    forms.forEach(form => {
        // Get all inputs in the form, not just FormData (which skips unchecked checkboxes)
        const inputs = form.querySelectorAll('input, select, textarea');
        
        inputs.forEach(element => {
            const key = element.name;
            if (key && key !== 'setting_type' && key !== 'csrfmiddlewaretoken') {
                if (element.type === 'checkbox') {
                    settings[key] = element.checked;
                } else if (element.type === 'range' || element.type === 'number') {
                    settings[key] = parseInt(element.value) || 0;
                } else if (element.type === 'time') {
                    // Ensure proper time format
                    settings[key] = element.value.includes(':') ? element.value + ':00' : element.value;
                } else {
                    settings[key] = element.value;
                }
            }
        });
    });
    
    // Also collect the export checkbox that's outside forms
    const exportCheckbox = document.querySelector('input[name="include_completed_in_exports"]');
    if (exportCheckbox) {
        settings['include_completed_in_exports'] = exportCheckbox.checked;
    }
    
    return settings;
}

// Function to trigger manual archive
async function triggerManualArchive() {
    const button = document.querySelector('button[onclick="triggerManualArchive()"]');
    const statusDiv = document.getElementById('archive-status');
    
    // Update button state
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> {% trans "Archiving in progress..." %}';
    button.disabled = true;
    button.style.background = 'var(--linguify-gray-600)';
    statusDiv.innerHTML = '';
    
    try {
        const response = await fetch('/todo/archive/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            // Success
            button.innerHTML = '<i class="bi bi-check-circle"></i> {% trans "Archiving completed!" %}';
            button.style.background = 'var(--linguify-green-500)';
            statusDiv.innerHTML = '<span style="color: var(--linguify-green-500); font-weight: 500;"><i class="bi bi-check-circle"></i> ' + result.message + '</span>';
            
            // Reset button after 3 seconds
            setTimeout(() => {
                button.innerHTML = '<i class="bi bi-archive"></i> Déclencher l\'archivage maintenant';
                button.style.background = 'var(--linguify-purple-500)';
                button.disabled = false;
                statusDiv.innerHTML = '';
            }, 3000);
        } else {
            const error = await response.json();
            throw new Error(error.error || '{% trans "Error" %} lors de l\'archivage');
        }
        
    } catch (error) {
        console.error('[TodoArchive] Archive error:', error);
        // Error
        button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> {% trans "Error" %}';
        button.style.background = 'var(--linguify-red-600)';
        statusDiv.innerHTML = '<span style="color: var(--linguify-red-600); font-weight: 500;"><i class="bi bi-exclamation-triangle"></i> ' + error.message + '</span>';
        
        // Reset button after 3 seconds
        setTimeout(() => {
            button.innerHTML = '<i class="bi bi-archive"></i> Déclencher l\'archivage maintenant';
            button.style.background = 'var(--linguify-purple-500)';
            button.disabled = false;
        }, 3000);
    }
}

// Function to save all Todo settings
async function saveAllTodoSettings() {
    const button = document.querySelector('button[onclick="saveAllTodoSettings()"]');
    const statusDiv = document.getElementById('save-status');
    
    // Update button state
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> {% trans "Saving in progress..." %}';
    button.disabled = true;
    button.style.background = 'var(--linguify-gray-600)';
    statusDiv.innerHTML = '';
    
    try {
        // Collect all form data
        const settings = collectFormData();
        console.log('[TodoSettings] Collected settings for save:', settings);
        
        // Specific debug for archiving settings
        console.log('[TodoSettings] Archive settings:', {
            auto_archive_completed: settings.auto_archive_completed,
            auto_archive_days: settings.auto_archive_days,
            auto_delete_archived: settings.auto_delete_archived,
            auto_delete_archive_days: settings.auto_delete_archive_days
        });
        
        // Send to API
        const response = await fetch('/todo/settings/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        });
        
        if (response.ok) {
            const result = await response.json();
            // Success
            button.innerHTML = '<i class="bi bi-check-circle"></i> {% trans "Saved!" %}';
            button.style.background = 'var(--linguify-green-500)';
            statusDiv.innerHTML = '<span style="color: var(--linguify-green-500); font-weight: 500;"><i class="bi bi-check-circle"></i> {% trans "Settings saved successfully" %}</span>';
            
            console.log('[TodoSettings] Settings saved successfully:', result);
            
            // Reset button after 2 seconds
            setTimeout(() => {
                button.innerHTML = '<i class="bi bi-save"></i> {% trans "Save all settings" %}';
                button.style.background = '';
                button.disabled = false;
            }, 2000);
        } else {
            const error = await response.json();
            throw new Error(error.message || '{% trans "Error while saving" %}');
        }
        
    } catch (error) {
        console.error('[TodoSettings] Save error:', error);
        // Error
        button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> {% trans "Error" %}';
        button.style.background = 'var(--linguify-red-600)';
        statusDiv.innerHTML = '<span style="color: var(--linguify-red-600); font-weight: 500;"><i class="bi bi-exclamation-triangle"></i> {% trans "Error while saving" %}</span>';
        
        // Reset button after 3 seconds
        setTimeout(() => {
            button.innerHTML = '<i class="bi bi-save"></i> {% trans "Save all settings" %}';
            button.style.background = '';
            button.disabled = false;
        }, 3000);
    }
}
</script>


<script>
    // Todo Settings JavaScript - Isolated scope
    (function() {
        'use strict';
        
        // Initialize when DOM is ready
        console.log('[TodoSettings] Script loaded, readyState:', document.readyState);
        console.log('[TodoSettings] Todo element exists:', !!document.getElementById('todo'));
        
        if (document.readyState === 'loading') {
            console.log('[TodoSettings] DOM still loading, adding event listener');
            document.addEventListener('DOMContentLoaded', initTodoSettingsPage);
        } else {
            console.log('[TodoSettings] DOM already loaded, initializing immediately');
            initTodoSettingsPage();
        }
        
        function initTodoSettingsPage() {
            // Only initialize if we're on the todo settings page
            if (!document.getElementById('todo')) {
                return;
            }
            
            console.log('[TodoSettings] Initializing todo settings page');
            
            // Initialize components
            initRangeSliders();
            initSectionToggles();
            initFormHandlers();
            
            // Load current settings from API
            loadTodoSettings();
        }
        
        function initRangeSliders() {
            const rangeInputs = document.querySelectorAll('#todo .range-input input[type="range"]');
            rangeInputs.forEach(slider => {
                slider.addEventListener('input', function() {
                    updateRangeValue(this);
                });
                updateRangeValue(slider);
            });
        }
        
        function initSectionToggles() {
            const toggles = document.querySelectorAll('#todo .section-toggle');
            toggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const section = this.closest('.content-section');
                    const content = section.querySelector('.section-content');
                    const icon = this.querySelector('i');
                    
                    if (content.style.display === 'none') {
                        content.style.display = 'block';
                        icon.className = 'bi bi-chevron-up';
                    } else {
                        content.style.display = 'none';
                        icon.className = 'bi bi-chevron-down';
                    }
                });
            });
        }
        
        function initFormHandlers() {
            const forms = document.querySelectorAll('#todo form');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveTodoForm(this);
                });
            });
        }
        
        function updateRangeValue(slider) {
            const valueSpan = slider.parentElement.querySelector('.range-value');
            if (!valueSpan) return;
            
            const value = parseInt(slider.value);
            const min = parseInt(slider.min) || 0;
            const max = parseInt(slider.max) || 100;
            const percentage = ((value - min) / (max - min)) * 100;
            
            // Update the visual progress bar background
            slider.style.background = `linear-gradient(to right, var(--linguify-primary) 0%, var(--linguify-primary) ${percentage}%, var(--linguify-gray-200) ${percentage}%, var(--linguify-gray-200) 100%)`;
            
            // Update the displayed value with appropriate formatting
            if (slider.name === 'reminder_minutes_before' && value >= 60) {
                const hours = Math.floor(value / 60);
                const minutes = value % 60;
                valueSpan.textContent = hours + 'h' + (minutes > 0 ? minutes + 'm' : '');
            } else if (slider.name === 'auto_archive_days') {
                valueSpan.textContent = value + ' {% trans "days" %}';
            } else if (slider.name === 'auto_delete_archive_days') {
                valueSpan.textContent = value + ' {% trans "days" %}';
            } else {
                valueSpan.textContent = value;
            }
        }

        async function saveTodoForm(form) {
            try {
                const formData = new FormData(form);
                const button = form.querySelector('button[type="submit"]');
                const originalText = button.innerHTML;
                
                button.innerHTML = '<i class="bi bi-hourglass"></i> {% trans "Saving..." %}';
                button.disabled = true;
                
                const response = await fetch(window.location.pathname, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    button.innerHTML = '<i class="bi bi-check"></i> {% trans "Saved!" %}';
                    button.style.backgroundColor = 'var(--linguify-green-500)';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.backgroundColor = '';
                        button.disabled = false;
                    }, 2000);
                } else {
                    throw new Error(data.message || '{% trans "Save error" %}');
                }
                
            } catch (error) {
                console.error('[TodoSettings] Save error:', error);
                const button = form.querySelector('button[type="submit"]');
                button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> {% trans "Error" %}';
                button.style.backgroundColor = 'var(--linguify-red-600)';
                setTimeout(() => {
                    button.innerHTML = '<i class="bi bi-save"></i> {% trans "Save" %}';
                    button.style.backgroundColor = '';
                    button.disabled = false;
                }, 2000);
            }
        }
        
        
    })(); // End of isolated scope
</script>
<!-- Profile & Account Tab -->
{% load i18n %}
{% load profile_helpers %}

<!-- Main Settings Form (Hidden) -->
<form method="post" id="main-settings-form" style="display: none;">
  {% csrf_token %}
  <input type="hidden" name="setting_type" value="all_settings">
</form>

<!-- Unified Save Bar -->
<div id="save-bar" class="save-bar" style="display: none; position: fixed; bottom: 20px; right: 20px; background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000;">
  <div style="display: flex; align-items: center; gap: 15px;">
    <span style="color: #666;">{% trans "You have unsaved changes" %}</span>
    <button type="button" class="btn-secondary" onclick="discardChanges()">
      <i class="bi bi-x-circle"></i>
      {% trans "Discard" %}
    </button>
    <button type="button" class="btn-primary" onclick="saveAllSettings()">
      <i class="bi bi-save"></i>
      {% trans "Save All Changes" %}
    </button>
  </div>
</div>

<!-- Success Notification -->
<div id="success-notification" style="display: none; position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1001;">
  <i class="bi bi-check-circle"></i>
  <span>{% trans "Settings saved successfully!" %}</span>
</div>

  <!-- Profile Picture Section (Special case - instant upload) -->
  <div class="content-section">
    <div class="section-header">
      <h3 class="section-title">
        <i class="bi bi-person-circle"></i>
        {% trans "Profile picture" %}
      </h3>
      <div class="section-actions">
        <button class="section-toggle">
          <i class="bi bi-chevron-up"></i>
        </button>
      </div>
    </div>
    <div class="section-content">
      <!-- Current Profile Picture Display -->
      <div class="current-profile-picture mb-4 text-center">
        <div class="profile-picture-container" style="display: inline-block; width: 120px; height: 120px; border-radius: 50%; overflow: hidden; border: 3px solid #e0e0e0;">
          {% if user.get_profile_picture_url %}
            <img src="{{ user.get_profile_picture_url }}" alt="{% trans 'Current profile picture' %}"
                 style="width: 100%; height: 100%; object-fit: cover;" id="current-profile-pic">
          {% else %}
            <div style="width: 100%; height: 100%; background: #f5f5f5; display: flex; align-items: center; justify-content: center; font-size: 48px; color: #999;">
              <i class="bi bi-person-fill"></i>
            </div>
          {% endif %}
        </div>
        <div class="mt-2">
          <small class="text-muted">{% trans "Current profile picture" %}</small>
        </div>
      </div>

      <form method="post" enctype="multipart/form-data" id="profile-picture-form">
        {% csrf_token %}
        <input type="hidden" name="setting_type" value="profile_picture">
        <div class="form-group">
          <label class="form-label">{% trans "Change profile picture" %}</label>
          <input type="file" name="profile_picture" accept="image/*" class="form-control" id="profile-picture-input">
          <div class="form-help">{% trans "Accepted formats: JPG, PNG, WEBP. Max size: 5MB" %}</div>
        </div>
      </form>
    </div>
  </div>


  <!-- Personal Information & Language Section -->
  <div class="content-section">
    <div class="section-header">
      <h3 class="section-title">
        <i class="bi bi-person-lines-fill"></i>
        {% trans "Personal Information" %}
      </h3>
      <div class="section-actions">
        <button class="section-toggle">
          <i class="bi bi-chevron-up"></i>
        </button>
      </div>
    </div>
    <div class="section-content">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">{% trans "First name" %}</label>
          <input type="text" name="first_name" class="form-control settings-input" data-field="first_name" value="{{ user.first_name }}" required>
        </div>
        <div class="form-group">
          <label class="form-label">{% trans "Last name" %}</label>
          <input type="text" name="last_name" class="form-control settings-input" data-field="last_name" value="{{ user.last_name }}" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">{% trans "Email" %}</label>
        <input type="email" class="form-control" value="{{ user.email }}" disabled>
        <div class="form-help">{% trans "Email cannot be changed" %}</div>
      </div>
      <div class="form-group">
        <label class="form-label">{% trans "Phone number" %}</label>
        <input type="tel" name="phone_number" class="form-control settings-input" data-field="phone_number" value="{{ user.phone_number|default:'' }}" placeholder="+32 123 456 789">
        <div class="form-help">{% trans "Optional. Format: +32 123 456 789" %}</div>
      </div>
      <div class="form-group">
        <label class="form-label">{% trans "Username" %}</label>
        <input type="text" name="username" class="form-control settings-input" data-field="username" value="{{ user.username }}" required>
      </div>
      <div class="form-group">
        <label class="form-label">{% trans "Biography" %}</label>
        <textarea name="bio" class="form-control settings-input" data-field="bio" rows="3" placeholder="{% trans 'Tell us about yourself...' %}">{{ user.bio|default:'' }}</textarea>
      </div>
      <div class="form-group">
        <label class="form-label">{% trans "Interface Language" %}</label>
        <div class="form-help">{% trans "Choose the display language for the Linguify interface" %}</div>
        <select name="interface_language" class="form-control" id="interface-language-select" data-auto-save="true">
          <option value="fr" {% if user.userprofile.interface_language == 'fr' %}selected{% endif %}>🇫🇷 Français</option>
          <option value="en" {% if user.userprofile.interface_language == 'en' %}selected{% endif %}>🇬🇧 English</option>
          <option value="nl" {% if user.userprofile.interface_language == 'nl' %}selected{% endif %}>🇳🇱 Nederlands</option>
          <option value="es" {% if user.userprofile.interface_language == 'es' %}selected{% endif %}>🇪🇸 Español</option>
        </select>
      </div>
    </div>
  </div>



  <!-- Privacy & Security Section -->
  <div class="content-section">
    <div class="section-header">
      <h3 class="section-title">
        <i class="bi bi-shield-lock"></i>
        {% trans "Privacy & Security" %}
      </h3>
      <div class="section-actions">
        <button class="section-toggle">
          <i class="bi bi-chevron-up"></i>
        </button>
      </div>
    </div>
    <div class="section-content">
      <div class="form-group">
        <label class="form-label">
          <input type="checkbox" name="public_profile" class="settings-checkbox" data-field="public_profile" {% if user.public_profile %}checked{% endif %}>
          {% trans "Public profile" %}
        </label>
        <div class="form-help">{% trans "Allow other users to see your profile" %}</div>
      </div>
      <div class="form-group">
        <label class="form-label">
          <input type="checkbox" name="share_progress" class="settings-checkbox" data-field="share_progress" {% if user.share_progress %}checked{% endif %}>
          {% trans "Share my progress" %}
        </label>
        <div class="form-help">{% trans "Display your learning stats on your profile" %}</div>
      </div>
    </div>
  </div>

  <!-- Learning Preferences Section -->
  <div class="content-section">
    <div class="section-header">
      <h3 class="section-title">
        <i class="bi bi-book"></i>
        {% trans "Learning Preferences" %}
      </h3>
      <div class="section-actions">
        <button class="section-toggle">
          <i class="bi bi-chevron-up"></i>
        </button>
      </div>
    </div>
    <div class="section-content">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">{% trans "Native Language" %}</label>
          <select name="native_language" class="form-control settings-input" data-field="native_language">
            <option value="fr" selected>🇫🇷 Français</option>
            <option value="en">🇬🇧 English</option>
            <option value="nl">🇳🇱 Nederlands</option>
            <option value="es">🇪🇸 Español</option>
            <option value="de">🇩🇪 Deutsch</option>
            <option value="it">🇮🇹 Italiano</option>
          </select>
          <div class="form-help">{% trans "Your native language for translations" %}</div>
        </div>
        <div class="form-group">
          <label class="form-label">{% trans "Target Language" %}</label>
          <select name="target_language" class="form-control settings-input" data-field="target_language">
            <option value="en" selected>🇬🇧 English</option>
            <option value="fr">🇫🇷 Français</option>
            <option value="nl">🇳🇱 Nederlands</option>
            <option value="es">🇪🇸 Español</option>
            <option value="de">🇩🇪 Deutsch</option>
            <option value="it">🇮🇹 Italiano</option>
            <option value="pt">🇵🇹 Português</option>
            <option value="zh">🇨🇳 中文</option>
            <option value="ja">🇯🇵 日本語</option>
            <option value="ko">🇰🇷 한국어</option>
          </select>
          <div class="form-help">{% trans "Language you are currently learning" %}</div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">{% trans "Learning Level" %}</label>
          <select name="learning_level" class="form-control settings-input" data-field="learning_level">
            <option value="beginner">{% trans "Beginner (A1-A2)" %}</option>
            <option value="intermediate" selected>{% trans "Intermediate (B1-B2)" %}</option>
            <option value="advanced">{% trans "Advanced (C1-C2)" %}</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">{% trans "Daily Goal" %}</label>
          <select name="daily_goal" class="form-control settings-input" data-field="daily_goal">
            <option value="5">{% trans "5 minutes (Casual)" %}</option>
            <option value="10">{% trans "10 minutes (Regular)" %}</option>
            <option value="15" selected>{% trans "15 minutes (Serious)" %}</option>
            <option value="30">{% trans "30 minutes (Intense)" %}</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">{% trans "Learning Methods" %}</label>
        <div class="checkbox-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
          <label class="form-label">
            <input type="checkbox" name="flashcards_enabled" class="settings-checkbox" data-field="flashcards_enabled" checked>
            {% trans "Flashcards" %}
          </label>
          <label class="form-label">
            <input type="checkbox" name="listening_enabled" class="settings-checkbox" data-field="listening_enabled" checked>
            {% trans "Listening exercises" %}
          </label>
          <label class="form-label">
            <input type="checkbox" name="speaking_enabled" class="settings-checkbox" data-field="speaking_enabled">
            {% trans "Speaking practice" %}
          </label>
          <label class="form-label">
            <input type="checkbox" name="grammar_enabled" class="settings-checkbox" data-field="grammar_enabled" checked>
            {% trans "Grammar lessons" %}
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Notifications & Reminders Section -->
  <div class="content-section">
    <div class="section-header">
      <h3 class="section-title">
        <i class="bi bi-bell"></i>
        {% trans "Notifications & Reminders" %}
      </h3>
      <div class="section-actions">
        <button class="section-toggle">
          <i class="bi bi-chevron-up"></i>
        </button>
      </div>
    </div>
    <div class="section-content">
      <div class="form-group">
        <label class="form-label">
          <input type="checkbox" name="daily_reminder" class="settings-checkbox" data-field="daily_reminder" checked>
          {% trans "Daily study reminder" %}
        </label>
        <div class="form-help">{% trans "Get reminded to practice every day" %}</div>
      </div>
      <div class="form-group">
        <label class="form-label">
          <input type="checkbox" name="streak_notifications" class="settings-checkbox" data-field="streak_notifications" checked>
          {% trans "Streak notifications" %}
        </label>
        <div class="form-help">{% trans "Celebrate your learning streaks" %}</div>
      </div>
      <div class="form-group">
        <label class="form-label">
          <input type="checkbox" name="achievement_notifications" class="settings-checkbox" data-field="achievement_notifications" checked>
          {% trans "Achievement notifications" %}
        </label>
        <div class="form-help">{% trans "Get notified when you reach milestones" %}</div>
      </div>
      <div class="form-group">
        <label class="form-label">{% trans "Reminder Time" %}</label>
        <input type="time" name="reminder_time" class="form-control settings-input" data-field="reminder_time" value="18:00">
        <div class="form-help">{% trans "When to receive your daily reminder" %}</div>
      </div>
    </div>
  </div>

<!-- Unified Settings JavaScript -->
<script>
let settingsChanged = false;
let originalValues = {};

document.addEventListener('DOMContentLoaded', function() {
    // Store original values
    document.querySelectorAll('.settings-input, .settings-checkbox').forEach(input => {
        const field = input.dataset.field;
        if (input.type === 'checkbox') {
            originalValues[field] = input.checked;
        } else {
            originalValues[field] = input.value;
        }
    });

    // Track changes
    document.querySelectorAll('.settings-input, .settings-checkbox').forEach(input => {
        input.addEventListener('change', function() {
            checkForChanges();
        });
        input.addEventListener('input', function() {
            checkForChanges();
        });
    });

    // Profile picture instant upload
    const fileInput = document.getElementById('profile-picture-input');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const currentPic = document.getElementById('current-profile-pic');
                    if (currentPic) {
                        currentPic.src = e.target.result;
                    } else {
                        const container = document.querySelector('.profile-picture-container');
                        container.innerHTML = '<img src="' + e.target.result + '" alt="Preview" style="width: 100%; height: 100%; object-fit: cover;" id="current-profile-pic">';
                    }
                };
                reader.readAsDataURL(file);

                // Auto upload
                const formData = new FormData();
                formData.append('profile_picture', file);
                formData.append('setting_type', 'profile_picture');
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('{% trans "Profile picture updated!" %}');
                        if (data.profile_picture_url) {
                            document.getElementById('current-profile-pic').src = data.profile_picture_url + '?t=' + Date.now();
                        }
                    }
                });
            }
        });
    }

    // Language auto-save
    const languageSelect = document.getElementById('interface-language-select');
    if (languageSelect) {
        languageSelect.addEventListener('change', function() {
            const formData = new FormData();
            formData.append('interface_language', this.value);
            formData.append('setting_type', 'language');
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('{% trans "Language updated! Reloading..." %}');
                    setTimeout(() => window.location.reload(), 1000);
                }
            });
        });
    }
});

function checkForChanges() {
    let hasChanges = false;

    document.querySelectorAll('.settings-input, .settings-checkbox').forEach(input => {
        const field = input.dataset.field;
        if (!field) return;

        if (input.type === 'checkbox') {
            if (input.checked !== originalValues[field]) {
                hasChanges = true;
            }
        } else {
            if (input.value !== originalValues[field]) {
                hasChanges = true;
            }
        }
    });

    settingsChanged = hasChanges;
    document.getElementById('save-bar').style.display = hasChanges ? 'block' : 'none';
}

function discardChanges() {
    document.querySelectorAll('.settings-input, .settings-checkbox').forEach(input => {
        const field = input.dataset.field;
        if (!field) return;

        if (input.type === 'checkbox') {
            input.checked = originalValues[field];
        } else {
            input.value = originalValues[field];
        }
    });

    settingsChanged = false;
    document.getElementById('save-bar').style.display = 'none';
}

function saveAllSettings() {
    const formData = new FormData();

    // Collect all changed values
    document.querySelectorAll('.settings-input, .settings-checkbox').forEach(input => {
        const field = input.dataset.field;
        if (!field) return;

        if (input.type === 'checkbox') {
            formData.append(field, input.checked ? 'on' : '');
        } else {
            formData.append(field, input.value);
        }
    });

    formData.append('setting_type', 'all_settings');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    // Show saving state
    const saveBtn = document.querySelector('#save-bar .btn-primary');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> {% trans "Saving..." %}';
    saveBtn.disabled = true;

    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update original values
            document.querySelectorAll('.settings-input, .settings-checkbox').forEach(input => {
                const field = input.dataset.field;
                if (!field) return;

                if (input.type === 'checkbox') {
                    originalValues[field] = input.checked;
                } else {
                    originalValues[field] = input.value;
                }
            });

            settingsChanged = false;
            document.getElementById('save-bar').style.display = 'none';
            showNotification('{% trans "Settings saved successfully!" %}');
        } else {
            saveBtn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> {% trans "Error" %}';
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Save error:', error);
        saveBtn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> {% trans "Error" %}';
        setTimeout(() => {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }, 2000);
    });
}

function showNotification(message) {
    const notification = document.getElementById('success-notification');
    notification.querySelector('span').textContent = message;
    notification.style.display = 'block';

    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// Warn before leaving with unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (settingsChanged) {
        e.preventDefault();
        e.returnValue = '{% trans "You have unsaved changes. Are you sure you want to leave?" %}';
    }
});
</script>
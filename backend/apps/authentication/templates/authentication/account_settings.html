<!-- Profile & Account Tab -->
{% load i18n %}
{% load profile_helpers %}
  <!-- Profile Picture Section -->
  <div class="content-section">
    <div class="section-header">
      <h3 class="section-title">
        <i class="bi bi-person-circle"></i>
        {% trans "Profile picture" %}
      </h3>
      <div class="section-actions">
        <button class="section-toggle">
          <i class="bi bi-chevron-up"></i>
        </button>
      </div>
    </div>
    <div class="section-content">
      <!-- Current Profile Picture Display -->
      <div class="current-profile-picture mb-4 text-center">
        <div class="profile-picture-container" style="display: inline-block; width: 120px; height: 120px; border-radius: 50%; overflow: hidden; border: 3px solid #e0e0e0;">
          {% if user.get_profile_picture_url %}
            <img src="{{ user.get_profile_picture_url }}" alt="{% trans 'Current profile picture' %}" 
                 style="width: 100%; height: 100%; object-fit: cover;" id="current-profile-pic">
          {% else %}
            <div style="width: 100%; height: 100%; background: #f5f5f5; display: flex; align-items: center; justify-content: center; font-size: 48px; color: #999;">
              <i class="bi bi-person-fill"></i>
            </div>
          {% endif %}
        </div>
        <div class="mt-2">
          <small class="text-muted">{% trans "Current profile picture" %}</small>
        </div>
      </div>
      
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="setting_type" value="profile">
        <div class="form-group">
          <label class="form-label">{% trans "Change profile picture" %}</label>
          <input type="file" name="profile_picture" accept="image/*" class="form-control" id="profile-picture-input">
          <div class="form-help">{% trans "Accepted formats: JPG, PNG, WEBP. Max size: 5MB" %}</div>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn-primary">
            <i class="bi bi-upload"></i>
            {% trans "Upload" %}
          </button>
        </div>
      </form>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('profile-picture-input');
    const currentProfilePic = document.getElementById('current-profile-pic');
    const form = fileInput.closest('form');
    
    // Preview selected image
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                if (currentProfilePic) {
                    currentProfilePic.src = e.target.result;
                } else {
                    // If no current image, replace the placeholder
                    const container = document.querySelector('.profile-picture-container');
                    container.innerHTML = '<img src="' + e.target.result + '" alt="Preview" style="width: 100%; height: 100%; object-fit: cover;" id="current-profile-pic">';
                }
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Handle form submission with AJAX for better UX
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> {% trans "Uploading..." %}';
        submitBtn.disabled = true;
        
        fetch(form.action || window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Success feedback
                submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> {% trans "Uploaded!" %}';
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-success');
                
                // Update image if new URL provided
                if (data.profile_picture_url && currentProfilePic) {
                    // Add cache buster to force image refresh
                    currentProfilePic.src = data.profile_picture_url + '?t=' + Date.now();
                }
                
                // Reset form
                fileInput.value = '';
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.classList.remove('btn-success');
                    submitBtn.classList.add('btn-primary');
                    submitBtn.disabled = false;
                }, 2000);
            } else {
                // Error feedback
                submitBtn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> {% trans "Error" %}';
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-danger');
                
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.classList.remove('btn-danger');
                    submitBtn.classList.add('btn-primary');
                    submitBtn.disabled = false;
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            submitBtn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> {% trans "Error" %}';
            submitBtn.classList.remove('btn-primary');
            submitBtn.classList.add('btn-danger');
            
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.classList.remove('btn-danger');
                submitBtn.classList.add('btn-primary');
                submitBtn.disabled = false;
            }, 2000);
        });
    });
});
</script>

  <!-- Personal Information Section -->
  <div class="content-section">
    <div class="section-header">
      <h3 class="section-title">
        <i class="bi bi-person-lines-fill"></i>
        {% trans "Personal information" %}
      </h3>
      <div class="section-actions">
        <button class="section-toggle">
          <i class="bi bi-chevron-up"></i>
        </button>
      </div>
    </div>
    <div class="section-content">
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="setting_type" value="profile">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">{% trans "First name" %}</label>
            <input type="text" name="first_name" class="form-control" value="{{ user.first_name }}" required>
          </div>
          <div class="form-group">
            <label class="form-label">{% trans "Last name" %}</label>
            <input type="text" name="last_name" class="form-control" value="{{ user.last_name }}" required>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">{% trans "Email" %}</label>
          <input type="email" name="email" class="form-control" value="{{ user.email }}" disabled>
          <div class="form-help">{% trans "Email cannot be changed" %}</div>
        </div>
        <div class="form-group">
          <label class="form-label">{% trans "Phone number" %}</label>
          <input type="tel" name="phone_number" class="form-control" value="{{ user.phone_number|default:'' }}" placeholder="+32 123 456 789">
          <div class="form-help">{% trans "Optional. Format: +32 123 456 789" %}</div>
        </div>
        <div class="form-group">
          <label class="form-label">{% trans "Username" %}</label>
          <input type="text" name="username" class="form-control" value="{{ user.username }}" required>
        </div>
        <div class="form-group">
          <label class="form-label">{% trans "Biography" %}</label>
          <textarea name="bio" class="form-control" rows="3" placeholder="{% trans 'Tell us about yourself...' %}">{{ user.bio|default:'' }}</textarea>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn-primary">
            <i class="bi bi-save"></i>
            {% trans "Save" %}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Privacy & Security Section -->
  <div class="content-section">
    <div class="section-header">
      <h3 class="section-title">
        <i class="bi bi-shield-lock"></i>
        {% trans "Privacy & Security" %}
      </h3>
      <div class="section-actions">
        <button class="section-toggle">
          <i class="bi bi-chevron-up"></i>
        </button>
      </div>
    </div>
    <div class="section-content">
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="setting_type" value="privacy">
        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" name="public_profile" {% if user.public_profile %}checked{% endif %}>
            {% trans "Public profile" %}
          </label>
          <div class="form-help">{% trans "Allow other users to see your profile" %}</div>
        </div>
        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" name="share_progress" {% if user.share_progress %}checked{% endif %}>
            {% trans "Share my progress" %}
          </label>
          <div class="form-help">{% trans "Display your learning stats on your profile" %}</div>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn-primary">
            <i class="bi bi-save"></i>
            {% trans "Save" %}
          </button>
        </div>
      </form>
    </div>
  </div>
<!-- Profile & Account Tab -->
{% load i18n %}

<!-- HTMX Success/Error Messages -->
<div id="htmx-messages" style="position: fixed; top: 20px; right: 20px; z-index: 1001;"></div>

  <!-- Profile Picture Section (Special case - instant upload) -->
  <div class="content-section">
    <div class="section-header">
      <h3 class="section-title">
        <i class="bi bi-person-circle"></i>
        {% trans "Profile picture" %}
      </h3>
      <div class="section-actions">
        <button class="section-toggle">
          <i class="bi bi-chevron-up"></i>
        </button>
      </div>
    </div>
    <div class="section-content">
      <!-- Current Profile Picture Display -->
      <div class="current-profile-picture mb-4 text-center">
        <div class="profile-picture-container" style="display: inline-block; width: 120px; height: 120px; border-radius: 50%; overflow: hidden; border: 3px solid #e0e0e0;">
          {% if user.get_profile_picture_url %}
            <img src="{{ user.get_profile_picture_url }}" alt="{% trans 'Current profile picture' %}"
                 style="width: 100%; height: 100%; object-fit: cover;" id="current-profile-pic">
          {% else %}
            <div style="width: 100%; height: 100%; background: #f5f5f5; display: flex; align-items: center; justify-content: center; font-size: 48px; color: #999;">
              <i class="bi bi-person-fill"></i>
            </div>
          {% endif %}
        </div>
        <div class="mt-2">
          <small class="text-muted">{% trans "Current profile picture" %}</small>
        </div>
      </div>

      <form method="post" enctype="multipart/form-data" id="profile-picture-form"
            hx-post="/settings/"
            hx-target="#htmx-messages"
            hx-swap="innerHTML"
            hx-encoding="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="setting_type" value="profile">
        <div class="form-group">
          <label class="form-label">{% trans "Change profile picture" %}</label>
          <input type="file" name="profile_picture" accept="image/*" class="form-control" id="profile-picture-input">
          <div class="form-help">{% trans "Accepted formats: JPG, PNG, WEBP. Max size: 5MB" %}</div>
        </div>
      </form>
    </div>
  </div>


  <!-- Personal Information & Language Section -->
  <div class="content-section">
    <div class="section-header">
      <h3 class="section-title">
        <i class="bi bi-person-lines-fill"></i>
        {% trans "Personal Information" %}
      </h3>
      <div class="section-actions">
        <button class="section-toggle">
          <i class="bi bi-chevron-up"></i>
        </button>
      </div>
    </div>
    <div class="section-content">
      <form hx-post="/settings/"
            hx-trigger="change delay:500ms from:input,textarea"
            hx-target="#htmx-messages"
            hx-swap="innerHTML">
        {% csrf_token %}
        <input type="hidden" name="setting_type" value="profile">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">{% trans "First name" %}</label>
            <input type="text" name="first_name" class="form-control" value="{{ user.first_name }}" required>
          </div>
          <div class="form-group">
            <label class="form-label">{% trans "Last name" %}</label>
            <input type="text" name="last_name" class="form-control" value="{{ user.last_name }}" required>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">{% trans "Email" %}</label>
          <input type="email" class="form-control" value="{{ user.email }}" disabled>
          <div class="form-help">{% trans "Email cannot be changed" %}</div>
        </div>
        <div class="form-group">
          <label class="form-label">{% trans "Phone number" %}</label>
          <input type="tel" name="phone_number" class="form-control" value="{{ user.phone_number|default:'' }}" placeholder="+32 123 456 789">
          <div class="form-help">{% trans "Optional. Format: +32 123 456 789" %}</div>
        </div>
        <div class="form-group">
          <label class="form-label">{% trans "Username" %}</label>
          <input type="text" name="username" class="form-control" value="{{ user.username }}" required>
        </div>
        <div class="form-group">
          <label class="form-label">{% trans "Biography" %}</label>
          <textarea name="bio" class="form-control" rows="3" placeholder="{% trans 'Tell us about yourself...' %}">{{ user.bio|default:'' }}</textarea>
        </div>
      </form>
      <div class="form-group">
        <label class="form-label">{% trans "Interface Language" %}</label>
        <div class="form-help">{% trans "Choose the display language for the Linguify interface" %}</div>
        <form hx-post="/settings/"
              hx-trigger="change"
              hx-target="#htmx-messages"
              hx-swap="innerHTML">
          {% csrf_token %}
          <input type="hidden" name="setting_type" value="language">
          <select name="interface_language" class="form-control" id="interface-language-select">
            <option value="fr" {% if user.interface_language == 'fr' %}selected{% endif %}>ðŸ‡«ðŸ‡· FranÃ§ais</option>
            <option value="en" {% if user.interface_language == 'en' %}selected{% endif %}>ðŸ‡¬ðŸ‡§ English</option>
            <option value="nl" {% if user.interface_language == 'nl' %}selected{% endif %}>ðŸ‡³ðŸ‡± Nederlands</option>
            <option value="es" {% if user.interface_language == 'es' %}selected{% endif %}>ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
          </select>
        </form>
      </div>
    </div>
  </div>



  <!-- Privacy & Security Section -->
  <div class="content-section">
    <div class="section-header">
      <h3 class="section-title">
        <i class="bi bi-shield-lock"></i>
        {% trans "Privacy & Security" %}
      </h3>
      <div class="section-actions">
        <button class="section-toggle">
          <i class="bi bi-chevron-up"></i>
        </button>
      </div>
    </div>
    <div class="section-content">
      <form hx-post="/settings/"
            hx-trigger="change from:input"
            hx-target="#htmx-messages"
            hx-swap="innerHTML">
        {% csrf_token %}
        <input type="hidden" name="setting_type" value="privacy">
        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" name="public_profile" {% if user.public_profile %}checked{% endif %}>
            {% trans "Public profile" %}
          </label>
          <div class="form-help">{% trans "Allow other users to see your profile" %}</div>
        </div>
        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" name="share_progress" {% if user.share_progress %}checked{% endif %}>
            {% trans "Share my progress" %}
          </label>
          <div class="form-help">{% trans "Display your learning stats on your profile" %}</div>
        </div>
      </form>
    </div>
  </div>

  <!-- Note: Learning Preferences and Study Notifications have been moved to Language Learning settings -->

<!-- Minimal JavaScript for HTMX enhancements -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Profile picture preview and auto-upload
    const fileInput = document.getElementById('profile-picture-input');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const currentPic = document.getElementById('current-profile-pic');
                    if (currentPic) {
                        currentPic.src = e.target.result;
                    } else {
                        const container = document.querySelector('.profile-picture-container');
                        container.innerHTML = '<img src="' + e.target.result + '" alt="Preview" style="width: 100%; height: 100%; object-fit: cover;" id="current-profile-pic">';
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
});

// HTMX event handlers
document.body.addEventListener('htmx:afterSwap', function(evt) {
    const messages = document.querySelector('#htmx-messages');
    if (messages && messages.innerHTML) {
        // Auto-hide messages after 3 seconds
        setTimeout(() => {
            messages.innerHTML = '';
        }, 3000);

        // Reload page if language changed
        if (messages.innerHTML.includes('language-changed')) {
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
    }
});
</script>
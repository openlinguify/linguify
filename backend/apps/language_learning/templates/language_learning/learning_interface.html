{% extends "saas_web/base.html" %}
{% load static %}

{% block app_title %}Linguify Learn - {{ selected_language_name|default:"Cours" }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/tailwind-learning.css' %}">
{% endblock %}

{% block header_content %}
{% include 'language_learning/components/navbar.html' %}
{% endblock %}

{% block content %}
<div id="learning-content" class="learning-container" x-data="{ sidebarOpen: false, activeUnit: {{ active_unit_id|default:1 }} }">
    {% if selected_language %}
    <!-- Sidebar avec les unités -->
    <aside class="sidebar-units" :class="{ 'open': sidebarOpen }">
        <div class="sidebar-units-header">
            <h5 class="sidebar-units-title">
                <i class="bi bi-book-fill" style="color: var(--linguify-primary);"></i>
                Unités du cours
            </h5>
        </div>

        <div class="units-list">
            {% for unit in course_units %}
            <div
                class="unit-card {% if unit.progress_percentage == 100 %}completed{% endif %}"
                :class="{ 'active': activeUnit === {{ unit.id }} }"
                @click="activeUnit = {{ unit.id }}; sidebarOpen = false"
                hx-get="{% url 'language_learning:unit_modules' unit.id %}"
                hx-target="#modules-content"
                hx-trigger="click"
            >
                <div class="unit-header">
                    <span class="unit-number">Unité {{ unit.unit_number }}</span>
                    <span class="unit-modules-count">
                        <i class="bi bi-layers-fill" style="margin-right: 0.25rem;"></i>
                        {{ unit.modules_count }} modules
                    </span>
                </div>
                <h6 class="unit-title">{{ unit.title }}</h6>
                <p class="unit-description">{{ unit.description }}</p>

                <div class="unit-progress">
                    <div class="unit-progress-bar" style="width: {{ unit.progress_percentage }}%"></div>
                </div>
                <div class="unit-progress-text">
                    <i class="bi bi-check-circle-fill" style="color: var(--linguify-success);"></i>
                    {{ unit.completed_modules }}/{{ unit.modules_count }} complétés
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <i class="bi bi-inbox empty-state-icon"></i>
                <p class="empty-state-description">
                    Aucune unité disponible pour cette langue.
                </p>
            </div>
            {% endfor %}
        </div>
    </aside>

    <!-- Zone de contenu principal -->
    <main class="content-area">
        <div class="content-wrapper">
            <!-- Informations de progression -->
            <div id="progress-info" class="progress-grid">
                <div class="progress-card progress-card-primary">
                    <div class="flex justify-between items-start">
                        <div>
                            <h6 class="progress-card-label">Niveau actuel</h6>
                            <p class="progress-card-value">{{ user_progress.level|default:1 }}</p>
                        </div>
                        <i class="bi bi-trophy-fill progress-card-icon"></i>
                    </div>
                </div>

                <div class="progress-card progress-card-success">
                    <div class="flex justify-between items-start">
                        <div>
                            <h6 class="progress-card-label">XP Total</h6>
                            <p class="progress-card-value">{{ user_progress.total_xp|default:0 }}</p>
                        </div>
                        <i class="bi bi-star-fill progress-card-icon"></i>
                    </div>
                </div>

                <div class="progress-card progress-card-info">
                    <div class="flex justify-between items-start">
                        <div>
                            <h6 class="progress-card-label">Progression</h6>
                            <p class="progress-card-value">{{ user_progress.completion_percentage|default:0 }}%</p>
                        </div>
                        <i class="bi bi-graph-up-arrow progress-card-icon"></i>
                    </div>
                </div>

                <div class="progress-card progress-card-warning">
                    <div class="flex justify-between items-start">
                        <div>
                            <h6 class="progress-card-label">Streak</h6>
                            <p class="progress-card-value">{{ user_streak|default:0 }} jours</p>
                        </div>
                        <i class="bi bi-fire progress-card-icon"></i>
                    </div>
                </div>
            </div>

            <!-- Modules de l'unité sélectionnée -->
            <div id="modules-content" class="animate-slide-in">
                {% if active_unit %}
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">{{ active_unit.title }}</h2>
                    <p class="text-gray-600">{{ active_unit.description }}</p>
                </div>

                <div class="module-grid">
                    {% for module in active_unit_modules %}
                    <div
                        class="module-card {% if module.is_completed %}completed{% endif %} {% if module.is_locked %}locked{% endif %}"
                        {% if not module.is_locked %}
                        hx-get="{% url 'language_learning:start_module' module.id %}"
                        hx-target="#module-modal"
                        hx-trigger="click"
                        {% endif %}
                    >
                        {% if module.is_completed %}
                        <div class="module-card-status completed">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                        {% elif module.is_locked %}
                        <div class="module-card-status locked">
                            <i class="bi bi-lock-fill"></i>
                        </div>
                        {% endif %}

                        <span class="module-type-badge type-{{ module.module_type }}">
                            {% if module.module_type == 'vocabulary' %}
                                <i class="bi bi-book" style="margin-right: 0.375rem;"></i>
                            {% elif module.module_type == 'grammar' %}
                                <i class="bi bi-pencil" style="margin-right: 0.375rem;"></i>
                            {% elif module.module_type == 'listening' %}
                                <i class="bi bi-headphones" style="margin-right: 0.375rem;"></i>
                            {% elif module.module_type == 'speaking' %}
                                <i class="bi bi-mic" style="margin-right: 0.375rem;"></i>
                            {% elif module.module_type == 'reading' %}
                                <i class="bi bi-book-half" style="margin-right: 0.375rem;"></i>
                            {% elif module.module_type == 'writing' %}
                                <i class="bi bi-pen" style="margin-right: 0.375rem;"></i>
                            {% elif module.module_type == 'culture' %}
                                <i class="bi bi-globe2" style="margin-right: 0.375rem;"></i>
                            {% else %}
                                <i class="bi bi-arrow-repeat" style="margin-right: 0.375rem;"></i>
                            {% endif %}
                            {{ module.get_module_type_display }}
                        </span>

                        <h5 class="module-title">{{ module.title }}</h5>
                        <p class="module-description">{{ module.description }}</p>

                        <div class="module-meta">
                            <span class="module-meta-item">
                                <i class="bi bi-clock"></i>
                                {{ module.estimated_duration }} min
                            </span>
                            <span class="module-meta-item">
                                <i class="bi bi-star"></i>
                                {{ module.xp_reward }} XP
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-arrow-left-circle empty-state-icon"></i>
                    <h4 class="empty-state-title">Sélectionnez une unité</h4>
                    <p class="empty-state-description">
                        Choisissez une unité dans la sidebar pour voir ses modules et commencer l'apprentissage.
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </main>
    {% else %}
    <!-- Message si aucune langue n'est sélectionnée -->
    <div class="content-area">
        <div class="empty-state">
            <i class="bi bi-translate" style="font-size: 5rem; color: var(--linguify-primary);"></i>
            <h3 class="empty-state-title">Bienvenue dans Linguify Learn!</h3>
            <p class="empty-state-description">
                Sélectionnez une langue dans le menu pour commencer votre apprentissage.
            </p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal pour les modules (sera rempli par HTMX) -->
<div id="module-modal"></div>

<!-- Overlay pour mobile -->
<div
    x-show="sidebarOpen"
    @click="sidebarOpen = false"
    class="fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden"
    x-transition:enter="transition-opacity ease-linear duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition-opacity ease-linear duration-300"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    style="display: none;"
></div>

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
{% endblock %}
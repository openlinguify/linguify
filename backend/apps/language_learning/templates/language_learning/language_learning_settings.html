<!-- Language Learning Settings Tab -->
<div id="language_learning" class="tab-content active">
    <!-- Préférences d'apprentissage -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-mortarboard-fill"></i>
                Préférences d'apprentissage
            </h3>
            <button class="section-toggle">
                <i class="bi bi-chevron-up"></i>
            </button>
        </div>
        <div class="section-content">
            <form id="language_learning_goals_form" method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="language_learning">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="daily_goal_minutes">Objectif quotidien</label>
                        <div class="input-group">
                            <input type="number" id="daily_goal_minutes" name="daily_goal_minutes" 
                                   min="5" max="300" step="5" value="15" class="form-control">
                            <span class="input-text">minutes par jour</span>
                        </div>
                        <small class="help-text">Temps que vous souhaitez consacrer chaque jour à l'apprentissage</small>
                    </div>

                    <div class="form-group">
                        <label for="weekly_goal_days">Objectif hebdomadaire</label>
                        <div class="input-group">
                            <input type="number" id="weekly_goal_days" name="weekly_goal_days" 
                                   min="1" max="7" value="5" class="form-control">
                            <span class="input-text">jours par semaine</span>
                        </div>
                        <small class="help-text">Nombre de jours où vous souhaitez étudier chaque semaine</small>
                    </div>

                    <div class="form-group">
                        <label for="preferred_study_time">Heure préférée d'étude</label>
                        <input type="time" id="preferred_study_time" name="preferred_study_time" 
                               value="18:00" class="form-control">
                        <small class="help-text">Heure à laquelle vous préférez étudier</small>
                    </div>

                    <div class="form-group">
                        <label for="reminder_frequency">Fréquence des rappels</label>
                        <select id="reminder_frequency" name="reminder_frequency" class="form-control">
                            <option value="daily">Quotidien</option>
                            <option value="weekdays" selected>Jours de semaine</option>
                            <option value="custom">Personnalisé</option>
                        </select>
                        <small class="help-text">À quelle fréquence recevoir des rappels</small>
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-row">
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="reminder_enabled" checked>
                                <span class="checkbox-custom"></span>
                                Activer les rappels
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="streak_notifications" checked>
                                <span class="checkbox-custom"></span>
                                Notifications de série
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="achievement_notifications" checked>
                                <span class="checkbox-custom"></span>
                                Notifications de réussite
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Enregistrer les objectifs</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Préférences d'apprentissage -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-gear"></i>
                Préférences d'apprentissage
            </h3>
            <button class="section-toggle">
                <i class="bi bi-chevron-up"></i>
            </button>
        </div>
        <div class="section-content">
            <form id="language_learning_preferences_form" method="post">
                {% csrf_token %}
                <input type="hidden" name="setting_type" value="language_learning_preferences">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="preferred_difficulty">Niveau de difficulté préféré</label>
                        <select id="preferred_difficulty" name="preferred_difficulty" class="form-control">
                            <option value="easy">Facile</option>
                            <option value="normal">Normal</option>
                            <option value="hard">Difficile</option>
                            <option value="adaptive" selected>Adaptatif</option>
                        </select>
                        <small class="help-text">Le système ajustera automatiquement en mode adaptatif</small>
                    </div>

                    <div class="form-group">
                        <label for="audio_playback_speed">Vitesse de lecture audio</label>
                        <div class="input-group">
                            <input type="range" id="audio_playback_speed" name="audio_playback_speed" 
                                   min="0.5" max="2.0" step="0.1" value="1.0" class="form-range">
                            <span class="range-value" id="speed_value">1.0x</span>
                        </div>
                        <small class="help-text">Vitesse de lecture des contenus audio</small>
                    </div>

                    <div class="form-group">
                        <label>Méthodes d'apprentissage préférées</label>
                        <div class="checkbox-grid">
                            <label class="checkbox-label">
                                <input type="checkbox" name="learning_methods" value="flashcards" checked>
                                <span class="checkbox-custom"></span>
                                Cartes mémoire
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="learning_methods" value="listening" checked>
                                <span class="checkbox-custom"></span>
                                Écoute
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="learning_methods" value="speaking">
                                <span class="checkbox-custom"></span>
                                Expression orale
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="learning_methods" value="reading">
                                <span class="checkbox-custom"></span>
                                Lecture
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="learning_methods" value="writing">
                                <span class="checkbox-custom"></span>
                                Écriture
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="learning_methods" value="grammar">
                                <span class="checkbox-custom"></span>
                                Grammaire
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="learning_methods" value="vocabulary" checked>
                                <span class="checkbox-custom"></span>
                                Vocabulaire
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-row">
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="auto_difficulty_adjustment" checked>
                                <span class="checkbox-custom"></span>
                                Ajustement automatique de la difficulté
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="enable_audio_playback" checked>
                                <span class="checkbox-custom"></span>
                                Activer la lecture audio
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="show_pronunciation_hints" checked>
                                <span class="checkbox-custom"></span>
                                Afficher les indices de prononciation
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="show_progress_animations" checked>
                                <span class="checkbox-custom"></span>
                                Animations de progression
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Enregistrer les préférences</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Presets rapides -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="bi bi-lightning"></i>
                Configurations rapides
            </h3>
            <button class="section-toggle">
                <i class="bi bi-chevron-up"></i>
            </button>
        </div>
        <div class="section-content">
            <div class="preset-grid">
                <div class="preset-card" onclick="applyLanguageLearningPreset('casual')">
                    <i class="bi bi-clock preset-icon"></i>
                    <h4>Apprentissage décontracté</h4>
                    <p>10 min/jour, 3 jours/semaine<br>Niveau facile, sans pression</p>
                </div>
                <div class="preset-card" onclick="applyLanguageLearningPreset('regular')">
                    <i class="bi bi-calendar-check preset-icon"></i>
                    <h4>Apprentissage régulier</h4>
                    <p>15 min/jour, 5 jours/semaine<br>Progression constante et équilibrée</p>
                </div>
                <div class="preset-card" onclick="applyLanguageLearningPreset('intensive')">
                    <i class="bi bi-lightning-fill preset-icon"></i>
                    <h4>Apprentissage intensif</h4>
                    <p>30 min/jour, 6 jours/semaine<br>Pour progresser rapidement</p>
                </div>
                <div class="preset-card" onclick="applyLanguageLearningPreset('immersion')">
                    <i class="bi bi-rocket-takeoff preset-icon"></i>
                    <h4>Immersion totale</h4>
                    <p>60 min/jour, 7 jours/semaine<br>Apprentissage maximum</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Language Learning Settings JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Load initial settings
    loadLanguageLearningSettings();
    
    // Setup audio speed slider
    const speedSlider = document.getElementById('audio_playback_speed');
    const speedValue = document.getElementById('speed_value');
    
    if (speedSlider && speedValue) {
        speedSlider.addEventListener('input', function() {
            speedValue.textContent = this.value + 'x';
        });
    }
});

function loadLanguageLearningSettings() {
    fetch('/language_learning/api/user-settings/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.settings) {
                populateLanguageLearningForm(data.settings);
            }
        })
        .catch(error => {
            console.error('Error loading language learning settings:', error);
        });
}

function populateLanguageLearningForm(settings) {
    // Populate form fields with settings
    Object.keys(settings).forEach(key => {
        const element = document.querySelector(`[name="${key}"]`);
        if (element) {
            if (element.type === 'checkbox') {
                element.checked = settings[key];
            } else if (element.type === 'range') {
                element.value = settings[key];
                if (key === 'audio_playback_speed') {
                    document.getElementById('speed_value').textContent = settings[key] + 'x';
                }
            } else {
                element.value = settings[key];
            }
        }
    });
    
    // Handle multi-select checkboxes (learning methods)
    if (settings.learning_methods && Array.isArray(settings.learning_methods)) {
        document.querySelectorAll('[name="learning_methods"]').forEach(checkbox => {
            checkbox.checked = settings.learning_methods.includes(checkbox.value);
        });
    }
}

function loadLanguageLearningStats() {
    fetch('/language_learning/api/items/stats/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.stats) {
                updateLanguageLearningStats(data.stats);
            }
        })
        .catch(error => {
            console.error('Error loading language learning stats:', error);
        });
}

function updateLanguageLearningStats(stats) {
    document.getElementById('total-languages').textContent = stats.total_languages || 0;
    document.getElementById('longest-streak').textContent = stats.longest_streak || 0;
    document.getElementById('lessons-completed').textContent = stats.total_lessons_completed || 0;
    
    // Format study time
    const totalMinutes = stats.total_study_time || 0;
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    const timeDisplay = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
    document.getElementById('total-study-time').textContent = timeDisplay;
}

function applyLanguageLearningPreset(presetName) {
    if (confirm(`Appliquer la configuration "${presetName}" ? Cela remplacera vos paramètres actuels.`)) {
        fetch('/language_learning/api/settings/apply_preset/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                preset_name: presetName,
                override_user_settings: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`Configuration "${presetName}" appliquée avec succès!`, 'success');
                loadLanguageLearningSettings(); // Reload settings
            } else {
                showToast('Erreur lors de l\'application de la configuration', 'error');
            }
        })
        .catch(error => {
            console.error('Error applying preset:', error);
            showToast('Erreur lors de l\'application de la configuration', 'error');
        });
    }
}

// Form submission handlers
document.getElementById('language_learning_goals_form').addEventListener('submit', function(e) {
    e.preventDefault();
    submitLanguageLearningForm(this, 'Objectifs mis à jour avec succès!');
});

document.getElementById('language_learning_preferences_form').addEventListener('submit', function(e) {
    e.preventDefault();
    submitLanguageLearningForm(this, 'Préférences mises à jour avec succès!');
});

function submitLanguageLearningForm(form, successMessage) {
    const formData = new FormData(form);
    
    fetch('/language_learning/settings/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(successMessage, 'success');
        } else {
            showToast(data.message || 'Erreur lors de la sauvegarde', 'error');
        }
    })
    .catch(error => {
        console.error('Error submitting form:', error);
        showToast('Erreur lors de la sauvegarde', 'error');
    });
}
</script>
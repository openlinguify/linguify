{% extends "calendar/base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Calendar" %} - {% trans "List View" %}{% endblock %}

{% block page_title %}{% trans "Calendar" %}{% endblock %}

{% block extra_calendar_css %}
<style>
.calendar-list-view {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.list-event-item {
    border-bottom: 1px solid #e5e7eb;
    padding: 12px 16px;
    transition: background-color 0.15s ease;
    cursor: pointer;
}

.list-event-item:hover {
    background-color: #f8f9fa;
}

.list-event-item:last-child {
    border-bottom: none;
}

.event-time {
    font-weight: 600;
    color: #374151;
    font-size: 0.875rem;
    min-width: 120px;
}

.event-title {
    font-weight: 500;
    color: #111827;
    font-size: 0.9rem;
}

.event-description {
    color: #6b7280;
    font-size: 0.8rem;
    margin-top: 2px;
}

.event-location {
    color: #9ca3af;
    font-size: 0.8rem;
    margin-top: 2px;
}

.event-color-bar {
    width: 4px;
    height: 100%;
    border-radius: 2px;
    margin-right: 12px;
}

.date-separator {
    background: #f3f4f6;
    padding: 8px 16px;
    font-weight: 600;
    color: #374151;
    font-size: 0.9rem;
    border-bottom: 1px solid #e5e7eb;
}

.no-events {
    text-align: center;
    padding: 40px 20px;
    color: #6b7280;
}

.event-attendees {
    color: #6b7280;
    font-size: 0.75rem;
    margin-top: 2px;
}

.all-day-badge {
    background: #dbeafe;
    color: #1e40af;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 12px;
    font-weight: 500;
}
</style>
{% endblock %}

{% block calendar_content %}
<div class="container-fluid">
    <!-- Calendar Context Navigation -->
    <div class="calendar-context-navbar">
        <div class="context-navbar-content">
            <!-- Left: View Switcher -->
            <div class="context-nav-left">
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary {% if view_type == 'month' %}active{% endif %}" data-view="month">
                        <i class="bi bi-calendar3 me-1"></i>
                        <span class="d-none d-sm-inline">{% trans "Month" %}</span>
                    </button>
                    <button type="button" class="btn btn-outline-primary {% if view_type == 'week' %}active{% endif %}" data-view="week">
                        <i class="bi bi-calendar-week me-1"></i>
                        <span class="d-none d-sm-inline">{% trans "Week" %}</span>
                    </button>
                    <button type="button" class="btn btn-outline-primary {% if view_type == 'day' %}active{% endif %}" data-view="day">
                        <i class="bi bi-calendar-day me-1"></i>
                        <span class="d-none d-sm-inline">{% trans "Day" %}</span>
                    </button>
                    <button type="button" class="btn btn-outline-primary {% if view_type == 'list' %}active{% endif %}" data-view="list">
                        <i class="bi bi-list-ul me-1"></i>
                        <span class="d-none d-sm-inline">{% trans "List" %}</span>
                    </button>
                </div>
            </div>
            
            <!-- Center: Current Period -->
            <div class="context-nav-center">
                <div class="current-period">
                    <button id="prevPeriod" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <span class="period-title" id="currentPeriod">
                        {% trans "Next 30 days" %} - {{ current_date|date:"F Y" }}
                    </span>
                    <button id="nextPeriod" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Right: Actions -->
            <div class="context-nav-right">
                <button id="todayBtn" class="btn btn-primary btn-sm">
                    <i class="bi bi-dot me-1"></i>
                    <span class="d-none d-lg-inline">{% trans "Today" %}</span>
                </button>
            </div>
        </div>
    </div>

    <div class="calendar-main-content fade-in">
        <div class="calendar-list-view">
            {% if events %}
                {% regroup events by start.date as events_by_date %}
                {% for date_group in events_by_date %}
                    <div class="date-separator">
                        <i class="bi bi-calendar3 me-2"></i>
                        {{ date_group.grouper|date:"l, F j, Y" }}
                        <span class="badge bg-secondary ms-2">{{ date_group.list|length }}</span>
                    </div>
                    
                    {% for event in date_group.list %}
                        <div class="list-event-item d-flex" onclick="window.location.href='/calendar/event/{{ event.id }}/'">
                            <!-- Color bar -->
                            <div class="event-color-bar" style="background-color: {% if event.event_type %}{{ event.event_type.color }}{% else %}#007bff{% endif %};"></div>
                            
                            <!-- Time column -->
                            <div class="event-time d-flex flex-column align-items-start">
                                {% if event.allday %}
                                    <span class="all-day-badge">{% trans "All day" %}</span>
                                {% else %}
                                    <span>{{ event.start|date:"H:i" }}</span>
                                    <small class="text-muted">{{ event.stop|date:"H:i" }}</small>
                                {% endif %}
                            </div>
                            
                            <!-- Event details -->
                            <div class="flex-grow-1 ms-3">
                                <div class="event-title">
                                    {{ event.name }}
                                    {% if event.event_type %}
                                        <span class="badge bg-light text-dark ms-2">{{ event.event_type.name }}</span>
                                    {% endif %}
                                </div>
                                
                                {% if event.description %}
                                    <div class="event-description">
                                        {{ event.description|truncatechars:100 }}
                                    </div>
                                {% endif %}
                                
                                {% if event.location %}
                                    <div class="event-location">
                                        <i class="bi bi-geo-alt me-1"></i>
                                        {{ event.location }}
                                    </div>
                                {% endif %}
                                
                                {% if event.get_attendees_count > 1 %}
                                    <div class="event-attendees">
                                        <i class="bi bi-people me-1"></i>
                                        {{ event.get_attendees_count }} {% trans "participants" %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Actions -->
                            <div class="d-flex align-items-center">
                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="event.stopPropagation(); editEvent('{{ event.id }}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <i class="bi bi-chevron-right text-muted"></i>
                            </div>
                        </div>
                    {% endfor %}
                {% endfor %}
            {% else %}
                <div class="no-events">
                    <i class="bi bi-calendar-x" style="font-size: 3rem; color: #d1d5db; margin-bottom: 1rem;"></i>
                    <h5>{% trans "No events found" %}</h5>
                    <p>{% trans "There are no events in the next 30 days." %}</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createEventModal">
                        <i class="bi bi-plus me-1"></i>
                        {% trans "Create Event" %}
                    </button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick Add Button -->
    <button class="quick-add-btn" data-bs-toggle="modal" data-bs-target="#createEventModal" title="{% trans 'Quick Add Event' %}">
        <i class="bi bi-plus"></i>
    </button>
</div>

<!-- Create Event Modal (same as month view) -->
<div class="modal fade" id="createEventModal" tabindex="-1" aria-labelledby="createEventModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createEventModalLabel">
                    <i class="bi bi-plus-circle me-2"></i>
                    {% trans "Create New Event" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
            </div>
            <form id="quickEventForm">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="eventTitle" class="form-label">{% trans "Event Title" %}</label>
                            <input type="text" class="form-control form-control-calendar" id="eventTitle" name="name" required placeholder="{% trans 'Enter event title...' %}">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="eventStart" class="form-label">{% trans "Start Date & Time" %}</label>
                            <input type="datetime-local" class="form-control form-control-calendar" id="eventStart" name="start" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="eventEnd" class="form-label">{% trans "End Date & Time" %}</label>
                            <input type="datetime-local" class="form-control form-control-calendar" id="eventEnd" name="stop" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="eventDescription" class="form-label">{% trans "Description" %}</label>
                            <textarea class="form-control form-control-calendar" id="eventDescription" name="description" rows="3" placeholder="{% trans 'Event description (optional)...' %}"></textarea>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="eventLocation" class="form-label">{% trans "Location" %}</label>
                            <input type="text" class="form-control form-control-calendar" id="eventLocation" name="location" placeholder="{% trans 'Event location (optional)...' %}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="eventType" class="form-label">{% trans "Event Type" %}</label>
                            <select class="form-select form-control-calendar" id="eventType" name="event_type">
                                <option value="">{% trans "Select type..." %}</option>
                                <option value="meeting">{% trans "Meeting" %}</option>
                                <option value="personal">{% trans "Personal" %}</option>
                                <option value="work">{% trans "Work" %}</option>
                                <option value="reminder">{% trans "Reminder" %}</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="allDay" name="allday">
                                <label class="form-check-label" for="allDay">
                                    {% trans "All day event" %}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% trans "Cancel" %}
                    </button>
                    <button type="submit" class="btn btn-calendar-primary">
                        <i class="bi bi-check-lg me-1"></i>
                        {% trans "Create Event" %}
                    </button>
                    <a href="{% url 'calendar:event_create' %}" class="btn btn-calendar-outline">
                        <i class="bi bi-gear me-1"></i>
                        {% trans "Advanced Options" %}
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Calendar] List view loaded');
    
    // Setup navigation
    setTimeout(() => {
        console.log('[Calendar] Setting up list view navigation...');
        
        // Previous period button
        const prevBtn = document.getElementById('prevPeriod');
        if (prevBtn) {
            prevBtn.addEventListener('click', function() {
                console.log('[Calendar] Previous period clicked');
                const currentDate = new Date();
                currentDate.setDate(currentDate.getDate() - 30);
                const dateStr = currentDate.getFullYear() + '-' + 
                               String(currentDate.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(currentDate.getDate()).padStart(2, '0');
                window.location.href = `/calendar/?view=list&date=${dateStr}`;
            });
        }
        
        // Next period button
        const nextBtn = document.getElementById('nextPeriod');
        if (nextBtn) {
            nextBtn.addEventListener('click', function() {
                console.log('[Calendar] Next period clicked');
                const currentDate = new Date();
                currentDate.setDate(currentDate.getDate() + 30);
                const dateStr = currentDate.getFullYear() + '-' + 
                               String(currentDate.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(currentDate.getDate()).padStart(2, '0');
                window.location.href = `/calendar/?view=list&date=${dateStr}`;
            });
        }
        
        // Today button
        const todayBtn = document.getElementById('todayBtn');
        if (todayBtn) {
            todayBtn.addEventListener('click', function() {
                console.log('[Calendar] Today button clicked');
                window.location.href = '/calendar/?view=list';
            });
        }
        
        // View switcher buttons
        const viewBtns = document.querySelectorAll('[data-view]');
        viewBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const view = this.dataset.view;
                console.log('[Calendar] View button clicked:', view);
                
                const currentDate = new Date();
                const dateStr = currentDate.getFullYear() + '-' + 
                               String(currentDate.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(currentDate.getDate()).padStart(2, '0');
                
                if (view === 'month') {
                    window.location.href = `/calendar/?view=month&date=${dateStr}`;
                } else if (view === 'week') {
                    window.location.href = `/calendar/?view=week&date=${dateStr}`;
                } else if (view === 'day') {
                    window.location.href = `/calendar/?view=day&date=${dateStr}`;
                } else if (view === 'list') {
                    window.location.href = `/calendar/?view=list&date=${dateStr}`;
                }
            });
        });
        
        console.log('[Calendar] List view navigation setup complete');
    }, 500);
});

// Helper functions
function editEvent(eventId) {
    window.location.href = `/calendar/event/${eventId}/edit/`;
}

// Quick event form submission (same as month view)
document.addEventListener('DOMContentLoaded', function() {
    const quickForm = document.getElementById('quickEventForm');
    if (quickForm) {
        quickForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>{% trans "Creating..." %}';
            submitBtn.disabled = true;
            
            const formData = new FormData(this);
            
            fetch('{% url "calendar:quick_create" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('createEventModal')).hide();
                    this.reset();
                    // Reload page to show new event
                    window.location.reload();
                } else {
                    console.error('Error creating event:', data.errors);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });
    }
});
</script>
{% endblock %}
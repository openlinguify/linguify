{% extends 'saas_web/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ page_title|default:"Calendar" }} - Linguify{% endblock %}

{% block extra_css %}
    <!-- CSS spÃ©cifique au calendrier -->
    <link rel="stylesheet" href="{% static 'calendar/css/calendar.css' %}">
    
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
    
    {% block extra_calendar_css %}{% endblock %}
{% endblock %}

{% block content %}
    <!-- Include calendar-specific header navigation -->
    {% include 'components/calendar_header.html' %}
    
    <!-- Main Content Container -->
    <div class="calendar-container">
        {% block calendar_content %}
        <!-- Content will be provided by child templates -->
        {% endblock %}
    </div>
{% endblock %}

{% block extra_js %}
    <!-- Simple Calendar Fallback -->
    <script src="{% static 'calendar/js/simple-calendar.js' %}"></script>
    
    <!-- Try to load FullCalendar from CDN -->
    <script>
        function loadFullCalendar() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js';
                script.onload = () => {
                    console.log('FullCalendar loaded successfully');
                    resolve(true);
                };
                script.onerror = () => {
                    console.warn('FullCalendar failed to load from CDN, using fallback');
                    resolve(false);
                };
                document.head.appendChild(script);
            });
        }
        
        window.calendarLoaded = loadFullCalendar();
    </script>
    
    <!-- Calendar Base Services -->
    <script src="{% static 'calendar/js/base.js' %}"></script>
    
    <!-- Calendar Navigation -->
    <script src="{% static 'calendar/js/navbar.js' %}"></script>
    
    <!-- Dynamic Configuration from Django -->
    <script>
        // Set dynamic configuration from Django template
        window.DEBUG = {{ debug|yesno:"true,false" }};
        window.API_BASE_URL = '{{ api_base_url }}';
        
        // User data
        {% if user.is_authenticated %}
        window.USER_DATA = {{ user_data|safe }};
        window.currentUserId = {{ user.id }};
        window.currentUsername = '{{ user.username }}';
        {% else %}
        window.USER_DATA = null;
        window.currentUserId = undefined;
        window.currentUsername = undefined;
        console.log('[Calendar] User not authenticated');
        {% endif %}
        
        // Calendar specific configuration
        window.CALENDAR_CONFIG = {
            ...window.CALENDAR_CONFIG,
            apiBaseUrl: '{{ api_base_url }}',
            {% if event_id %}eventId: {{ event_id }},{% endif %}
            {% if view_type %}viewType: '{{ view_type }}',{% endif %}
            locale: '{{ LANGUAGE_CODE|default:"en" }}',
            timezone: '{{ timezone|default:"UTC" }}'
        };
    </script>
    
    {% block calendar_extra_js %}{% endblock %}
{% endblock %}
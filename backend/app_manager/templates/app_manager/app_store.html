{% extends 'saas_web/base.html' %}
{% load static i18n %}

{% block title %}App Store - Open Linguify{% endblock %}

{% block extra_css %}
<!-- Preload critical icons pour ultra performance -->
<link rel="preload" href="/app-icons/community/icon.png" as="image">
<link rel="preload" href="/app-icons/chat/icon.png" as="image">
<link rel="preload" href="/app-icons/course/icon.png" as="image">
<link rel="preload" href="/app-icons/documents/icon.png" as="image">
<link rel="preload" href="/app-icons/language_ai/icon.png" as="image">
<link rel="preload" href="/app-icons/notebook/icon.png" as="image">
<link rel="preload" href="/app-icons/quizz/icon.png" as="image">
<link rel="preload" href="/app-icons/revision/icon.png" as="image">
<link rel="preload" href="/app-icons/todo/icon.png" as="image">
<link rel="preload" href="/app-icons/teaching/icon.png" as="image">

<link rel="stylesheet" href="{% static 'app_manager/css/app_store.css' %}">
{% endblock %}

{% block content %}
{% csrf_token %}


<!-- App Store Container -->
<div class="app-store-container">
    <!-- Sidebar -->
    <aside class="app-store-sidebar">
        <div class="category-list">
            <h6 class="text-muted text-uppercase mb-3" style="font-size: 0.75rem; letter-spacing: 0.05em; font-weight: 600;">{% trans "Categories" %}</h6>

            <button class="category-item active" data-category="all">
                <div class="d-flex align-items-center">
                    <i class="bi bi-grid-3x3-gap category-icon"></i>
                    <span>{% trans "All apps" %}</span>
                </div>
                <span class="category-count" id="count-all">{{ total_apps }}</span>
            </button>
            
            <!-- Dynamic categories from manifests -->
            {% for category_id, definition in category_definitions.items %}
            <button class="category-item" data-category="{{ category_id }}">
                <div class="d-flex align-items-center">
                    <i class="{{ definition.icon }} category-icon"></i>
                    <span>{{ definition.label }}</span>
                </div>
                <span class="category-count" id="count-{{ category_id }}">
                    {% for cat_id, count in category_counts.items %}
                        {% if cat_id == category_id %}{{ count }}{% endif %}
                    {% empty %}0{% endfor %}
                </span>
            </button>
            {% endfor %}
        </div>
    </aside>

    <!-- Main Content -->
    <main class="app-store-main">
        <!-- Search Bar -->
        <div class="search-bar">
            <i class="bi bi-search"></i>
            <input type="text" placeholder="{% trans 'Search for an application...' %}" id="searchInput">
        </div>

        <!-- Apps Grid -->
        <div class="apps-grid" id="appsGrid">
            {% for app in apps %}
            <div class="app-card" data-category="{{ app.category|default:'other' }}" data-app-id="{{ app.id }}">
                <!-- App Header -->
                <div class="app-header">
                    <div class="app-icon" style="background: transparent; border: 1px solid #e2e8f0; border-radius: 12px;">
                        {% if app.static_icon %}
                            <img src="{{ app.static_icon }}" alt="{{ app.display_name }} icon" style="width: 40px; height: 40px; object-fit: contain;">
                        {% endif %}
                    </div>
                    <div class="app-info">
                        <h3 class="app-title">{{ app.display_name }}</h3>
                        <span class="app-category">{{ app.category_display|default:'Application' }}</span>
                    </div>
                    <div class="install-toggle">
                        <input type="checkbox" id="toggle-{{ app.id }}" 
                               {% if app.id in enabled_app_ids %}checked{% endif %}
                               data-app-id="{{ app.id }}">
                        <label for="toggle-{{ app.id }}" class="install-toggle-slider"></label>
                    </div>
                </div>

                <!-- App Description -->
                <p class="app-description">{{ app.description|default:_('Application description.') }}</p>

                <!-- App Footer -->
                <div class="app-footer">
                    <div class="install-status {% if app.id in enabled_app_ids %}installed{% endif %}">
                        {% if app.id in enabled_app_ids %}
                            <i class="bi bi-check-circle me-1"></i>{% trans "Installed" %}
                        {% else %}
                            <i class="bi bi-download me-1"></i>{% trans "Not installed" %}
                        {% endif %}
                    </div>
                    {% if app.id in enabled_app_ids %}
                    <a href="{{ app.route_path }}" class="btn btn-primary btn-sm">
                        <i class="bi bi-box-arrow-up-right me-1"></i>{% trans "Open" %}
                    </a>
                    {% endif %}
                </div>

                <!-- Loading Overlay -->
                <div class="loading-overlay" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{% trans "Loading..." %}</span>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <i class="bi bi-app-indicator"></i>
                <h5 class="mb-2">{% trans "No applications available" %}</h5>
                <p>{% trans "Applications will be available soon." %}</p>
            </div>
            {% endfor %}
        </div>

        <!-- Empty State (for searches) -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="bi bi-search"></i>
            <h5 class="mb-2">{% trans "No applications found" %}</h5>
            <p>{% trans "Try with other keywords" %}</p>
        </div>
    </main>
</div>

<!-- Toast Container -->
<div class="toast-container"></div>

<!-- Confirmation Modal for Uninstall -->
<div class="modal fade" id="uninstallModal" tabindex="-1" aria-labelledby="uninstallModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title" id="uninstallModalLabel">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                    {% trans "Uninstall application" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div class="app-icon-large mb-3" id="modalAppIcon">
                        <i class="bi bi-app"></i>
                    </div>
                    <h6 class="fw-bold mb-3" id="modalAppName">{% trans "Application name" %}</h6>
                </div>

                <div class="alert alert-info border-0" style="background: #f0f9ff; color: #0369a1;">
                    <div class="d-flex">
                        <i class="bi bi-info-circle me-3 mt-1 flex-shrink-0"></i>
                        <div>
                            <p class="mb-2"><strong>{% trans "What happens during uninstallation?" %}</strong></p>
                            <ul class="mb-0 ps-0" style="list-style: none;">
                                <li class="mb-1"><i class="bi bi-check2 text-primary me-2"></i>{% trans "The application will disappear from your dashboard" %}</li>
                                <li class="mb-1"><i class="bi bi-shield-check text-primary me-2"></i>{% trans "Your data will be kept for" %} <strong>{% trans "30 days" %}</strong></li>
                                <li class="mb-1"><i class="bi bi-arrow-clockwise text-primary me-2"></i>{% trans "You can reinstall at any time" %}</li>
                                <li><i class="bi bi-clock text-muted me-2"></i>{% trans "Automatic deletion after 30 days of inactivity" %}</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>{% trans "Cancel" %}
                </button>
                <button type="button" class="btn btn-danger" id="confirmUninstall">
                    <i class="bi bi-trash me-2"></i>{% trans "Uninstall" %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Pass Django URL to JavaScript -->
<div data-toggle-url="{% url 'app_manager:api_app_toggle' 0 %}" style="display: none;"></div>
<script src="{% static 'app_manager/js/app_store.js' %}?v=2"></script>
{% endblock %}
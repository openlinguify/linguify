{% extends 'saas_web/base.html' %}
{% load static %}

{% block title %}App Store - Open Linguify{% endblock %}

{% block extra_css %}
<!-- Preload critical icons pour ultra performance -->
<link rel="preload" href="/app-icons/community/icon.png" as="image">
<link rel="preload" href="/app-icons/chat/icon.png" as="image">
<link rel="preload" href="/app-icons/course/icon.png" as="image">
<link rel="preload" href="/app-icons/documents/icon.png" as="image">
<link rel="preload" href="/app-icons/language_ai/icon.png" as="image">
<link rel="preload" href="/app-icons/notebook/icon.png" as="image">
<link rel="preload" href="/app-icons/quizz/icon.png" as="image">
<link rel="preload" href="/app-icons/revision/icon.png" as="image">

<link rel="stylesheet" href="{% static 'app_manager/css/app_store.css' %}">
<style>
/* Critical CSS inline pour ultra performance */
.app-store-container{display:flex;max-width:1400px;margin:0 auto;gap:2rem;padding:2rem}
.app-store-sidebar{width:250px;flex-shrink:0}
.app-store-main{flex:1}
.apps-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1.5rem}
.app-card{background:#fff;border-radius:16px;border:1px solid #e2e8f0;padding:1.5rem;transition:all .3s ease;cursor:pointer;position:relative}
.app-card:hover{transform:translateY(-2px);box-shadow:0 12px 24px rgba(0,0,0,.08);border-color:#6366f1}
.app-header{display:flex;align-items:flex-start;gap:1rem;margin-bottom:1rem}
.app-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.25rem;color:#fff;flex-shrink:0}
.app-icon img{will-change:transform;backface-visibility:hidden}
</style>
{% endblock %}

{% block content %}
{% csrf_token %}


<!-- App Store Container -->
<div class="app-store-container">
    <!-- Sidebar -->
    <aside class="app-store-sidebar">
        <div class="category-list">
            <h6 class="text-muted text-uppercase mb-3" style="font-size: 0.75rem; letter-spacing: 0.05em; font-weight: 600;">Catégories</h6>
            
            <button class="category-item active" data-category="all">
                <div class="d-flex align-items-center">
                    <i class="bi bi-grid-3x3-gap category-icon"></i>
                    <span>Toutes les apps</span>
                </div>
                <span class="category-count" id="count-all">{{ total_apps }}</span>
            </button>
            
            <!-- Catégories dynamiques depuis les manifests -->
            {% for category_id, definition in category_definitions.items %}
            <button class="category-item" data-category="{{ category_id }}">
                <div class="d-flex align-items-center">
                    <i class="{{ definition.icon }} category-icon"></i>
                    <span>{{ definition.label }}</span>
                </div>
                <span class="category-count" id="count-{{ category_id }}">
                    {% for cat_id, count in category_counts.items %}
                        {% if cat_id == category_id %}{{ count }}{% endif %}
                    {% empty %}0{% endfor %}
                </span>
            </button>
            {% endfor %}
        </div>
    </aside>

    <!-- Main Content -->
    <main class="app-store-main">
        <!-- Search Bar -->
        <div class="search-bar">
            <i class="bi bi-search"></i>
            <input type="text" placeholder="Rechercher une application..." id="searchInput">
        </div>

        <!-- Apps Grid -->
        <div class="apps-grid" id="appsGrid">
            {% for app in apps %}
            <div class="app-card" data-category="{{ app.category|default:'other' }}" data-app-id="{{ app.id }}">
                <!-- App Header -->
                <div class="app-header">
                    <div class="app-icon" style="background: transparent; border: 1px solid #e2e8f0; border-radius: 12px;">
                        {% if app.name in 'community,chat,course,documents,language_ai,notebook,quizz,revision' %}
                            <img src="/app-icons/{{ app.name }}/icon.png" alt="{{ app.display_name }} icon" style="width: 40px; height: 40px; object-fit: contain;">
                        {% endif %}
                    </div>
                    <div class="app-info">
                        <h3 class="app-title">{{ app.display_name }}</h3>
                        <span class="app-category">{{ app.category_display|default:'Application' }}</span>
                    </div>
                    <div class="install-toggle">
                        <input type="checkbox" id="toggle-{{ app.id }}" 
                               {% if app.id in enabled_app_ids %}checked{% endif %}
                               data-app-id="{{ app.id }}">
                        <label for="toggle-{{ app.id }}" class="install-toggle-slider"></label>
                    </div>
                </div>

                <!-- App Description -->
                <p class="app-description">{{ app.description|default:'Description de l\'application.' }}</p>

                <!-- App Footer -->
                <div class="app-footer">
                    <div class="install-status {% if app.id in enabled_app_ids %}installed{% endif %}">
                        {% if app.id in enabled_app_ids %}
                            <i class="bi bi-check-circle me-1"></i>Installée
                        {% else %}
                            <i class="bi bi-download me-1"></i>Non installée
                        {% endif %}
                    </div>
                    {% if app.id in enabled_app_ids %}
                    <a href="{{ app.route_path }}" class="btn btn-primary btn-sm">
                        <i class="bi bi-box-arrow-up-right me-1"></i>Ouvrir
                    </a>
                    {% endif %}
                </div>

                <!-- Loading Overlay -->
                <div class="loading-overlay" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <i class="bi bi-app-indicator"></i>
                <h5 class="mb-2">Aucune application disponible</h5>
                <p>Les applications seront bientôt disponibles.</p>
            </div>
            {% endfor %}
        </div>

        <!-- Empty State (pour les recherches) -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="bi bi-search"></i>
            <h5 class="mb-2">Aucune application trouvée</h5>
            <p>Essayez avec d'autres mots-clés</p>
        </div>
    </main>
</div>

<!-- Toast Container -->
<div class="toast-container"></div>

<!-- Confirmation Modal for Uninstall -->
<div class="modal fade" id="uninstallModal" tabindex="-1" aria-labelledby="uninstallModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title" id="uninstallModalLabel">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                    Désinstaller l'application
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div class="app-icon-large mb-3" id="modalAppIcon">
                        <i class="bi bi-app"></i>
                    </div>
                    <h6 class="fw-bold mb-3" id="modalAppName">Nom de l'application</h6>
                </div>
                
                <div class="alert alert-info border-0" style="background: #f0f9ff; color: #0369a1;">
                    <div class="d-flex">
                        <i class="bi bi-info-circle me-3 mt-1 flex-shrink-0"></i>
                        <div>
                            <p class="mb-2"><strong>Que se passe-t-il lors de la désinstallation ?</strong></p>
                            <ul class="mb-0 ps-0" style="list-style: none;">
                                <li class="mb-1"><i class="bi bi-check2 text-primary me-2"></i>L'application disparaîtra de votre dashboard</li>
                                <li class="mb-1"><i class="bi bi-shield-check text-primary me-2"></i>Vos données seront conservées pendant <strong>30 jours</strong></li>
                                <li class="mb-1"><i class="bi bi-arrow-clockwise text-primary me-2"></i>Vous pouvez réinstaller à tout moment</li>
                                <li><i class="bi bi-clock text-muted me-2"></i>Suppression automatique après 30 jours d'inactivité</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-danger" id="confirmUninstall">
                    <i class="bi bi-trash me-2"></i>Désinstaller
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Pass Django URL to JavaScript -->
<div data-toggle-url="{% url 'app_manager:api_app_toggle' 0 %}" style="display: none;"></div>
<script src="{% static 'app_manager/js/app_store.js' %}?v=2"></script>
{% endblock %}
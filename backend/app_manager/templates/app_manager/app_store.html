{% extends 'saas_web/base.html' %}
{% load static %}

{% block title %}App Store - Open Linguify{% endblock %}

{% block extra_css %}
<!-- Preload critical icons pour ultra performance -->
<link rel="preload" href="/app-icons/community/icon.png" as="image">
<link rel="preload" href="/app-icons/chat/icon.png" as="image">
<link rel="preload" href="/app-icons/course/icon.png" as="image">
<link rel="preload" href="/app-icons/documents/icon.png" as="image">
<link rel="preload" href="/app-icons/language_ai/icon.png" as="image">
<link rel="preload" href="/app-icons/notebook/icon.png" as="image">
<link rel="preload" href="/app-icons/quizz/icon.png" as="image">
<link rel="preload" href="/app-icons/revision/icon.png" as="image">
<link rel="preload" href="/app-icons/todo/icon.png" as="image">
<link rel="preload" href="/app-icons/teaching/icon.png" as="image">
{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Layout App Store avec classes Tailwind -->
<div class="app-store-layout">
    <!-- Sidebar utilisant les classes tailwind-modals -->
    <aside class="sidebar-linguify hidden md:block">
        <div class="sidebar-header-linguify">
            <h6>Catégories</h6>
        </div>
        <div class="sidebar-content">
            <div class="p-4 space-y-1">
                <button class="category-item active w-full flex items-center justify-between p-2 rounded text-left border-0 text-gray-700 hover:bg-gray-100" data-category="all">
                    <div class="flex items-center">
                        <i class="bi bi-grid-3x3-gap mr-2 text-sm"></i>
                        <span class="text-sm font-medium">Toutes les apps</span>
                    </div>
                    <span class="text-xs bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded" id="count-all">{{ total_apps }}</span>
                </button>
                
                {% for category_id, definition in category_definitions.items %}
                <button class="category-item w-full flex items-center justify-between p-2 rounded text-left border-0 text-gray-700 hover:bg-gray-100" data-category="{{ category_id }}">
                    <div class="flex items-center">
                        <i class="{{ definition.icon }} mr-2 text-sm text-gray-500"></i>
                        <span class="text-sm">{{ definition.label }}</span>
                    </div>
                    <span class="text-xs bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded" id="count-{{ category_id }}">
                        {% for cat_id, count in category_counts.items %}
                            {% if cat_id == category_id %}{{ count }}{% endif %}
                        {% empty %}0{% endfor %}
                    </span>
                </button>
                {% endfor %}
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="app-store-main">
        <!-- Search Bar -->
        <div class="search-bar">
            <i class="bi bi-search"></i>
            <input type="text" placeholder="Rechercher une application..." id="searchInput">
        </div>

        <!-- Apps Grid -->
        <div class="apps-grid" id="appsGrid">
            {% for app in apps %}
            <div class="app-card" data-category="{{ app.category|default:'other' }}" data-app-id="{{ app.id }}">
                <!-- App Header -->
                <div class="app-header">
                    <!-- App Icon -->
                    <div class="app-icon bg-gray-50 border border-gray-200">
                        {% if app.static_icon %}
                            <img src="{{ app.static_icon }}" alt="{{ app.display_name }} icon" 
                                 class="w-10 h-10 object-contain">
                        {% else %}
                            <i class="bi bi-app text-2xl text-gray-400"></i>
                        {% endif %}
                    </div>
                    
                    <!-- App Info -->
                    <div class="app-info">
                        <h3 class="app-title truncate">{{ app.display_name }}</h3>
                        <span class="app-category">{{ app.category_display|default:'Application' }}</span>
                    </div>
                    
                    <!-- Install Toggle -->
                    <div class="install-toggle">
                        <input type="checkbox" id="toggle-{{ app.id }}" 
                               {% if app.id in enabled_app_ids %}checked{% endif %}
                               data-app-id="{{ app.id }}">
                        <label for="toggle-{{ app.id }}" class="install-toggle-slider"></label>
                    </div>
                </div>

                <!-- App Description -->
                <p class="app-description">{{ app.description|default:'Description de l\'application.' }}</p>

                <!-- App Footer -->
                <div class="app-footer">
                    <div class="install-status {% if app.id in enabled_app_ids %}installed{% endif %}">
                        {% if app.id in enabled_app_ids %}
                            <i class="bi bi-check-circle me-1"></i>Installée
                        {% else %}
                            <i class="bi bi-download me-1"></i>Non installée
                        {% endif %}
                    </div>
                    {% if app.id in enabled_app_ids %}
                    <a href="{{ app.route_path }}" class="inline-flex items-center px-3 py-1.5 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition-colors duration-200">
                        <i class="bi bi-box-arrow-up-right me-1"></i>Ouvrir
                    </a>
                    {% endif %}
                </div>

                <!-- Loading Overlay -->
                <div class="loading-overlay hidden" id="loading-{{ app.id }}">
                    <div class="w-8 h-8 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                </div>
            </div>
            {% empty %}
            <div class="col-span-full empty-state">
                <i class="bi bi-app-indicator"></i>
                <h5 class="text-xl font-medium text-gray-700 mb-2">Aucune application disponible</h5>
                <p class="text-gray-500">Les applications seront bientôt disponibles.</p>
            </div>
            {% endfor %}
        </div>

        <!-- Empty State (pour les recherches) -->
        <div class="col-span-full empty-state hidden" id="emptyState">
            <i class="bi bi-search"></i>
            <h5 class="text-xl font-medium text-gray-700 mb-2">Aucune application trouvée</h5>
            <p class="text-gray-500">Essayez avec d'autres mots-clés</p>
        </div>
    </main>
</div>

<!-- Toast Container -->
<div class="toast-container"></div>

<!-- Confirmation Modal for Uninstall -->
<div class="modal fade" id="uninstallModal" tabindex="-1" aria-labelledby="uninstallModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title" id="uninstallModalLabel">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                    Désinstaller l'application
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div class="app-icon-large mb-3" id="modalAppIcon">
                        <i class="bi bi-app"></i>
                    </div>
                    <h6 class="fw-bold mb-3" id="modalAppName">Nom de l'application</h6>
                </div>
                
                <div class="alert alert-info border-0" style="background: #f0f9ff; color: #0369a1;">
                    <div class="d-flex">
                        <i class="bi bi-info-circle me-3 mt-1 flex-shrink-0"></i>
                        <div>
                            <p class="mb-2"><strong>Que se passe-t-il lors de la désinstallation ?</strong></p>
                            <ul class="mb-0 ps-0" style="list-style: none;">
                                <li class="mb-1"><i class="bi bi-check2 text-primary me-2"></i>L'application disparaîtra de votre dashboard</li>
                                <li class="mb-1"><i class="bi bi-shield-check text-primary me-2"></i>Vos données seront conservées pendant <strong>30 jours</strong></li>
                                <li class="mb-1"><i class="bi bi-arrow-clockwise text-primary me-2"></i>Vous pouvez réinstaller à tout moment</li>
                                <li><i class="bi bi-clock text-muted me-2"></i>Suppression automatique après 30 jours d'inactivité</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-danger" id="confirmUninstall">
                    <i class="bi bi-trash me-2"></i>Désinstaller
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Pass Django URL to JavaScript -->
<div data-toggle-url="{% url 'app_manager:api_app_toggle' 0 %}" style="display: none;"></div>
<script src="{% static 'app_manager/js/app_store.js' %}?v=2"></script>

<!-- JavaScript Compatible avec les classes Tailwind -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion des catégories actives avec la classe .active définie in tailwind-modals.css
    document.querySelectorAll('.category-item').forEach(btn => {
        btn.addEventListener('click', function() {
            // Reset all - retire la classe active de tous
            document.querySelectorAll('.category-item').forEach(b => {
                b.classList.remove('active');
            });
            
            // Ajouter la classe active au bouton cliqué
            this.classList.add('active');
        });
    });
});
</script>
{% endblock %}
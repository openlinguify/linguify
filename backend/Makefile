# Makefile for Linguify Backend Development
# Complete application and database management

.PHONY: help install run clean apps apps-manifests app-hide app-show app-order app-delete sync-manifests st test-prod test-dev sync-prod sync-app setup-db migrate reset-db deploy-prod deploy check-deploy env env-dev env-prod

# ==============================================================================
# ğŸ¯ HELP & INFORMATION
# ==============================================================================

help:
	@echo "ğŸš€ LINGUIFY BACKEND - COMPLETE COMMANDS"
	@echo "========================================"
	@echo ""
	@echo "ğŸ“‹ DETAILED HELP:"
	@echo "  help-apps        Application management: status, visibility, sync, deletion"
	@echo "  help-db          Database management: status, sync, config, migrations"  
	@echo "  help-dev         Development: server, tests, code formatting, cleanup"
	@echo "  help-deploy      Deployment: production, validation, comparisons, workflow"
	@echo ""
	@echo "âš¡ QUICK COMMANDS:"
	@echo "  st               Quick status (dev + prod)"
	@echo "  apps             List applications"
	@echo "  env              Show current environment"
	@echo "  env-dev          Switch to DEVELOPMENT"
	@echo "  env-prod         âš ï¸  Switch to PRODUCTION"
	@echo "  run              Start development server"
	@echo "  test             Run tests"
	@echo ""
	@echo "ğŸ”§ INITIAL SETUP:"
	@echo "  setup            Complete initial configuration"
	@echo "  setup-db         PostgreSQL configuration only"

# ==============================================================================
# ğŸ“± APPLICATION MANAGEMENT
# ==============================================================================

help-apps:
	@echo "ğŸ“± APPLICATION MANAGEMENT"
	@echo "========================="
	@echo ""
	@echo "ğŸ“‹ Status and information:"
	@echo "  apps                     List all applications"
	@echo "  apps-manifests          List found manifests"
	@echo "  app-info APP=<code>     Detailed app info"
	@echo ""
	@echo "ğŸ‘ï¸  Visibility:"
	@echo "  app-hide APP=<code>     Hide app from users"
	@echo "  app-show APP=<code>     Make app visible"
	@echo "  app-order APP=<code> ORDER=<num>  Change display order"
	@echo ""
	@echo "ğŸ”„ Synchronization:"
	@echo "  sync-app APP=<code>     Sync app to production"
	@echo "  sync-manifests          Sync all manifests"
	@echo "  sync-icons              Sync icons from manifests"
	@echo "  apply-manifests         Apply visibility per manifests"
	@echo ""
	@echo "ğŸ—‘ï¸  Cleanup:"
	@echo "  app-delete APP=<code>   Permanently delete app"
	@echo ""
	@echo "ğŸ“ Examples:"
	@echo "  make apps"
	@echo "  make app-hide APP=demo_app_test"
	@echo "  make app-show APP=community"
	@echo "  make sync-app APP=course"
	@echo "  make sync-icons"

apps:
	@echo "ğŸ“± Listing applications..."
	@$(eval ENV_VAL := $(shell grep DJANGO_ENV .env | cut -d'=' -f2 | tr -d '"'))
	@DJANGO_ENV=$(ENV_VAL) poetry run python scripts/database/app_manager.py list

apps-manifests:
	@echo "ğŸ“‹ Application manifests..."
	poetry run python scripts/database/manifest_manager.py list

app-hide:
	@if [ -z "$(APP)" ]; then \
		echo "âŒ Usage: make app-hide APP=<code>"; \
		echo "ğŸ“ Example: make app-hide APP=demo_app_test"; \
		exit 1; \
	fi
	@echo "ğŸ‘ï¸  Hiding application: $(APP)"
	@$(eval ENV_VAL := $(shell grep DJANGO_ENV .env | cut -d'=' -f2 | tr -d '"'))
	@DJANGO_ENV=$(ENV_VAL) poetry run python scripts/database/app_manager.py hide $(APP)

app-show:
	@if [ -z "$(APP)" ]; then \
		echo "âŒ Usage: make app-show APP=<code>"; \
		echo "ğŸ“ Example: make app-show APP=community"; \
		exit 1; \
	fi
	@echo "ğŸ‘ï¸  Showing application: $(APP)"
	@$(eval ENV_VAL := $(shell grep DJANGO_ENV .env | cut -d'=' -f2 | tr -d '"'))
	@DJANGO_ENV=$(ENV_VAL) poetry run python scripts/database/app_manager.py show $(APP)

app-order:
	@if [ -z "$(APP)" ] || [ -z "$(ORDER)" ]; then \
		echo "âŒ Usage: make app-order APP=<code> ORDER=<number>"; \
		echo "ğŸ“ Example: make app-order APP=course ORDER=1"; \
		exit 1; \
	fi
	@echo "ğŸ“Š Changing order: $(APP) â†’ position $(ORDER)"
	@$(eval ENV_VAL := $(shell grep DJANGO_ENV .env | cut -d'=' -f2 | tr -d '"'))
	@DJANGO_ENV=$(ENV_VAL) poetry run python scripts/database/app_manager.py order $(APP) $(ORDER)

app-delete:
	@if [ -z "$(APP)" ]; then \
		echo "âŒ Usage: make app-delete APP=<code>"; \
		echo "ğŸ“ Example: make app-delete APP=demo_app_test"; \
		exit 1; \
	fi
	@echo "ğŸ—‘ï¸  Deleting application: $(APP)"
	@$(eval ENV_VAL := $(shell grep DJANGO_ENV .env | cut -d'=' -f2 | tr -d '"'))
	@DJANGO_ENV=$(ENV_VAL) poetry run python scripts/database/app_manager.py delete $(APP)

sync-manifests:
	@echo "ğŸ”„ Complete manifest synchronization..."
	@echo "   ğŸ“± Syncing app metadata"
	@echo "   ğŸ¨ Syncing icons from static/description/"
	@echo "   ğŸ’¾ Updating database"
	@echo ""
	@poetry run python manage.py sync_manifests
	@echo ""
	@echo "âœ… Manifests synchronized!"

sync-icons:
	@echo "ğŸ¨ Synchronizing application icons..."
	@echo "   ğŸ“– Reading app manifests (__manifest__.py)"
	@echo "   ğŸ” Searching icons in static/description/"
	@echo "   ğŸ’¾ Updating database with icon info"
	@echo "   ğŸ¯ Converting categories to appropriate Bootstrap icons"
	@echo ""
	@poetry run python manage.py sync_app_icons
	@echo ""
	@echo "âœ… Icons synchronized! Restart server to see changes."

apply-manifests:
	@echo "ğŸ”§ Applying manifests per environment..."
	@$(eval ENV_VAL := $(shell grep DJANGO_ENV .env | cut -d'=' -f2 | tr -d '"'))
	@DJANGO_ENV=$(ENV_VAL) poetry run python scripts/database/manifest_manager.py apply-manifest

# ==============================================================================
# ğŸ—„ï¸ DATABASE MANAGEMENT  
# ==============================================================================

help-db:
	@echo "ğŸ—„ï¸  DATABASE MANAGEMENT"
	@echo "==================="
	@echo ""
	@echo "ğŸ“Š Status:"
	@echo "  st               Quick status (dev + prod)"
	@echo "  status           Detailed status with comparisons"
	@echo "  test-prod        Test production connection"
	@echo "  test-dev         Test development connection"
	@echo ""
	@echo "ğŸ”„ Synchronization:"
	@echo "  sync-prod        Production â†’ Development (complete)"
	@echo "  sync-app APP=X   Sync specific app"
	@echo ""
	@echo "âš™ï¸  Configuration:"
	@echo "  setup-db         Configure local PostgreSQL"
	@echo "  migrate          Run migrations"
	@echo "  reset-db         Reset local DB"
	@echo ""
	@echo "ğŸ“± Test apps:"
	@echo "  quizz, course, notebook, revision, language_ai"
	@echo ""
	@echo "ğŸ“ OpenLinguify Blog:"
	@echo "  blog-articles              Create SEO articles (dev)"
	@echo "  blog-dev / blog-prod       Article status by environment"
	@echo "  blog-sync-prod             Sync dev â†’ prod (complete)"
	@echo "  blog-sync-prod-all         Sync by model (categoryâ†’tagâ†’blogpost)"
	@echo ""
	@echo "ğŸ”„ Granular synchronization:"
	@echo "  make blog blogpost prod         Sync a table (short format)"
	@echo "  make blog-sync-table TABLE=category TARGET=prod"
	@echo "  make course-sync-table TABLE=lesson TARGET=prod"

st:
	@echo "âš¡ QUICK STATUS"
	@echo "============="
	@echo ""
	@echo "ğŸš€ Testing production with demo_app_test:"
	@if make sync-app APP=demo_app_test 2>/dev/null | grep -q "Production: âœ… Disponible"; then \
		echo "   âœ… Production connected"; \
		echo "   ğŸ“± Visible apps: $(shell make apps 2>/dev/null | grep -c 'âœ… Visible')"; \
		echo "   ğŸ“± Hidden apps: $(shell make apps 2>/dev/null | grep -c 'âŒ CachÃ©e')"; \
	else \
		echo "   âŒ Production unavailable"; \
	fi
	@echo ""
	@echo "ğŸ—ï¸  Development:"
	@if make sync-app APP=demo_app_test 2>/dev/null | grep -q "DÃ©veloppement: âœ… Disponible"; then \
		echo "   âœ… Development connected"; \
	else \
		echo "   âŒ Local PostgreSQL not configured"; \
		echo "   ğŸ’¡ To configure: make setup-db"; \
	fi
	@echo ""
	@echo "ğŸ› ï¸  Quick actions:"
	@echo "   make apps              # List apps"
	@echo "   make app-hide APP=X    # Hide an app"  
	@echo "   make sync-app APP=X    # Sync to prod"

test-prod:
	@echo "ğŸš€ Testing production connection..."
	@make sync-app APP=demo_app_test | head -3

test-dev:
	@echo "ğŸ—ï¸  Testing development connection..."
	@if make sync-app APP=demo_app_test 2>/dev/null | grep -q "DÃ©veloppement: âœ… Disponible"; then \
		echo "âœ… Development connected"; \
	else \
		echo "âŒ Development unavailable"; \
		echo "ğŸ’¡ Configuration: make setup-db"; \
	fi

sync-prod:
	@echo "ğŸ”„ Synchronizing Production â†’ Development..."
	poetry run python scripts/database/sync_prod_to_dev.py

sync-app:
	@if [ -z "$(APP)" ]; then \
		echo "âŒ Usage: make sync-app APP=<code>"; \
		echo "ğŸ“ Example: make sync-app APP=course"; \
		exit 1; \
	fi
	@echo "ğŸ”„ Synchronizing app: $(APP)"
	poetry run python scripts/database/hybrid_sync_app.py $(APP)

setup-db:
	@echo "ğŸ—„ï¸  Configuring PostgreSQL..."
	bash scripts/database/setup_postgresql.sh

migrate:
	@echo "ğŸ—„ï¸  Running database migrations..."
	poetry run python manage.py migrate

reset-db:
	@echo "ğŸ—„ï¸  Resetting local database..."
	poetry run python scripts/database/clean_database.py

# ==============================================================================
# ğŸ“ BLOG MANAGEMENT & TABLE SYNC
# ==============================================================================

# Blog Management
blog-articles:
	@echo "ğŸ“ Creating OpenLinguify SEO articles (blog dev â†’ articles + categories + tags)..."
	poetry run python manage.py create_seo_articles

blog-sync-prod:
	@echo "ğŸ”„ Complete blog synchronization to production..."
	poetry run python scripts/database/sync_blog_simple.py

blog-dev:
	@echo "ğŸ—ï¸  Blog articles in development..."
	@poetry run python manage.py shell -c "from core.blog.models import BlogPost, Category, Tag; print(f'ğŸ“„ Articles: {BlogPost.objects.count()}'); print(f'ğŸ“‚ Categories: {Category.objects.count()}'); print(f'ğŸ·ï¸  Tags: {Tag.objects.count()}')"

blog-prod:
	@echo "ğŸš€ Blog articles in production..."
	@DJANGO_ENV=production poetry run python manage.py shell -c "from core.blog.models import BlogPost, Category, Tag; print(f'ğŸ“„ Articles: {BlogPost.objects.count()}'); print(f'ğŸ“‚ Categories: {Category.objects.count()}'); print(f'ğŸ·ï¸  Tags: {Tag.objects.count()}')"

# Table Synchronization (format: make <app>-sync-table TABLE=<table> TARGET=<env>)
%-sync-table:
	@if [ -z "$(TABLE)" ] || [ -z "$(TARGET)" ]; then \
		echo "âŒ Usage: make <app>-sync-table TABLE=<table> TARGET=<env>"; \
		echo "ğŸ“ Examples:"; \
		echo "  make blog-sync-table TABLE=blogpost TARGET=prod"; \
		echo "  make blog-sync-table TABLE=category TARGET=prod"; \
		echo "  make course-sync-table TABLE=lesson TARGET=prod"; \
		exit 1; \
	fi
	@$(eval APP := $(word 1,$(subst -, ,$*)))
	@echo "ğŸ”„ Synchronizing $(APP).$(TABLE) â†’ $(TARGET)"
	@poetry run python scripts/database/sync_table_simple.py $(APP) $(TABLE) $(TARGET)

# Shorthand syntax (format: make blog blogpost prod)
%:
	@if [ "$(words $(MAKECMDGOALS))" = "3" ]; then \
		$(eval APP := $(word 1,$(MAKECMDGOALS))) \
		$(eval TABLE := $(word 2,$(MAKECMDGOALS))) \
		$(eval TARGET := $(word 3,$(MAKECMDGOALS))) \
		echo "ğŸ”„ Synchronizing $(APP).$(TABLE) â†’ $(TARGET)"; \
		poetry run python scripts/database/sync_table_simple.py $(APP) $(TABLE) $(TARGET); \
	else \
		echo "âŒ Unrecognized format. Use:"; \
		echo "  make <app> <table> <target>    # Example: make blog blogpost prod"; \
		echo "  make <app>-sync-table TABLE=<table> TARGET=<env>"; \
	fi

# App-specific sync shortcuts
blog-sync-prod-all:
	@echo "ğŸ”„ Complete blog synchronization (all models)..."
	@make blog-sync-table TABLE=category TARGET=prod
	@make blog-sync-table TABLE=tag TARGET=prod
	@make blog-sync-table TABLE=blogpost TARGET=prod
	@echo "âœ… Blog completely synchronized"

course-sync-prod-all:
	@echo "ğŸ”„ Complete course synchronization (main models)..."
	@make course-sync-table TABLE=unit TARGET=prod
	@make course-sync-table TABLE=lesson TARGET=prod
	@make course-sync-table TABLE=vocabularylist TARGET=prod
	@echo "âœ… Course completely synchronized"

# ==============================================================================
# ğŸš€ DEPLOYMENT
# ==============================================================================

help-deploy:
	@echo "ğŸš€ DEPLOYMENT AND PRODUCTION"
	@echo "=========================="
	@echo ""
	@echo "ğŸ¯ Interactive deployment:"
	@echo "  deploy-prod      Complete interactive menu"
	@echo "  deploy-apps      Deploy apps only"
	@echo "  deploy-content   Deploy content only"
	@echo ""
	@echo "âš¡ Quick deployment:"
	@echo "  deploy APP=<code>        Deploy specific app"
	@echo "  deploy-visible           Deploy all visible apps"
	@echo ""
	@echo "ğŸ” Pre-deployment validation:"
	@echo "  check-deploy     Check what can be deployed"
	@echo "  diff-prod        Compare dev vs prod"
	@echo ""
	@echo "ğŸ“ Recommended workflow:"
	@echo "  1. make check-deploy     # Check differences"
	@echo "  2. make deploy APP=X     # Deploy an app"
	@echo "  3. make app-hide APP=X   # Hide if not ready"
	@echo "  4. make app-show APP=X   # Show when ready"

deploy-prod:
	@echo "ğŸš€ Interactive deployment to production..."
	poetry run python scripts/database/deploy_to_production.py

deploy:
	@if [ -z "$(APP)" ]; then \
		echo "âŒ Usage: make deploy APP=<code>"; \
		echo "ğŸ“ Example: make deploy APP=course"; \
		exit 1; \
	fi
	@echo "ğŸš€ Quick deployment: $(APP)"
	@make sync-app APP=$(APP)
	@echo "âœ… App $(APP) deployed"
	@echo "ğŸ’¡ To make it visible: make app-show APP=$(APP)"

check-deploy:
	@echo "ğŸ” Checking deployable items..."
	@echo "ğŸ“± Hidden apps that could be deployed:"
	@make apps | grep "âŒ CachÃ©e" || echo "   No hidden apps"
	@echo ""
	@echo "ğŸ’¡ To deploy: make deploy APP=<code>"
	@echo "ğŸ’¡ To make visible: make app-show APP=<code>"

# ==============================================================================
# âš¡ DEVELOPMENT
# ==============================================================================

env:
	@echo "ğŸ” Current environment:"
	@poetry run python scripts/check_env.py

env-dev:
	@echo "ğŸ—ï¸  Switching to DEVELOPMENT mode..."
	@sed -i 's/DJANGO_ENV="production"/DJANGO_ENV="development"/' .env
	@echo "âœ… Environment changed: DEVELOPMENT"
	@echo "   Database: Local PostgreSQL (localhost)"
	@make env

env-prod:
	@echo "ğŸš€ Switching to PRODUCTION mode..."
	@echo "âš ï¸  WARNING: You will be working on the PRODUCTION database!"
	@read -p "Are you sure? (type 'yes' to confirm): " confirm; \
	if [ "$$confirm" = "yes" ]; then \
		sed -i 's/DJANGO_ENV="development"/DJANGO_ENV="production"/' .env; \
		echo "âœ… Environment changed: PRODUCTION"; \
		echo "   Database: Supabase"; \
		make env; \
	else \
		echo "âŒ Change cancelled"; \
	fi

help-dev:
	@echo "âš¡ DEVELOPMENT"
	@echo "============"
	@echo ""
	@echo "ğŸƒ Server:"
	@echo "  run              Start Django server"
	@echo "  shell            Open Django shell"
	@echo "  admin            Create superuser"
	@echo ""
	@echo "ğŸ§ª Tests:"
	@echo "  test             All tests"
	@echo "  test-fast        Quick tests (no setup)"
	@echo "  test-app APP=X   Specific app tests"
	@echo "  test-revision	  Complete revision test suite"
	@echo "  test-system      System tests"
	@echo ""
	@echo "ğŸ¨ Code:"
	@echo "  lint             Check code"
	@echo "  format           Format code"
	@echo "  check            Django checks"
	@echo ""
	@echo "ğŸ§¹ Cleanup:"
	@echo "  clean            Clean temporary files"

install:
	@echo "ğŸ“¦ Installing dependencies..."
	poetry install

run:
	@echo "ğŸš€ Starting Django server..."
	poetry run python manage.py runserver 0.0.0.0:8000

shell:
	@echo "ğŸš Opening Django shell..."
	poetry run python manage.py shell

admin:
	@echo "ğŸ‘¤ Creating superuser..."
	poetry run python manage.py createsuperuser

test:
	@echo "ğŸ§ª Running base tests..."
	@echo "â„¹ï¸  Selective tests to avoid configuration conflicts"
	@DJANGO_SETTINGS_MODULE=core.settings_test poetry run python manage.py test tests --verbosity=2

test-fast:
	@echo "ğŸ§ª Quick tests (Django check only)..."
	poetry run python manage.py check

test-app:
	@if [ -z "$(APP)" ]; then \
		echo "âŒ Usage: make test-app APP=<app_name>"; \
		echo "ğŸ“ Example: make test-app APP=notebook"; \
		exit 1; \
	fi
	@echo "ğŸ§ª Testing app: $(APP)"
	@DJANGO_SETTINGS_MODULE=core.settings_test poetry run python manage.py test apps.$(APP) --verbosity=2

test-revision:
	@echo "ğŸ§ª Running revision tests"
	@echo ""
	@DJANGO_SETTINGS_MODULE=core.settings_test poetry run python manage.py test apps.revision.tests.test_integration --verbosity=2
	@echo ""
	@DJANGO_SETTINGS_MODULE=core.settings_test poetry run python manage.py test apps.revision.tests.test_learning_edge_cases --verbosity=2
	@echo ""
	@DJANGO_SETTINGS_MODULE=core.settings_test poetry run python manage.py test apps.revision.tests.test_learning_integration --verbosity=2
	@echo ""
	@DJANGO_SETTINGS_MODULE=core.settings_test poetry run python manage.py test apps.revision.tests.test_learning_settings --verbosity=2
	@echo ""
	@DJANGO_SETTINGS_MODULE=core.settings_test poetry run python manage.py test apps.revision.tests.test_learning_viewsets --verbosity=2
	@echo ""
	@DJANGO_SETTINGS_MODULE=core.settings_test poetry run python manage.py test apps.revision.tests.test_models --verbosity=2
	@echo ""
	@DJANGO_SETTINGS_MODULE=core.settings_test poetry run python manage.py test apps.revision.tests.test_permissions --verbosity=2
	@echo ""
	@DJANGO_SETTINGS_MODULE=core.settings_test poetry run python manage.py test apps.revision.tests.test_serializers --verbosity=2
	@echo ""
	@DJANGO_SETTINGS_MODULE=core.settings_test poetry run python manage.py test apps.revision.tests.test_simple --verbosity=2
	@echo ""
	@DJANGO_SETTINGS_MODULE=core.settings_test poetry run python manage.py test apps.revision.tests.test_tags --verbosity=2
	@echo ""
	@DJANGO_SETTINGS_MODULE=core.settings_test poetry run python manage.py test apps.revision.tests.test_views_api --verbosity=2
	@echo ""
	@DJANGO_SETTINGS_MODULE=core.settings_test poetry run python manage.py test apps.revision.tests.test_settings --verbosity=2
	@echo ""
	@echo "âœ… Tests Revision App are finished!"

test-system:
	@echo "ğŸ§ª System tests (public_web)..."
	@DJANGO_SETTINGS_MODULE=core.settings_test poetry run python manage.py test tests.test_public_web_views --verbosity=2

lint:
	@echo "ğŸ” Checking code..."
	poetry run flake8 . --count --show-source --statistics

format:
	@echo "ğŸ¨ Formatting code..."
	poetry run black . --line-length=120
	poetry run isort . --profile black

check:
	@echo "ğŸ”§ Django checks..."
	poetry run python manage.py check

clean:
	@echo "ğŸ§¹ Cleaning temporary files..."
	find . -name "*.pyc" -delete
	find . -name "__pycache__" -delete
	rm -rf .coverage htmlcov/ .pytest_cache/

# ==============================================================================
# ğŸ¯ SETUP & CONFIGURATION
# ==============================================================================

setup:
	@echo "ğŸ¯ COMPLETE LINGUIFY CONFIGURATION"
	@echo "================================="
	@echo ""
	@echo "1ï¸âƒ£ Installing dependencies..."
	@make install
	@echo ""
	@echo "2ï¸âƒ£ Configuring PostgreSQL..."
	@make setup-db
	@echo ""
	@echo "3ï¸âƒ£ Running migrations..."
	@make migrate
	@echo ""
	@echo "4ï¸âƒ£ Syncing from production..."
	@make sync-prod
	@echo ""
	@echo "5ï¸âƒ£ Syncing manifests..."
	@make sync-manifests
	@echo ""
	@echo "6ï¸âƒ£ Syncing icons..."
	@make sync-icons
	@echo ""
	@echo "âœ… CONFIGURATION COMPLETE!"
	@echo ""
	@echo "ğŸ¯ Next steps:"
	@echo "  make admin       # Create superuser"
	@echo "  make run         # Start server"
	@echo "  make st          # Check status"

# ==============================================================================
# ğŸ“‹ UTILITY COMMANDS
# ==============================================================================

# Command to see all available commands
list-commands:
	@echo "ğŸ“‹ ALL AVAILABLE COMMANDS"
	@echo "======================"
	@grep -E '^[a-zA-Z_-]+:' Makefile | sed 's/://' | sort | column -t

# Command to validate configuration
validate:
	@echo "âœ… CONFIGURATION VALIDATION"
	@echo "========================"
	@echo ""
	@echo "ğŸ” Django verification..."
	@make check
	@echo ""
	@echo "ğŸ“Š Database status..."
	@make st
	@echo ""
	@echo "ğŸ“± Applications..."
	@make apps | head -5
	@echo ""
	@echo "Validation complete"
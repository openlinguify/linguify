{% load static %}
{% load i18n %}

<!-- Voice Assistant Tab Content -->
<div class="form-section">
    <h3 class="form-section-title">
        <i class="bi bi-mic-fill"></i>
        État de l'Assistant
    </h3>
    <div class="row">
        <div class="col-md-6">
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="voiceCommandsEnabled" checked>
                <label class="form-check-label" for="voiceCommandsEnabled">
                    <strong>Commandes vocales</strong><br>
                    <small class="text-muted">Activer la reconnaissance des commandes vocales</small>
                </label>
            </div>
            
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="ttsEnabled" checked>
                <label class="form-check-label" for="ttsEnabled">
                    <strong>Synthèse vocale</strong><br>
                    <small class="text-muted">Activer les réponses vocales</small>
                </label>
            </div>
            
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="autoListen">
                <label class="form-check-label" for="autoListen">
                    <strong>Écoute automatique</strong><br>
                    <small class="text-muted">Écouter automatiquement après les réponses</small>
                </label>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="form-group mb-3">
                <label class="form-label" for="voiceSpeed">Vitesse de parole</label>
                <select class="form-control" id="voiceSpeed">
                    <option value="slow">Lent</option>
                    <option value="normal" selected>Normal</option>
                    <option value="fast">Rapide</option>
                </select>
            </div>
            
            <div class="form-group mb-3">
                <label class="form-label" for="micSensitivity">Sensibilité du microphone</label>
                <div class="d-flex align-items-center">
                    <input type="range" class="form-range me-2" id="micSensitivity" min="1" max="100" value="70">
                    <span id="sensitivityValue">70%</span>
                </div>
            </div>
            
            <button class="btn btn-primary" id="testVoiceBtn">
                <i class="bi bi-volume-up me-1"></i>
                Tester la voix
            </button>
        </div>
    </div>
</div>

<div class="form-section mt-4">
    <h3 class="form-section-title">
        <i class="bi bi-globe"></i>
        Paramètres linguistiques
    </h3>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label class="form-label">Langue de reconnaissance vocale</label>
                <p class="text-muted">Basée sur votre langue maternelle : <strong>{{ user.native_language|upper }}</strong></p>
                <small class="text-info">
                    <i class="bi bi-info-circle me-1"></i>
                    Les commandes vocales s'adaptent automatiquement à votre langue maternelle.
                </small>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label class="form-label">Langue des réponses</label>
                <p class="text-muted">Langue de l'interface : <strong>{{ LANGUAGE_CODE|upper }}</strong></p>
                <small class="text-info">
                    <i class="bi bi-info-circle me-1"></i>
                    Les réponses vocales utilisent la langue de votre interface.
                </small>
            </div>
        </div>
    </div>
</div>

<div class="form-section mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="form-section-title">
            <i class="bi bi-list-ul"></i>
            Commandes disponibles
        </h3>
        <button class="btn btn-outline-primary btn-sm" id="refreshVoiceCommandsBtn">
            <i class="bi bi-arrow-clockwise me-1"></i>
            Actualiser
        </button>
    </div>
    
    <div class="row" id="voiceCommandsContainer">
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2">Chargement des commandes...</p>
        </div>
    </div>
</div>

<div class="form-section mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="form-section-title">
            <i class="bi bi-plus-square"></i>
            Commandes personnalisées
        </h3>
        <button class="btn btn-success btn-sm" id="addVoiceCommandBtn">
            <i class="bi bi-plus-circle me-1"></i>
            Ajouter
        </button>
    </div>
    
    <div id="customVoiceCommandsContainer">
        <div class="text-center text-muted">
            <i class="bi bi-mic-mute" style="font-size: 2rem; opacity: 0.5;"></i>
            <p>Aucune commande personnalisée</p>
        </div>
    </div>
</div>

<div class="mt-4">
    <button type="button" class="btn btn-primary" id="saveVoiceSettingsBtn">
        <i class="bi bi-check2 me-2"></i>
        Sauvegarder les paramètres vocaux
    </button>
</div>

<!-- Add Command Modal -->
<div class="modal fade" id="addVoiceCommandModal" tabindex="-1" aria-labelledby="addVoiceCommandModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addVoiceCommandModalLabel">Ajouter une Commande Personnalisée</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addVoiceCommandForm">
                    <div class="mb-3">
                        <label for="voiceTriggerPhrase" class="form-label">Phrase de Déclenchement</label>
                        <input type="text" class="form-control" id="voiceTriggerPhrase" placeholder="ex: ouvrir mes notes" required>
                        <div class="form-text">La phrase que vous direz pour déclencher cette commande</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="voiceActionType" class="form-label">Type d'Action</label>
                        <select class="form-select" id="voiceActionType" required>
                            <option value="">Sélectionner une action</option>
                            <option value="navigate">Naviguer vers une URL</option>
                            <option value="toggle_theme">Changer le Thème</option>
                            <option value="custom_action">Action Personnalisée</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="voiceUrlField" style="display: none;">
                        <label for="voiceTargetUrl" class="form-label">URL de Destination</label>
                        <input type="text" class="form-control" id="voiceTargetUrl" placeholder="ex: /notes/">
                    </div>
                    
                    <div class="mb-3">
                        <label for="voiceResponseText" class="form-label">Réponse Vocale</label>
                        <input type="text" class="form-control" id="voiceResponseText" placeholder="ex: Ouverture de vos notes" required>
                        <div class="form-text">Ce que l'assistant dira lors de l'exécution de cette commande</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="saveVoiceCommandBtn">Sauvegarder la Commande</button>
            </div>
        </div>
    </div>
</div>

<script>
// Voice Settings Management pour l'onglet intégré
document.addEventListener('DOMContentLoaded', function() {
    // Initialize voice settings only when needed
    let voiceSettingsInitialized = false;
    
    function checkAndInitializeVoiceTab() {
        if (voiceSettingsInitialized) return;
        
        // Vérifier si l'onglet voice est visible et actif
        const voiceTab = document.getElementById('voice');
        const voiceTabButton = document.querySelector('[data-bs-target="#voice"]');
        
        if (voiceTab && (voiceTab.classList.contains('active') || voiceTab.classList.contains('show'))) {
            initializeVoiceTab();
            voiceSettingsInitialized = true;
        }
    }
    
    // Override showTab to initialize voice settings when voice tab is shown
    const originalShowTab = window.showTab;
    if (originalShowTab) {
        window.showTab = function(tabName) {
            originalShowTab(tabName);
            
            if (tabName === 'voice' && !voiceSettingsInitialized) {
                // Utiliser un délai pour s'assurer que l'onglet est complètement affiché
                setTimeout(() => {
                    initializeVoiceTab();
                    voiceSettingsInitialized = true;
                }, 100);
            }
        };
    }
    
    // Observer les changements de tabs avec MutationObserver
    const tabContainer = document.querySelector('.tab-content');
    if (tabContainer) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    checkAndInitializeVoiceTab();
                }
            });
        });
        
        observer.observe(tabContainer, {
            attributes: true,
            subtree: true,
            attributeFilter: ['class']
        });
    }
    
    // Check initial state
    setTimeout(checkAndInitializeVoiceTab, 500);
});

function initializeVoiceTab() {
    if (window.voiceTabManager) {
        console.log('Voice tab manager already initialized');
        return; // Already initialized
    }
    
    try {
        console.log('Initializing voice tab manager...');
        window.voiceTabManager = new VoiceTabManager();
        window.voiceTabManager.init();
        console.log('Voice tab manager initialized successfully');
    } catch (error) {
        console.error('Error initializing voice tab manager:', error);
    }
}

class VoiceTabManager {
    constructor() {
        this.apiBase = '/api/v1/vocal/';
    }
    
    init() {
        try {
            console.log('VoiceTabManager: Starting initialization...');
            this.bindEvents();
            this.loadPreferences();
            this.loadCommands();
            this.loadCustomCommands();
            console.log('VoiceTabManager: Initialization completed');
        } catch (error) {
            console.error('VoiceTabManager: Error during initialization:', error);
        }
    }
    
    bindEvents() {
        // Sensitivity slider
        const sensitivitySlider = document.getElementById('micSensitivity');
        if (sensitivitySlider) {
            sensitivitySlider.addEventListener('input', (e) => {
                document.getElementById('sensitivityValue').textContent = e.target.value + '%';
                this.savePreferences();
            });
        }

        // Test voice button
        const testBtn = document.getElementById('testVoiceBtn');
        if (testBtn) {
            testBtn.addEventListener('click', () => {
                if (window.linguifyVoiceAssistant) {
                    window.linguifyVoiceAssistant.speak("Test de l'assistant vocal réussi !");
                } else {
                    this.showMessage('Assistant vocal non disponible', 'error');
                }
            });
        }

        // Save button
        const saveBtn = document.getElementById('saveVoiceSettingsBtn');
        if (saveBtn) {
            saveBtn.addEventListener('click', () => this.savePreferences());
        }

        // Refresh commands
        const refreshBtn = document.getElementById('refreshVoiceCommandsBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => this.loadCommands());
        }

        // Add command
        const addBtn = document.getElementById('addVoiceCommandBtn');
        if (addBtn) {
            addBtn.addEventListener('click', () => {
                const modal = new bootstrap.Modal(document.getElementById('addVoiceCommandModal'));
                modal.show();
            });
        }

        // Modal events
        const actionSelect = document.getElementById('voiceActionType');
        if (actionSelect) {
            actionSelect.addEventListener('change', (e) => {
                const urlField = document.getElementById('voiceUrlField');
                urlField.style.display = e.target.value === 'navigate' ? 'block' : 'none';
            });
        }

        const saveCommandBtn = document.getElementById('saveVoiceCommandBtn');
        if (saveCommandBtn) {
            saveCommandBtn.addEventListener('click', () => this.saveCustomCommand());
        }

        // Auto-save on changes
        ['voiceCommandsEnabled', 'ttsEnabled', 'autoListen', 'voiceSpeed'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', () => this.savePreferences());
            }
        });
    }

    async loadPreferences() {
        try {
            const response = await fetch(`${this.apiBase}preferences/`);
            const data = await response.json();
            
            if (data.success) {
                const prefs = data.preferences;
                
                // Vérifier que les éléments existent avant de les modifier
                const voiceCommandsEnabledEl = document.getElementById('voiceCommandsEnabled');
                const ttsEnabledEl = document.getElementById('ttsEnabled');
                const autoListenEl = document.getElementById('autoListen');
                const voiceSpeedEl = document.getElementById('voiceSpeed');
                const micSensitivityEl = document.getElementById('micSensitivity');
                const sensitivityValueEl = document.getElementById('sensitivityValue');
                
                if (voiceCommandsEnabledEl) voiceCommandsEnabledEl.checked = prefs.voice_commands_enabled;
                if (ttsEnabledEl) ttsEnabledEl.checked = prefs.tts_enabled;
                if (autoListenEl) autoListenEl.checked = prefs.auto_listen;
                if (voiceSpeedEl) voiceSpeedEl.value = prefs.preferred_voice_speed;
                if (micSensitivityEl) micSensitivityEl.value = prefs.sensitivity || 70;
                if (sensitivityValueEl) sensitivityValueEl.textContent = (prefs.sensitivity || 70) + '%';
            }
        } catch (error) {
            console.error('Error loading voice preferences:', error);
        }
    }

    async loadCommands() {
        try {
            const response = await fetch(`${this.apiBase}commands/`);
            const data = await response.json();
            
            if (data.success) {
                this.displayCommands(data.commands);
            } else {
                console.warn('Failed to load voice commands:', data.error);
            }
        } catch (error) {
            console.error('Error loading voice commands:', error);
            // Afficher un message d'erreur dans l'interface
            const container = document.getElementById('voiceCommandsContainer');
            if (container) {
                container.innerHTML = `
                    <div class="col-12 text-center text-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <p>Erreur lors du chargement des commandes</p>
                    </div>
                `;
            }
        }
    }

    displayCommands(commands) {
        const container = document.getElementById('voiceCommandsContainer');
        if (!container) return;

        container.innerHTML = '';
        
        Object.entries(commands).forEach(([category, commandList]) => {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'col-md-6 mb-3';
            
            // Traduire les noms de catégories
            const categoryTranslations = {
                'navigation': 'Navigation',
                'learning': 'Apprentissage',
                'voice_control': 'Contrôles vocaux',
                'help': 'Aide'
            };
            
            const categoryName = categoryTranslations[category] || category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            categoryDiv.innerHTML = `
                <h6 class="text-uppercase text-muted mb-2 fw-bold">${categoryName}</h6>
                ${commandList.map(cmd => `
                    <div class="border rounded p-2 mb-2 bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <code class="text-primary fw-bold">"${cmd.command}"</code>
                                <br><small class="text-muted">${cmd.description}</small>
                            </div>
                            <i class="bi bi-mic text-success fs-5"></i>
                        </div>
                    </div>
                `).join('')}
            `;
            
            container.appendChild(categoryDiv);
        });
    }

    async savePreferences() {
        const preferences = {
            voice_commands_enabled: document.getElementById('voiceCommandsEnabled').checked,
            tts_enabled: document.getElementById('ttsEnabled').checked,
            auto_listen: document.getElementById('autoListen').checked,
            preferred_voice_speed: document.getElementById('voiceSpeed').value,
            sensitivity: parseInt(document.getElementById('micSensitivity').value)
        };
        
        try {
            const response = await fetch(`${this.apiBase}preferences/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify(preferences)
            });
            
            const data = await response.json();
            if (data.success) {
                this.showMessage('Paramètres vocaux sauvegardés !', 'success');
            }
        } catch (error) {
            console.error('Error saving voice preferences:', error);
            this.showMessage('Erreur lors de la sauvegarde', 'error');
        }
    }

    async saveCustomCommand() {
        const triggerPhrase = document.getElementById('voiceTriggerPhrase').value;
        const actionType = document.getElementById('voiceActionType').value;
        const responseText = document.getElementById('voiceResponseText').value;
        const targetUrl = document.getElementById('voiceTargetUrl').value;
        
        if (!triggerPhrase || !actionType || !responseText) {
            this.showMessage('Veuillez remplir tous les champs requis', 'error');
            return;
        }
        
        const params = {};
        if (actionType === 'navigate' && targetUrl) {
            params.url = targetUrl;
        }
        
        try {
            const response = await fetch(`${this.apiBase}learn-command/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    trigger_phrase: triggerPhrase,
                    action: actionType,
                    params: params,
                    response: responseText
                })
            });
            
            const data = await response.json();
            if (data.success) {
                this.showMessage('Commande ajoutée avec succès !', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addVoiceCommandModal')).hide();
                document.getElementById('addVoiceCommandForm').reset();
                this.loadCustomCommands();
            } else {
                this.showMessage(data.error || 'Erreur lors de l\'ajout', 'error');
            }
        } catch (error) {
            console.error('Error adding command:', error);
            this.showMessage('Erreur lors de l\'ajout de la commande', 'error');
        }
    }

    async loadCustomCommands() {
        try {
            const response = await fetch(`${this.apiBase}user-commands/`);
            const data = await response.json();
            
            if (data.success) {
                this.displayCustomCommands(data.commands);
            }
        } catch (error) {
            console.error('Error loading custom commands:', error);
        }
    }

    displayCustomCommands(commands) {
        const container = document.getElementById('customVoiceCommandsContainer');
        if (!container) return;

        if (commands.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted">
                    <i class="bi bi-mic-mute" style="font-size: 2rem; opacity: 0.5;"></i>
                    <p>Aucune commande personnalisée</p>
                </div>
            `;
            return;
        }

        container.innerHTML = commands.map(cmd => `
            <div class="border rounded p-3 mb-2 bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>"${cmd.trigger_phrase}"</strong>
                        <br><small class="text-muted">${cmd.action_type} - Utilisée ${cmd.usage_count} fois</small>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" onclick="voiceTabManager.deleteCustomCommand('${cmd.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    async deleteCustomCommand(commandId) {
        if (!confirm('Supprimer cette commande personnalisée ?')) return;

        try {
            const response = await fetch(`${this.apiBase}user-commands/${commandId}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': this.getCSRFToken() }
            });
            
            const data = await response.json();
            if (data.success) {
                this.showMessage('Commande supprimée !', 'success');
                this.loadCustomCommands();
            }
        } catch (error) {
            console.error('Error deleting command:', error);
            this.showMessage('Erreur lors de la suppression', 'error');
        }
    }

    getCSRFToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') return value;
        }
        return '';
    }

    showMessage(message, type) {
        // Utilise la fonction showMessage existante de settings.html
        if (typeof window.showMessage === 'function') {
            window.showMessage(message, type);
        } else {
            console.log(`[Voice] ${type.toUpperCase()}: ${message}`);
            
            // Créer une notification temporaire si aucun système n'existe
            this.createTemporaryNotification(message, type);
        }
    }
    
    createTemporaryNotification(message, type) {
        // Créer une notification Bootstrap temporaire
        const alertClass = {
            'success': 'alert-success',
            'error': 'alert-danger',
            'warning': 'alert-warning',
            'info': 'alert-info'
        }[type] || 'alert-info';
        
        const alert = document.createElement('div');
        alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alert);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alert.parentNode) {
                alert.parentNode.removeChild(alert);
            }
        }, 5000);
    }
}

// Make it globally accessible for button callbacks
window.voiceTabManager = null;
</script>
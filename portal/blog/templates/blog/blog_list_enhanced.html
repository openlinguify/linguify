{% extends 'blog/base.html' %}
{% load i18n %}
{% load static %}

{% block title %}OpenLinguify Blog - {% trans "Language Learning Tips & Updates" %}{% endblock %}

{% block meta_description %}OpenLinguify Blog - {% trans "Language learning tips, AI insights, and platform updates" %}{% endblock %}

{% block extra_css %}
{{ block.super }}
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="blog-container">

    <div class="container-fluid">
        <div class="blog-content-wrapper">
            <!-- Sticky Sidebar -->
            <div class="blog-sidebar">
                <!-- Search -->
                <div class="blog-search">
                    <i class="fas fa-search search-icon"></i>
                    <form method="get" id="searchForm">
                        <input type="text" name="search" class="form-control" 
                               placeholder="Search articles..." 
                               value="{{ request.GET.search }}">
                    </form>
                </div>

                <!-- Main Filters -->
                <div class="sidebar-section">
                    <h6><i class="fas fa-filter"></i>Filters</h6>
                    <a href="{% url 'blog:list' %}" class="sidebar-filter {% if not request.GET.category and not request.GET.tag %}active{% endif %}">
                        <span><i class="fas fa-list"></i>All Articles</span>
                        <span class="filter-count">{{ total_posts|default:0 }}</span>
                    </a>
                    <a href="?featured=1" class="sidebar-filter">
                        <span><i class="fas fa-star"></i>Popular Articles</span>
                        <span class="filter-count">{{ featured_count|default:0 }}</span>
                    </a>
                    <a href="?recent=1" class="sidebar-filter">
                        <span><i class="fas fa-clock"></i>Recent Articles</span>
                        <span class="filter-count">{{ recent_count|default:0 }}</span>
                    </a>
                    <a href="?commented=1" class="sidebar-filter">
                        <span><i class="fas fa-comments"></i>Most Commented</span>
                        <span class="filter-count">{{ commented_count|default:0 }}</span>
                    </a>
                </div>

                <!-- Categories -->
                <div class="sidebar-section">
                    <h6><i class="fas fa-folder"></i>Categories</h6>
                    {% for category in categories %}
                        <a href="?category={{ category.slug }}" 
                           class="sidebar-filter {% if request.GET.category == category.slug %}active{% endif %}">
                            <span><i class="fas fa-folder-open"></i>{{ category.name }}</span>
                            <span class="filter-count">{{ category.posts_count|default:0 }}</span>
                        </a>
                    {% empty %}
                        <p class="text-muted small">No categories available</p>
                    {% endfor %}
                </div>

                <!-- Popular Tags -->
                <div class="sidebar-section">
                    <h6><i class="fas fa-tags"></i>Popular Tags</h6>
                    <div class="tag-cloud">
                        {% for tag in popular_tags %}
                            <a href="?tag={{ tag.slug }}" class="badge">
                                {{ tag.name }}
                            </a>
                        {% empty %}
                            <p class="text-muted small">No tags available</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Statistics -->
                <div class="sidebar-section">
                    <h6><i class="fas fa-chart-bar"></i>Statistics</h6>
                    <div class="sidebar-filter">
                        <span><i class="fas fa-file-alt"></i>Total Articles</span>
                        <span class="filter-count">{{ total_posts|default:0 }}</span>
                    </div>
                    <div class="sidebar-filter">
                        <span><i class="fas fa-eye"></i>Total Views</span>
                        <span class="filter-count">{{ total_views|default:0 }}</span>
                    </div>
                    <div class="sidebar-filter">
                        <span><i class="fas fa-comment"></i>Total Comments</span>
                        <span class="filter-count">{{ total_comments|default:0 }}</span>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content-with-sidebar">
            <!-- Controls -->
            <div class="blog-controls">
                <div class="results-info">
                    <i class="fas fa-info-circle me-1"></i>
                    {% with count=posts.paginator.count %}
                        {% if count == 1 %}
                            {{ count }} article found
                        {% else %}
                            {{ count }} articles found
                        {% endif %}
                    {% endwith %}
                </div>
                
                <div class="sort-controls">
                    <span class="text-muted small me-2">Sort by:</span>
                    <a href="?sort=newest" class="sort-btn {% if request.GET.sort == 'newest' or not request.GET.sort %}active{% endif %}">
                        <i class="fas fa-clock"></i>Newest
                    </a>
                    <a href="?sort=popular" class="sort-btn {% if request.GET.sort == 'popular' %}active{% endif %}">
                        <i class="fas fa-fire"></i>Popular
                    </a>
                    <a href="?sort=comments" class="sort-btn {% if request.GET.sort == 'comments' %}active{% endif %}">
                        <i class="fas fa-comments"></i>Most Commented
                    </a>
                </div>
            </div>

            <!-- Articles List -->
            <div class="posts-container">
                {% for post in posts %}
                    <article class="post-card">
                        <h2 class="post-title">
                            <a href="{{ post.get_absolute_url }}">{{ post.title }}</a>
                        </h2>
                        
                        <p class="post-excerpt">{{ post.excerpt|default:post.content|truncatewords:30 }}</p>
                        
                        <div class="post-meta-enhanced">
                            <div class="post-meta-left">
                                <div class="author-info">
                                    <div class="author-avatar">
                                        {{ post.author.get_full_name|default:post.author.username|first|upper }}
                                    </div>
                                    <span class="author-name">{{ post.author.get_full_name|default:post.author.username }}</span>
                                </div>
                                
                                <div class="post-meta-item date">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>{{ post.published_at|timesince }}</span>
                                </div>
                                
                                <div class="post-meta-item views">
                                    <i class="fas fa-eye"></i>
                                    <span>{{ post.view_count|default:0 }} views</span>
                                </div>
                                
                                <div class="post-meta-item comments">
                                    <i class="fas fa-comment"></i>
                                    <span>{{ post.comments_count|default:0 }} comments</span>
                                </div>
                            </div>
                            
                            <div class="post-tags">
                                {% for tag in post.tags.all|slice:":3" %}
                                    <a href="?tag={{ tag.slug }}" class="post-tag">{{ tag.name }}</a>
                                {% endfor %}
                            </div>
                        </div>
                    </article>
                {% empty %}
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h3 class="text-muted">No articles found</h3>
                        <p class="text-muted">Try modifying your search criteria</p>
                        <a href="{% url 'blog:list' %}" class="btn btn-primary">
                            <i class="fas fa-home me-2"></i>View all articles
                        </a>
                    </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if posts.has_other_pages %}
                <div class="pagination-container">
                    <nav aria-label="Page navigation">
                        <ul class="pagination">
                            {% if posts.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ posts.previous_page_number }}">
                                        <i class="fas fa-chevron-left me-1"></i>Previous
                                    </a>
                                </li>
                            {% endif %}
                            
                            {% for num in posts.paginator.page_range %}
                                {% if posts.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > posts.number|add:'-3' and num < posts.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if posts.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ posts.next_page_number }}">
                                        Next<i class="fas fa-chevron-right ms-1"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced search functionality
document.getElementById('searchForm').addEventListener('submit', function(e) {
    const searchInput = this.querySelector('input[name="search"]');
    if (!searchInput.value.trim()) {
        e.preventDefault();
        searchInput.focus();
    }
});

// Auto-search with debounce
let searchTimeout;
document.querySelector('input[name="search"]').addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        if (e.target.value.length >= 3 || e.target.value.length === 0) {
            e.target.form.submit();
        }
    }, 500);
});

// Smooth scroll for tags
document.querySelectorAll('.post-tag, .tag-cloud .badge').forEach(tag => {
    tag.addEventListener('click', function(e) {
        // Add loading state
        this.style.opacity = '0.6';
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + this.textContent;
    });
});

// Full height sidebar - no adjustment needed since it takes 100vh
</script>
{% endblock %}